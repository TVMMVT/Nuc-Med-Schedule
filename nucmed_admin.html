<!DOCTYPE html>
<!--
  NucMed Scheduling System
  ¬© 2026 Thomas ModicaAmore. All Rights Reserved.
  Unauthorized copying, distribution, or use of this software
  is strictly prohibited without written permission.
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NucMed Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:#0a0e14;--surface:#131920;--surface2:#1a2332;--surface3:#1f2d40;--border:#263040;--border2:#2d3a4a;
  --accent:#00d4aa;--adim:rgba(0,212,170,0.12);--aborder:rgba(0,212,170,0.3);
  --pet:#7c6ff7;--general:#10b981;--thera:#f59e0b;--support:#ec4899;
  --text:#dce8f5;--text2:#7a90a8;--text3:#4a5a6a;--pto:#f97316;--danger:#f85149;--success:#3fb950;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
.login-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:40px;width:100%;max-width:400px;text-align:center;}
.login-logo{font-family:'Space Mono',monospace;font-size:28px;font-weight:700;color:var(--accent);margin-bottom:8px;}
.login-sub{font-size:13px;color:var(--text2);margin-bottom:32px;}
.login-badge{display:inline-block;font-size:11px;font-weight:600;background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3);padding:3px 10px;border-radius:20px;margin-bottom:24px;}
.fi{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.15s;margin-bottom:12px;}
.fi:focus{border-color:var(--accent);}
.btn-login{width:100%;background:var(--accent);color:#000;border:none;border-radius:10px;padding:13px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity 0.15s;margin-top:4px;}
.btn-login:hover{opacity:0.85;}
.login-err{font-size:12px;color:var(--danger);margin-top:12px;display:none;}
.app-wrap{display:none;}
header{background:rgba(10,14,20,0.97);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;gap:20px;height:58px;position:sticky;top:0;z-index:200;}
.logo{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);letter-spacing:0.06em;}
.admin-badge{font-size:10px;font-weight:700;background:rgba(248,81,73,0.15);color:var(--danger);border:1px solid rgba(248,81,73,0.3);padding:2px 8px;border-radius:20px;letter-spacing:0.06em;}
nav{display:flex;gap:2px;flex:1;}
.nav-btn{background:none;border:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;padding:7px 16px;border-radius:8px;cursor:pointer;transition:all 0.15s;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:var(--surface2);color:var(--accent);}
.nav-btn.gen-nav{color:var(--accent);border:1px solid var(--aborder);}
.nav-btn.gen-nav.active{background:var(--adim);}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:12px;color:var(--text2);}
.btn-signout{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;transition:color 0.15s;}
.btn-signout:hover{color:var(--danger);}
main{padding:28px;max-width:1440px;margin:0 auto;}
.page{display:none;animation:fi 0.2s ease;}.page.active{display:block;}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;gap:16px;flex-wrap:wrap;}
.page-title{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;}
.page-sub{font-size:13px;color:var(--text2);margin-top:4px;}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.fsel,.si{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.si{width:210px;}.si:focus,.fsel:focus{border-color:var(--accent);}
.btn{border:none;border-radius:8px;padding:8px 18px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.btn-p{background:var(--accent);color:#000;}.btn-p:hover{opacity:0.85;}
.btn-g{background:var(--surface2);color:var(--text);border:1px solid var(--border);}.btn-g:hover{border-color:var(--accent);color:var(--accent);}
.btn-d{background:rgba(248,81,73,0.12);color:var(--danger);border:1px solid rgba(248,81,73,0.3);}.btn-d:hover{background:rgba(248,81,73,0.22);}
.btn-warn{background:rgba(245,158,11,0.12);color:var(--thera);border:1px solid rgba(245,158,11,0.3);}
.btn-icon{padding:6px 10px;font-size:14px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:6px;cursor:pointer;transition:all 0.15s;}
.btn-icon:hover{color:var(--accent);border-color:var(--accent);}
.dept-pill{display:inline-block;font-size:11px;font-weight:600;padding:2px 9px;border-radius:20px;text-transform:uppercase;}
.dp-PET{background:rgba(124,111,247,0.15);color:#9d93ff;border:1px solid rgba(124,111,247,0.3);}
.dp-General{background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);}
.dp-Theranostics{background:rgba(245,158,11,0.15);color:#fbbf24;border:1px solid rgba(245,158,11,0.3);}
.dp-Support{background:rgba(236,72,153,0.15);color:#f472b6;border:1px solid rgba(236,72,153,0.3);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;}
.card-title{font-size:13px;font-weight:600;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}@media(max-width:600px){.g2,.g4{grid-template-columns:1fr}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc-pet::after{background:var(--pet)}.sc-gen::after{background:var(--general)}.sc-thera::after{background:var(--thera)}.sc-sup::after{background:var(--support)}
.stat-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;}
.stat-val{font-family:'Space Mono',monospace;font-size:34px;font-weight:700;margin:8px 0 4px;}
.stat-sub{font-size:12px;color:var(--text2);}
.dt{width:100%;border-collapse:collapse;}
.dt th{background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);}
.dt td{padding:10px 16px;border-bottom:1px solid rgba(38,48,64,0.6);font-size:13px;vertical-align:middle;}
.dt tr:last-child td{border-bottom:none;}
.dt tbody tr:hover td{background:rgba(255,255,255,0.015);}
.ea{display:flex;gap:6px;opacity:0;transition:opacity 0.15s;}
.dt tbody tr:hover .ea{opacity:1;}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:500;white-space:nowrap;}
.av{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#fff;flex-shrink:0;}
.avl{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.sb{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);background:rgba(0,212,170,0.08);padding:2px 8px;border-radius:4px;border:1px solid rgba(0,212,170,0.2);white-space:nowrap;}
.rb{font-size:11px;font-weight:600;color:var(--text2);background:var(--bg);border:1px solid var(--border);padding:2px 8px;border-radius:4px;white-space:nowrap;}
.ib{font-size:11px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:3px 9px;border-radius:20px;}
.ib-g{background:rgba(16,185,129,0.1);color:#34d399;border-color:rgba(16,185,129,0.3);}
.ib-a{background:rgba(245,158,11,0.1);color:#fbbf24;border-color:rgba(245,158,11,0.3);}
.ib-r{background:rgba(248,81,73,0.1);color:var(--danger);border-color:rgba(248,81,73,0.3);}
.sd{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text3);display:flex;align-items:center;gap:12px;margin:24px 0 14px;}
.sd::after{content:'';flex:1;height:1px;background:var(--border);}
.mg{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:20px;}
.mc{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.mch{background:var(--surface2);padding:12px 16px;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;letter-spacing:0.12em;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.cg{display:grid;grid-template-columns:repeat(7,1fr);}
.cdh{text-align:center;font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;padding:7px 2px 5px;background:var(--surface2);}
.cd{text-align:center;padding:5px 2px;border:1px solid rgba(38,48,64,0.4);min-height:48px;cursor:pointer;transition:background 0.1s;}
.cd:not(.we):hover{background:var(--surface3);}
.cd.hp{background:rgba(249,115,22,0.06);}
.dn{font-family:'Space Mono',monospace;font-size:10px;color:var(--text2);display:block;}
.cd.we .dn{color:var(--text3);}
.pt{display:flex;flex-wrap:wrap;gap:1px;justify-content:center;margin-top:2px;}
.ptag{font-size:7px;font-weight:700;background:rgba(249,115,22,0.2);color:var(--pto);border:1px solid rgba(249,115,22,0.3);padding:1px 3px;border-radius:2px;cursor:pointer;}
.ptag:hover{background:rgba(249,115,22,0.4);}
.add-hint{font-size:8px;color:var(--text3);margin-top:2px;display:none;}
.cd:not(.we):hover .add-hint{display:block;}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:16px;}
.sc2{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;gap:14px;align-items:flex-start;transition:border-color 0.15s;position:relative;}
.sc2:hover{border-color:var(--aborder);}
.sca{position:absolute;top:12px;right:12px;display:flex;gap:6px;opacity:0;transition:opacity 0.15s;}
.sc2:hover .sca{opacity:1;}
.sn{font-size:14px;font-weight:600;}
.sm{font-size:11px;color:var(--text2);margin:4px 0 8px;line-height:1.5;}
.sq{display:flex;gap:6px;flex-wrap:wrap;}
.sp{margin-top:8px;font-size:11px;color:var(--text2);}
.spl{font-size:10px;font-weight:600;color:var(--pto);text-transform:uppercase;letter-spacing:0.08em;}

/* GENERATOR STYLES */
.gen-setup{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;margin-bottom:24px;}
.gen-setup-title{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);margin-bottom:20px;}
.week-picker{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;}
.draft-banner{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px;flex-wrap:wrap;}
.draft-banner-text{font-size:13px;color:var(--thera);font-weight:600;}
.draft-banner-sub{font-size:12px;color:var(--text2);margin-top:2px;}
.alert-row{background:rgba(248,81,73,0.06);border:1px solid rgba(248,81,73,0.2);border-radius:8px;padding:10px 16px;display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px;color:var(--danger);}
.gen-day-section{margin-bottom:20px;}
.gen-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.gen-day-title{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;}
.sched-grid{width:100%;border-collapse:collapse;min-width:860px;}
.sched-grid th{background:var(--surface2);padding:10px 14px;text-align:left;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.07em;border-bottom:2px solid var(--border);white-space:nowrap;}
.sched-grid th.day-th{color:var(--accent);font-family:'Space Mono',monospace;font-size:10px;text-align:center;min-width:155px;}
.sched-grid td{padding:7px 12px;border-bottom:1px solid rgba(38,48,64,0.45);vertical-align:middle;}
.sched-grid tbody tr:last-child td{border-bottom:none;}
.sched-grid tbody tr:hover td{background:rgba(255,255,255,0.012);}
.sched-grid .section-row td{background:var(--surface2);padding:5px 14px;}
.sched-grid .section-row td span{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);}
.room-cell{display:flex;flex-direction:column;gap:2px;}
.room-cell-name{font-size:12px;font-weight:600;color:var(--text);}
.room-cell-shift{font-family:'Space Mono',monospace;font-size:9px;color:var(--accent);}
.grid-sel{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:11px;outline:none;cursor:pointer;}
.grid-sel:focus{border-color:var(--accent);}
.grid-sel.unfilled{border-color:var(--danger);color:var(--danger);}
.manual-tag{font-size:10px;font-weight:600;background:rgba(236,72,153,0.1);color:#f472b6;border:1px solid rgba(236,72,153,0.3);padding:2px 7px;border-radius:20px;}
.sched-grid .pto-row td{background:rgba(248,81,73,0.04);}
.sched-grid .section-row.pto-section td{background:rgba(248,81,73,0.08);}
.sched-grid .section-row.pto-section td span{color:var(--danger);}
.grid-sel.double-booked{border-color:#f97316 !important;background:rgba(249,115,22,0.12) !important;color:#fb923c !important;animation:pulse-orange 1s ease 3;}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 0 0 rgba(249,115,22,0.4)}50%{box-shadow:0 0 0 4px rgba(249,115,22,0.2)}}
.dupe-warning{position:fixed;bottom:70px;right:24px;background:#1c1a14;border:1px solid #f97316;border-radius:10px;padding:10px 16px;font-size:12px;color:#fb923c;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;max-width:320px;}
.dupe-warning.show{transform:translateY(0);opacity:1;}
.gen-grid-wrap{overflow-x:auto;}

/* CALENDAR PICKER */
.cal-wrap{position:relative;display:inline-block;}
.cal-trigger{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;color:var(--text);font-family:"DM Sans",sans-serif;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:10px;min-width:260px;transition:border-color 0.15s;user-select:none;}
.cal-trigger:hover,.cal-trigger.open{border-color:var(--accent);}
.cal-trigger-text{flex:1;}
.cal-trigger-arrow{color:var(--text3);font-size:11px;transition:transform 0.15s;}
.cal-trigger.open .cal-trigger-arrow{transform:rotate(180deg);}
.cal-dropdown{position:absolute;top:calc(100% + 8px);left:0;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:20px;z-index:400;width:322px;box-shadow:0 20px 60px rgba(0,0,0,0.6);display:none;}
.cal-dropdown.open{display:block;animation:mi 0.15s ease;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-nav-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:8px;width:34px;height:34px;cursor:pointer;font-size:18px;transition:all 0.15s;display:flex;align-items:center;justify-content:center;line-height:1;}
.cal-nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.cal-month-label{font-family:"Space Mono",monospace;font-size:13px;font-weight:700;color:var(--text);}
.cal-full-grid{display:block;width:100%;}
.cal-dh{text-align:center;font-size:10px;font-weight:700;padding:0 0 10px;text-transform:uppercase;color:var(--text3);letter-spacing:0.06em;min-width:0;}
.cal-dh.hl{color:var(--accent);}
.cal-day{text-align:center;border-radius:8px;font-size:13px;color:var(--text3);height:38px;display:flex;align-items:center;justify-content:center;position:relative;transition:all 0.1s;}
.cal-day.monday{color:var(--text);cursor:pointer;font-weight:700;background:rgba(0,212,170,0.08);outline:1px solid rgba(0,212,170,0.18);}
.cal-day.monday:hover{background:rgba(0,212,170,0.22);outline-color:var(--accent);color:var(--accent);transform:scale(1.06);}
.cal-day.monday.selected{background:var(--accent) !important;color:#000 !important;outline-color:var(--accent);}
.cal-day.is-today:not(.monday){outline:1px solid var(--text3);color:var(--text);}
.cal-day.is-today.monday{outline:2px solid var(--accent);}
.cal-day.has-sched::after{content:"";position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--pet);}
.cal-day.monday.selected::after{background:#000;}
.cal-day.has-block{outline:2px solid #eab308 !important;box-shadow:0 0 0 1px rgba(234,179,8,0.25);}
/* Schedule calendar ‚Äî full week rows selectable */
.sw-week-row{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-radius:6px;overflow:hidden;margin-bottom:3px;cursor:default;width:100%;}
.sw-cal-day{text-align:center;font-size:12px;height:34px;min-width:0;display:flex;align-items:center;justify-content:center;position:relative;color:var(--text3);transition:background 0.1s;}
.sw-week-published{cursor:pointer;}
.sw-week-published .sw-cal-day{color:var(--text);background:rgba(0,212,170,0.07);border-top:1px solid rgba(0,212,170,0.12);border-bottom:1px solid rgba(0,212,170,0.12);}
.sw-week-published .sw-cal-day:first-child{border-left:1px solid rgba(0,212,170,0.12);border-radius:6px 0 0 6px;}
.sw-week-published .sw-cal-day:last-child{border-right:1px solid rgba(0,212,170,0.12);border-radius:0 6px 6px 0;}
.sw-week-published:hover .sw-cal-day{background:rgba(0,212,170,0.18);}
.sw-week-published.sw-week-selected .sw-cal-day{background:var(--accent)!important;color:#000!important;font-weight:700;}
.sw-pub-dot{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--pet);}
.sw-week-selected .sw-pub-dot{background:#000;}
.sw-week-empty{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:3px;width:100%;}
/* Read-only cell styles */
.sw-cell-ro{padding:7px 10px;font-size:12px;color:var(--text);}
.sw-cell-empty{padding:7px 10px;font-size:11px;color:var(--text3);text-align:center;}
.sw-cell-unassigned{padding:7px 10px;font-size:11px;color:var(--danger);text-align:center;background:rgba(248,81,73,0.05);}
.cal-day.monday.has-block:hover{outline:2px solid #facc15 !important;}
.cal-day.selected.has-block{outline:2px solid #eab308 !important;}
.cal-footer{display:flex;align-items:center;gap:14px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);font-size:10px;color:var(--text2);}
.cal-footer-item{display:flex;align-items:center;gap:5px;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.6);animation:mi 0.2s ease;}
@keyframes mi{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal-title{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.modal-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px;line-height:1;}
.modal-close:hover{color:var(--text);}
.fg{margin-bottom:16px;}
.fg label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;}
.mfi{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.mfi:focus{border-color:var(--accent);}
.fr{display:flex;gap:12px;}.fr .fg{flex:1;}
.ma{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(63,185,80,0.4);color:var(--success);}
.toast.err{border-color:rgba(248,81,73,0.4);color:var(--danger);}
.toast.warn{border-color:rgba(245,158,11,0.4);color:var(--thera);}
mark{background:rgba(0,212,170,0.15);color:var(--accent);border-radius:2px;}
/* EQUIPMENT */
.eq-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px;}
.eq-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;position:relative;}
.eq-card.blocked{border-color:rgba(249,115,22,0.4);background:rgba(249,115,22,0.04);}
.eq-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.eq-name{font-size:14px;font-weight:700;}
.eq-dept{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text2);}
.eq-status{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;}
.eq-status.active{color:var(--success);}
.eq-status.blocked{color:#fb923c;}
.eq-blockouts{margin-top:10px;}
.eq-blockout-row{display:flex;align-items:center;justify-content:space-between;background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.2);border-radius:6px;padding:6px 10px;font-size:11px;margin-bottom:6px;}
.eq-blockout-reason{color:#fb923c;font-weight:600;}
.eq-blockout-dates{color:var(--text2);font-family:'Space Mono',monospace;font-size:10px;}
.eq-actions{display:flex;gap:6px;margin-top:12px;}
.btn-sm{border:none;border-radius:6px;padding:5px 12px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.btn-sm-o{background:rgba(249,115,22,0.1);color:#fb923c;border:1px solid rgba(249,115,22,0.3);}
.btn-sm-o:hover{background:rgba(249,115,22,0.2);}
.btn-sm-d{background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3);}
.btn-sm-d:hover{background:rgba(248,81,73,0.2);}
.btn-sm-g{background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.3);}
.btn-sm-g:hover{background:rgba(0,212,170,0.2);}
.section-divider{border:none;border-top:1px solid var(--border);margin:32px 0 24px;}
/* SCHEDULE WEEK VIEW */
.sw-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;position:relative;z-index:1;}
.role-chip{border:1px solid var(--border2);background:var(--surface);color:var(--text2);border-radius:20px;padding:5px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.role-chip[data-role="Chief Technologist"].active{background:rgba(234,179,8,0.15);border-color:#eab308;color:#eab308;}
.role-chip[data-role="Lead Technologist"].active{background:rgba(124,111,247,0.15);border-color:var(--pet);color:var(--pet);}
.day-chip,.qual-chip{border:1px solid var(--border2);background:var(--surface);color:var(--text2);border-radius:20px;padding:5px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.fair-fp{border:1px solid;background:transparent;border-radius:20px;padding:3px 12px;font-size:10px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;letter-spacing:0.04em;transition:all 0.15s;}
.day-chip.active{background:rgba(0,212,170,0.15);border-color:var(--accent);color:var(--accent);}
.qual-chip[data-qual="PET"].active{background:rgba(124,111,247,0.15);border-color:var(--pet);color:var(--pet);}
.qual-chip[data-qual="General"].active{background:rgba(16,185,129,0.15);border-color:var(--general);color:var(--general);}
.qual-chip[data-qual="Theranostics"].active{background:rgba(245,158,11,0.15);border-color:var(--thera);color:var(--thera);}
.qual-chip[data-qual="Support"].active{background:rgba(236,72,153,0.15);border-color:var(--support);color:var(--support);}
.pto-tag{display:inline-flex;align-items:center;gap:4px;background:rgba(249,115,22,0.12);border:1px solid rgba(249,115,22,0.3);color:var(--pto);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600;}
.pto-tag button{background:none;border:none;color:var(--pto);cursor:pointer;padding:0;font-size:12px;line-height:1;}
.st-cal-day{height:28px;display:flex;align-items:center;justify-content:center;font-size:11px;border-radius:4px;cursor:pointer;color:var(--text2);transition:background 0.1s;}
.st-cal-day:hover{background:var(--surface3);}
.st-cal-day.pto-selected{background:rgba(249,115,22,0.2);color:var(--pto);font-weight:700;}
.st-cal-day.we{color:var(--text3);cursor:default;}
.sw-grid{width:100%;border-collapse:collapse;font-size:12px;}
.sw-grid th{background:var(--surface2);border:1px solid var(--border);padding:9px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text2);white-space:nowrap;position:sticky;top:0;z-index:2;}
.sw-grid th.sw-day-col{text-align:center;min-width:155px;}
.sw-grid td{border:1px solid var(--border);padding:0;vertical-align:middle;}
.sw-room-col{background:var(--surface);padding:8px 14px;min-width:145px;position:sticky;left:0;z-index:1;border-right:2px solid var(--border2);}
.sw-room-name{font-weight:700;font-size:12px;}
.sw-room-shift{font-size:10px;color:var(--text2);margin-top:2px;font-family:'Space Mono',monospace;}
.sw-section-hd td{background:var(--surface2);padding:7px 14px;font-weight:700;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;border-bottom:1px solid var(--border2);}
.sw-dept-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;}
.sw-day-hd{text-align:center;}
.sw-day-name{font-size:11px;font-weight:700;color:var(--text);}
.sw-day-date{font-size:10px;color:var(--text2);margin:2px 0;}
.sw-day-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;display:inline-block;margin-top:2px;}
.sw-day-ok{background:rgba(63,185,80,0.1);color:var(--success);}
.sw-day-warn{background:rgba(248,81,73,0.1);color:var(--danger);}
.sw-sel{width:100%;background:transparent;border:none;padding:7px 10px;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:background 0.1s;}
.sw-sel:hover,.sw-sel:focus{background:var(--surface2);}
.sw-sel.unfilled{background:rgba(248,81,73,0.08);color:var(--danger);}
.sw-sel.sw-changed{background:rgba(0,212,170,0.06);border-left:3px solid var(--accent);}
.sw-sel.sw-dupe{border-left:3px solid #f97316 !important;background:rgba(249,115,22,0.1) !important;animation:pulse-orange 1.2s ease-in-out infinite;}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 0 0 rgba(249,115,22,0.4)}50%{box-shadow:0 0 0 4px rgba(249,115,22,0)}}
.sw-sel.double-booked-sw{border-left:3px solid #f97316 !important;background:rgba(249,115,22,0.1) !important;}
.sw-blocked-cell{text-align:center;padding:7px;font-size:10px;font-weight:600;color:#fb923c;background:rgba(249,115,22,0.06);}
.sw-pto-cell{text-align:center;padding:5px;}
.sw-pto-name{display:inline-block;background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.2);border-radius:4px;padding:2px 7px;font-size:10px;color:var(--danger);margin:1px;}
.sw-stat{display:flex;flex-direction:column;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 16px;min-width:100px;}
.sw-stat-val{font-size:20px;font-weight:700;font-family:'Space Mono',monospace;}
.sw-stat-lbl{font-size:10px;color:var(--text2);font-weight:500;margin-top:2px;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-past{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}
.badge-current{background:rgba(0,212,170,0.12);color:var(--accent);border:1px solid rgba(0,212,170,0.3);}
.badge-future{background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3);}
/* BLOCKOUT CALENDAR PICKERS */
.bo-cal-wrap{position:relative;}
.bo-cal-trigger{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;cursor:pointer;font-size:13px;transition:border-color 0.15s;}
.bo-cal-trigger:hover{border-color:var(--accent);}
.bo-cal-trigger-text{flex:1;color:var(--text);}
.bo-cal-dropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:14px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.bo-cal-dropdown.open{display:block;}
.bo-day{position:relative;aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:12px;cursor:default;color:var(--text2);}
.bo-day.selectable{cursor:pointer;color:var(--text);background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);}
.bo-day.selectable:hover{background:rgba(0,212,170,0.18);border-color:var(--accent);}
.bo-day.selected{background:var(--accent)!important;color:#000!important;font-weight:700;border-color:var(--accent)!important;}
.bo-day.in-range{background:rgba(0,212,170,0.12);border-color:rgba(0,212,170,0.2);color:var(--text);}
.bo-day.range-start{background:var(--accent);color:#000;font-weight:700;border-radius:6px 0 0 6px;}
.bo-day.range-end{background:var(--accent);color:#000;font-weight:700;border-radius:0 6px 6px 0;}
.bo-day.monday-only{cursor:pointer;color:var(--text);background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);}
.bo-day.monday-only:hover{background:rgba(0,212,170,0.18);}
.bo-day.today-bo{outline:2px solid var(--accent);outline-offset:1px;}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div class="login-wrap" id="login-wrap">
  <div class="login-box">
    <div class="login-logo">‚ò¢ NUCMED</div>
    <div class="login-sub">Staff Scheduling System</div>
    <div class="login-badge">ADMIN ACCESS</div>
    <input type="email" class="fi" id="login-email" placeholder="Email address" />
    <input type="password" class="fi" id="login-pass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()" />
    <button class="btn-login" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- SET PASSWORD (invite / recovery flow) -->
<div class="login-wrap" id="setpass-wrap" style="display:none">
  <div class="login-box">
    <div class="login-logo">‚ò¢ NUCMED</div>
    <div class="login-sub">Staff Scheduling System</div>
    <div class="login-badge" style="background:rgba(124,111,247,0.15);color:var(--pet);border-color:rgba(124,111,247,0.3)">SET YOUR PASSWORD</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:16px;text-align:center">Welcome! Choose a password to activate your account.</p>
    <input type="password" class="fi" id="setpass-new" placeholder="New password (min 6 chars)" />
    <input type="password" class="fi" id="setpass-confirm" placeholder="Confirm password" onkeydown="if(event.key==='Enter')doSetPassword()" style="margin-top:10px" />
    <button class="btn-login" onclick="doSetPassword()" style="margin-top:14px">Set Password & Sign In</button>
    <div class="login-err" id="setpass-err"></div>
  </div>
</div>

<!-- APP -->
<div class="app-wrap" id="app-wrap">
<header>
  <div class="logo">‚ò¢ NUCMED</div>
  <span class="admin-badge">ADMIN</span>
  <nav>
    <button class="nav-btn active" onclick="goTo('dashboard',this)">Dashboard</button>
    <button class="nav-btn" onclick="goTo('schedule',this)">Schedule</button>
    <button class="nav-btn gen-nav" onclick="goTo('generator',this)">‚ö° Generate Week</button>
    <button class="nav-btn" onclick="goTo('pto',this)">PTO Calendar</button>
    <button class="nav-btn" onclick="goTo('staff',this)">Staff Roster</button>
    <button class="nav-btn" id="admin-swaps-nav" onclick="goTo('swaps',this)">üîÑ Swap Requests</button>
  </nav>
  <div class="user-pill">
    <span id="user-email">‚Äî</span>
    <button class="btn-signout" onclick="doSignOut()">Sign out</button>
  </div>
</header>

<main>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <div><div class="page-title">Admin Dashboard</div><div class="page-sub" id="dash-sub">‚Äî</div></div>
    <button class="btn btn-p" onclick="goTo('generator',document.querySelectorAll('.nav-btn')[2])">‚ö° Generate Next Week</button>
  </div>
  <div class="g4" style="margin-bottom:24px" id="stats"></div>
  <!-- Today + compact PTO -->
  <div class="g2" style="margin-bottom:20px">
    <div class="card">
      <div class="card-header"><div class="card-title" id="today-ttl">Today</div><span class="ib ib-g" id="today-cnt"></span></div>
      <div style="overflow-x:auto"><table class="dt" id="today-tbl"></table></div>
    </div>
    <div class="card" style="max-height:320px;overflow:hidden;display:flex;flex-direction:column">
      <div class="card-header" style="flex-shrink:0"><div class="card-title">Upcoming PTO</div><span class="ib ib-a">30 days</span></div>
      <div style="overflow-y:auto;padding:4px 16px 12px" id="pto-up"></div>
    </div>
  </div>

  <!-- Fairness Chart full width -->
  <div class="card">
    <div class="card-header" style="flex-wrap:wrap;gap:10px">
      <div>
        <div class="card-title">&#9878; Shift Fairness</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px" id="fair-sub"></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-left:auto">
        <div style="display:flex;align-items:center;gap:7px;cursor:pointer;user-select:none" onclick="toggleFairFuture()">
          <div id="fair-tog-track" style="width:34px;height:18px;background:var(--surface2);border:1px solid var(--border2);border-radius:20px;position:relative;transition:all 0.2s;flex-shrink:0"><div id="fair-tog-thumb" style="position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--text3);transition:all 0.2s"></div></div>
          <span id="fair-tog-lbl" style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.04em">Future shifts</span>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap" id="fair-filters"></div>
      </div>
    </div>
    <div style="padding:0 4px 4px">
      <div style="display:flex;flex-wrap:wrap;gap:3px 10px;margin-bottom:14px;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px" id="fair-legend"></div>
      <div id="fair-chart" style="display:flex;flex-direction:column;gap:7px"></div>
      <div id="fair-xrow" style="display:flex;margin-left:110px;padding-right:46px;justify-content:space-between;margin-top:6px;border-top:1px solid var(--border);padding-top:4px"></div>
    </div>
  </div>
</div>
<div id="fair-tip" style="position:fixed;background:#1c2333;border:1px solid var(--border2);border-radius:10px;padding:10px 14px;pointer-events:none;z-index:999;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.8);min-width:210px;font-family:'DM Sans',sans-serif;font-size:11px;color:var(--text2)"></div>

<!-- SCHEDULE -->
<div class="page" id="page-schedule">
  <div class="page-header">
    <div>
      <div class="page-title">Published Schedules</div>
      <div class="page-sub" id="sched-sub">Select a week to view</div>
    </div>
    <div class="controls">
      <span id="sw-week-badge" style="display:none" class="badge"></span>
      <button class="btn" id="sw-edit-btn" style="display:none;background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)" onclick="toggleSwEdit()">‚úè Edit Week</button>
      <button class="btn btn-s" id="sw-delete-btn" style="display:none;background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3)" onclick="deletePublishedWeek()">üóë Delete Week</button>
    </div>
  </div>

  <!-- CALENDAR WEEK PICKER -->
  <div style="margin-bottom:20px">
    <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px">Select Week</label>
    <div class="cal-wrap" id="sw-cal-wrap">
      <div class="cal-trigger" id="sw-cal-trigger" onclick="toggleSwCal()">
        <span>üìÖ</span>
        <span class="cal-trigger-text" id="sw-cal-trigger-text">Pick a published week‚Ä¶</span>
        <span class="cal-trigger-arrow">‚ñº</span>
      </div>
      <div class="cal-dropdown" id="sw-cal-dropdown">
        <div class="cal-nav">
          <button class="cal-nav-btn" onclick="swCalNav(-1)">‚Äπ</button>
          <span class="cal-month-label" id="sw-cal-month-label"></span>
          <button class="cal-nav-btn" onclick="swCalNav(1)">‚Ä∫</button>
        </div>
        <div class="cal-full-grid" id="sw-cal-grid"></div>
        <div class="cal-footer">
          <div class="cal-footer-item"><div style="width:6px;height:6px;border-radius:50%;background:var(--pet)"></div>Published week</div>
          <div class="cal-footer-item"><div style="width:28px;height:12px;border-radius:3px;background:var(--accent);opacity:0.8"></div>Selected</div>
        </div>
      </div>
    </div>
    <input type="hidden" id="sw-week-sel" />
  </div>

  <!-- EDIT MODE BANNER -->
  <div id="sw-edit-banner" style="display:none;align-items:center;gap:12px;background:rgba(124,111,247,0.08);border:1px solid rgba(124,111,247,0.25);border-radius:10px;padding:10px 16px;margin-bottom:16px;font-size:12px;color:var(--pet)">
    ‚úè <strong>Edit Mode</strong> ‚Äî Changes save directly to the published schedule.
    <button class="btn btn-s" style="margin-left:auto;font-size:11px;padding:5px 12px" onclick="toggleSwEdit()">Cancel</button>
  </div>

  <!-- STATS -->
  <div id="sw-stats" style="display:none;gap:10px;flex-wrap:wrap;margin-bottom:20px"></div>

  <!-- GRID -->
  <div id="sched-body"></div>

  <!-- SAVE BAR -->
  <div id="sw-save-bar" style="display:none;position:sticky;bottom:20px;z-index:50;justify-content:flex-end;align-items:center;gap:10px;padding:12px 20px;background:var(--surface);border:1px solid var(--border2);border-radius:14px;margin-top:8px;box-shadow:0 8px 40px rgba(0,0,0,0.6)">
    <span id="sw-change-count" style="font-size:12px;color:var(--text2);flex:1"></span>
    <button class="btn btn-s" id="sw-undo-btn" onclick="undoLastChange()" disabled style="opacity:0.35;cursor:not-allowed;border:1px solid var(--border2)" title="Undo last change">‚Ü© Undo</button>
    <button class="btn btn-s" onclick="discardWeekChanges()" style="color:var(--danger);border-color:rgba(248,81,73,0.3)">‚úï Discard All</button>
    <button class="btn btn-p" onclick="saveWeekChanges()">üíæ Republish Changes</button>
  </div>
</div>

<!-- SWAP APPROVAL PAGE -->
<div class="page" id="page-swaps">
  <div class="page-header">
    <div>
      <div class="page-title">üîÑ Swap Requests</div>
      <div class="page-sub" id="swaps-admin-sub">Loading‚Ä¶</div>
    </div>
    <div class="controls">
      <select class="fsel" id="swaps-admin-filter" onchange="renderAdminSwaps()">
        <option value="all">All Requests</option>
        <option value="pending">Pending Approval</option>
        <option value="open">Open</option>
        <option value="approved">Approved</option>
        <option value="denied">Denied</option>
      </select>
    </div>
  </div>
  <div id="admin-swaps-body"></div>
</div>

<!-- GENERATOR -->
<div class="page" id="page-generator">
  <div class="page-header">
    <div><div class="page-title">‚ö° Schedule Generator</div><div class="page-sub">Generate a draft week, review every slot, then publish live</div></div>
  </div>

  <div class="gen-setup">
    <div class="gen-setup-title">üìÖ Select the week to schedule ‚Äî only Mondays are selectable</div>
    <div class="week-picker">
      <div>
        <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;">Week Starting (Monday)</label>
        <div class="cal-wrap" id="cal-wrap">
          <div class="cal-trigger" id="cal-trigger" onclick="toggleCal()">
            <span>üìÖ</span>
            <span class="cal-trigger-text" id="cal-trigger-text">Pick a Monday‚Ä¶</span>
            <span class="cal-trigger-arrow">‚ñº</span>
          </div>
          <div class="cal-dropdown" id="cal-dropdown">
            <div class="cal-nav">
              <button class="cal-nav-btn" onclick="calNav(-1)">‚Äπ</button>
              <span class="cal-month-label" id="cal-month-label"></span>
              <button class="cal-nav-btn" onclick="calNav(1)">‚Ä∫</button>
            </div>
            <div class="cal-full-grid" id="cal-full-grid"></div>
            <div class="cal-footer">
              <div class="cal-footer-item"><div style="width:12px;height:12px;border-radius:3px;background:rgba(0,212,170,0.12);outline:1px solid rgba(0,212,170,0.3)"></div> Selectable Monday</div>
              <div class="cal-footer-item"><div style="width:6px;height:6px;border-radius:50%;background:var(--pet)"></div> Scheduled</div>
              <div class="cal-footer-item"><div style="width:12px;height:12px;border-radius:3px;outline:2px solid #eab308;background:transparent"></div> Camera blocked</div>
            </div>
          </div>
        </div>
        <input type="hidden" id="gen-week-start" />
      </div>
      <button class="btn btn-p" style="height:42px;align-self:flex-end" onclick="generateDraft()">‚ö° Generate Draft</button>
    </div>

    <!-- Fairness toggle -->
    <div style="margin-top:16px;padding:14px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px">Exclude approved swaps from fairness scoring</div>
        <div style="font-size:11px;color:var(--text2)">When ON ‚Äî swapped shifts don't count against a tech's history. Fairness only applies to originally generated assignments.</div>
      </div>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;flex-shrink:0">
        <div style="position:relative;width:44px;height:24px" onclick="toggleSwapFairness()">
          <input type="checkbox" id="exclude-swaps-toggle" style="opacity:0;position:absolute;width:100%;height:100%;cursor:pointer;margin:0" checked>
          <div id="toggle-track" style="position:absolute;inset:0;border-radius:12px;background:var(--accent);transition:background 0.2s"></div>
          <div id="toggle-thumb" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#000;transition:left 0.2s"></div>
        </div>
        <span id="toggle-label" style="font-size:12px;font-weight:600;color:var(--accent)">ON</span>
      </label>
    </div>
  </div><!-- end gen-setup -->

  <div id="gen-draft-area" style="display:none">
    <div class="draft-banner">
      <div>
        <div class="draft-banner-text">üìã DRAFT ‚Äî Not yet published</div>
        <div class="draft-banner-sub" id="draft-sub">Review all slots, adjust any assignments, then publish</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-warn" onclick="clearDraft()">‚úï Discard</button>
        <button class="btn btn-p" onclick="publishDraft()" id="pub-btn">‚úì Publish Live</button>
      </div>
    </div>
    <div id="gen-alerts"></div>
    <div id="gen-days"></div>
  </div>
</div>

<!-- PTO -->
<div class="page" id="page-pto">
  <div class="page-header">
    <div><div class="page-title">PTO Calendar 2026</div><div class="page-sub">Click any weekday to add/remove PTO</div></div>
    <div class="controls">
      <select class="fsel" id="f-pto-staff" onchange="renderPTO()"><option value="">All Staff</option></select>
      <input class="si" placeholder="Filter by name‚Ä¶" id="f-pto-srch" oninput="renderPTO()" />
    </div>
  </div>
  <div class="mg" id="pto-grid"></div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="page-header">
    <div><div class="page-title">Staff Roster</div><div class="page-sub" id="staff-sub">‚Äî</div></div>
    <div class="controls">
      <select class="fsel" id="f-qual" onchange="renderStaff()">
        <option value="">All Qualifications</option>
        <option>PET</option><option>General</option><option>Theranostics</option>
      </select>
      <input class="si" placeholder="Search staff‚Ä¶" id="f-staff" oninput="renderStaff()" />
      <button class="btn btn-p" onclick="openStaffModal()">+ Add Staff</button>
    </div>
  </div>
  <div class="sg" id="staff-grid"></div>

  <hr class="section-divider" />

  <div class="page-header" style="margin-top:0">
    <div>
      <div class="page-title" style="font-size:18px">üè• Equipment & Cameras</div>
      <div class="page-sub">Manage rooms and block cameras for maintenance or downtime</div>
    </div>
    <button class="btn btn-p" onclick="openEquipModal()">+ Add Equipment</button>
  </div>
  <div class="eq-grid" id="eq-grid"></div>
</div>

</main>
</div>

<!-- EQUIPMENT MODAL -->
<div class="overlay" id="equip-modal">
  <div class="modal">
    <div class="modal-title"><span id="equip-modal-ttl">Add Equipment</span><button class="modal-close" onclick="closeModal('equip-modal')">‚úï</button></div>
    <input type="hidden" id="eq-edit-id" />
    <div class="fr">
      <div class="fg"><label>Name / Room</label><input type="text" class="mfi" id="eq-name" placeholder="e.g. NM1" /></div>
      <div class="fg"><label>Room Code</label><input type="text" class="mfi" id="eq-code" placeholder="e.g. NM1" /></div>
    </div>
    <div class="fg"><label>Department</label>
      <select class="mfi" id="eq-dept">
        <option>PET</option><option>General</option><option>Theranostics</option><option>Support</option>
      </select>
    </div>
    <div class="fg"><label>Notes</label><input type="text" class="mfi" id="eq-notes" placeholder="Optional description" /></div>
    <div class="ma">
      <button class="btn btn-s" onclick="closeModal('equip-modal')">Cancel</button>
      <button class="btn btn-p" onclick="saveEquip()">Save Equipment</button>
    </div>
  </div>
</div>

<!-- BLOCKOUT MODAL -->
<div class="overlay" id="blockout-modal">
  <div class="modal">
    <div class="modal-title"><span id="blockout-modal-ttl">Block Camera</span><button class="modal-close" onclick="closeModal('blockout-modal')">‚úï</button></div>
    <input type="hidden" id="bo-equip-id" />
    <input type="hidden" id="bo-room-code" />
    <div class="fg"><label>Reason for blockout</label>
      <select class="mfi" id="bo-reason">
        <option>Maintenance</option>
        <option>Construction</option>
        <option>Repair</option>
        <option>Calibration</option>
        <option>Inspection</option>
        <option>Other</option>
      </select>
    </div>
    <div class="fg"><label>Block type</label>
      <select class="mfi" id="bo-type" onchange="toggleBlockType()">
        <option value="single">Single day</option>
        <option value="range">Date range</option>
        <option value="week">Whole week</option>
      </select>
    </div>
    <!-- SINGLE DAY PICKER -->
    <div id="bo-single-wrap" class="fg">
      <label>Date</label>
      <div class="bo-cal-wrap" id="bo-single-cal-wrap">
        <div class="bo-cal-trigger" id="bo-single-trigger" onclick="toggleBoCal('single')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-single-text">Select a date‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-single-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('single',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-single-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('single',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-single-grid"></div>
        </div>
      </div>
      <input type="hidden" id="bo-single-date" />
    </div>

    <!-- RANGE PICKER -->
    <div id="bo-range-wrap" style="display:none" class="fg">
      <label>Date Range ‚Äî click start then end date</label>
      <div class="bo-cal-wrap" id="bo-range-cal-wrap">
        <div class="bo-cal-trigger" id="bo-range-trigger" onclick="toggleBoCal('range')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-range-text">Select date range‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-range-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('range',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-range-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('range',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-range-grid"></div>
          <div style="font-size:10px;color:var(--text2);margin-top:8px;text-align:center" id="bo-range-hint">Click a start date</div>
        </div>
      </div>
      <input type="hidden" id="bo-start" />
      <input type="hidden" id="bo-end" />
    </div>

    <!-- WEEK PICKER (Mondays only) -->
    <div id="bo-week-wrap" style="display:none" class="fg">
      <label>Week ‚Äî select a Monday</label>
      <div class="bo-cal-wrap" id="bo-week-cal-wrap">
        <div class="bo-cal-trigger" id="bo-week-trigger" onclick="toggleBoCal('week')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-week-text">Select a Monday‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-week-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('week',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-week-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('week',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-week-grid"></div>
          <div style="font-size:10px;color:var(--text2);margin-top:8px">Only Mondays are selectable ‚Äî blocks Mon‚ÄìFri</div>
        </div>
      </div>
      <input type="hidden" id="bo-week-start" />
    </div>
    <div class="ma">
      <button class="btn btn-s" onclick="closeModal('blockout-modal')">Cancel</button>
      <button class="btn btn-p" style="background:#f97316" onclick="saveBlockout()">üö´ Block Camera</button>
    </div>
  </div>
</div>

<!-- SHIFT MODAL -->
<div class="overlay" id="shift-modal">
  <div class="modal">
    <div class="modal-title"><span id="shift-modal-ttl">Add Shift</span><button class="modal-close" onclick="closeModal('shift-modal')">‚úï</button></div>
    <input type="hidden" id="shift-edit-id" />
    <div class="fg"><label>Date</label><input type="date" class="mfi" id="s-date" /></div>
    <div class="fr">
      <div class="fg"><label>Department</label><select class="mfi" id="s-dept"><option>PET</option><option>General</option><option>Theranostics</option><option>Support</option></select></div>
      <div class="fg"><label>Room</label><select class="mfi" id="s-room"><option>NM1</option><option>NM2</option><option>NM4</option><option>NM6</option><option>NM7</option><option>NM8</option><option>NM9</option><option>Pharmacy</option><option>Wet Work</option><option>Therapy Room</option><option>PET SUPPORT</option></select></div>
    </div>
    <div class="fg"><label>Shift Time</label><select class="mfi" id="s-shift"><option>6:00am-2:30pm</option><option>6:30am-3:00pm</option><option>6:45am-3:15pm</option><option>7:30am-4:00pm</option><option>8:00am-4:30pm</option><option>8:30am-5:00pm</option><option>9:30am-6:00pm</option></select></div>
    <div class="fg"><label>Assigned Tech</label><select class="mfi" id="s-tech"></select></div>
    <div class="fg"><label>Notes (optional)</label><input type="text" class="mfi" id="s-notes" placeholder="Any notes‚Ä¶" /></div>
    <div class="ma"><button class="btn btn-g" onclick="closeModal('shift-modal')">Cancel</button><button class="btn btn-p" onclick="saveShift()">Save Shift</button></div>
  </div>
</div>

<!-- STAFF MODAL -->
<div class="overlay" id="staff-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-title"><span id="staff-modal-ttl">Add Staff Member</span><button class="modal-close" onclick="closeModal('staff-modal')">‚úï</button></div>
    <input type="hidden" id="staff-edit-id" />

    <!-- Name + Initials -->
    <div class="fr">
      <div class="fg"><label>Full Name</label><input type="text" class="mfi" id="st-name" placeholder="Jane Smith (JS)" /></div>
      <div class="fg"><label>Initials</label><input type="text" class="mfi" id="st-init" placeholder="JS" maxlength="4" /></div>
    </div>

    <!-- Role toggle -->
    <div class="fg">
      <label>Role <span style="font-size:10px;color:var(--text2);font-weight:400">(optional)</span></label>
      <input type="hidden" id="st-role" />
      <div style="display:flex;gap:8px;margin-top:4px">
        <button type="button" class="role-chip" data-role="Chief Technologist" onclick="toggleRoleChip(this)">üëë Chief Technologist</button>
        <button type="button" class="role-chip" data-role="Lead Technologist"  onclick="toggleRoleChip(this)">‚≠ê Lead Technologist</button>
      </div>
    </div>

    <!-- Available Days multi-select chips -->
    <div class="fg">
      <label>Available Days</label>
      <input type="hidden" id="st-days" />
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px" id="st-days-chips">
        <button type="button" class="day-chip" data-day="Monday"    onclick="toggleDayChip(this)">Mon</button>
        <button type="button" class="day-chip" data-day="Tuesday"   onclick="toggleDayChip(this)">Tue</button>
        <button type="button" class="day-chip" data-day="Wednesday" onclick="toggleDayChip(this)">Wed</button>
        <button type="button" class="day-chip" data-day="Thursday"  onclick="toggleDayChip(this)">Thu</button>
        <button type="button" class="day-chip" data-day="Friday"    onclick="toggleDayChip(this)">Fri</button>
      </div>
    </div>

    <!-- Qualifications multi-select chips -->
    <div class="fg">
      <label>Qualifications</label>
      <input type="hidden" id="st-quals" />
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px" id="st-quals-chips">
        <button type="button" class="qual-chip" data-qual="PET"          onclick="toggleQualChip(this)">PET</button>
        <button type="button" class="qual-chip" data-qual="General"      onclick="toggleQualChip(this)">General</button>
        <button type="button" class="qual-chip" data-qual="Theranostics" onclick="toggleQualChip(this)">Theranostics</button>
        <button type="button" class="qual-chip" data-qual="Support"      onclick="toggleQualChip(this)">Support</button>
      </div>
    </div>

    <!-- PTO mini calendar -->
    <div class="fg">
      <label>PTO Dates <span style="font-size:10px;color:var(--text2);font-weight:400">(optional ‚Äî click days to add)</span></label>
      <input type="hidden" id="st-pto" />
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:4px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <button type="button" class="cal-nav-btn" onclick="stCalNav(-1)">‚Äπ</button>
          <span id="st-cal-label" style="font-size:12px;font-weight:700;color:var(--text)"></span>
          <button type="button" class="cal-nav-btn" onclick="stCalNav(1)">‚Ä∫</button>
        </div>
        <div id="st-cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;width:100%"></div>
        <div id="st-pto-tags" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;min-height:20px"></div>
      </div>
    </div>

    <div class="ma"><button class="btn btn-g" onclick="closeModal('staff-modal')">Cancel</button><button class="btn btn-p" onclick="saveStaff()">Save</button></div>
  </div>
</div>

<!-- PTO MODAL -->
<div class="overlay" id="pto-modal">
  <div class="modal" style="max-width:400px">
    <div class="modal-title"><span id="pto-modal-ttl">Edit PTO</span><button class="modal-close" onclick="closeModal('pto-modal')">‚úï</button></div>
    <div class="fg"><label>Staff Member</label><select class="mfi" id="pto-staff-sel"></select></div>
    <div class="fg"><label>Action</label><select class="mfi" id="pto-action"><option value="add">Add PTO this day</option><option value="remove">Remove PTO this day</option></select></div>
    <input type="hidden" id="pto-date-val" />
    <div class="ma"><button class="btn btn-g" onclick="closeModal('pto-modal')">Cancel</button><button class="btn btn-p" onclick="savePTO()">Save</button></div>
  </div>
</div>

<script>
const SUPA_URL='https://pkpbeiewrfrmevrokesc.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrcGJlaWV3cmZybWV2cm9rZXNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjM4MTYsImV4cCI6MjA4NzQzOTgxNn0.ZTS48kvRvWr_jqJigleljCQXWc0peTJQl6GIY_wrp68';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);

let STAFF=[],SCHEDULE=[],PTO=[],DRAFT=[],EQUIPMENT=[],BLOCKOUTS=[];

// ============================================================
// SHIFT TEMPLATE ‚Äî the fixed weekly slot structure
// ============================================================
const TEMPLATE=[
  // PET cameras ‚Äî fill first, rotate fairly
  {dept:'PET',room:'NM1',shift:'6:00am-2:30pm',type:'early'},
  {dept:'PET',room:'NM1',shift:'7:30am-4:00pm',type:'mid'},
  {dept:'PET',room:'NM1',shift:'9:30am-6:00pm',type:'late'},
  {dept:'PET',room:'NM7',shift:'6:00am-2:30pm',type:'early'},
  {dept:'PET',room:'NM7',shift:'8:30am-5:00pm',type:'mid'},
  {dept:'PET',room:'NM7',shift:'9:30am-6:00pm',type:'late'},
  {dept:'PET',room:'NM9',shift:'6:00am-2:30pm',type:'early'},
  {dept:'PET',room:'NM9',shift:'8:30am-5:00pm',type:'mid'},
  {dept:'PET',room:'NM9',shift:'9:30am-6:00pm',type:'late'},
  // PET Support ‚Äî auto-filled with Lexi/Natalie/Tyler on days available
  {dept:'Support',room:'PET SUPPORT 1',shift:'',support:true},
  {dept:'Support',room:'PET SUPPORT 2',shift:'',support:true},
  // Theranostics
  {dept:'Theranostics',room:'Therapy Room',shift:'7:30am-4:00pm'},
  // General ‚Äî fill after PET
  {dept:'General',room:'Pharmacy',shift:'6:30am-3:00pm'},
  {dept:'General',room:'Wet Work',shift:'6:45am-3:15pm'},
  {dept:'General',room:'NM2',shift:'8:00am-4:30pm'},
  {dept:'General',room:'NM4',shift:'8:00am-4:30pm'},
  {dept:'General',room:'NM6',shift:'9:30am-6:00pm'},
  {dept:'General',room:'NM8',shift:'7:30am-4:00pm'},
];

const SUPPORT_STAFF=['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'];
const DAY_NAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS={February:{n:2,d:28},March:{n:3,d:31},April:{n:4,d:30},May:{n:5,d:31},June:{n:6,d:30},July:{n:7,d:31},August:{n:8,d:31},September:{n:9,d:30},October:{n:10,d:31},November:{n:11,d:30},December:{n:12,d:31}};
const TC=['#7c6ff7','#10b981','#f59e0b','#ec4899','#3b82f6','#8b5cf6','#ef4444','#06b6d4','#84cc16','#f97316','#14b8a6','#a855f7'];

function tc(n){let h=0;for(const c of n)h=(h*31+c.charCodeAt(0))&0xffffffff;return TC[Math.abs(h)%TC.length];}
function inits(name){const s=STAFF.find(x=>x.name===name);return s?s.initials:(name.match(/\(([^)]+)\)/)||[,'??'])[1];}
function chip(name){if(!name)return`<span style="color:var(--text3);font-size:12px">‚Äî</span>`;return`<span class="chip"><span class="av" style="background:${tc(name)}">${inits(name)}</span>${name}</span>`;}
function dp(dept){return`<span class="dept-pill dp-${dept.replace(/\s/g,'')}">${dept}</span>`;}
function fmtD(iso){return new Date(iso+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});}
function wkDates(){return[...new Set(SCHEDULE.map(s=>s.shift_date))].sort().slice(0,10);}
function closest(ds){const t=new Date().toISOString().split('T')[0];const u=ds.filter(d=>d>=t);return u.length?u[0]:ds[ds.length-1];}
function dowStart(y,m){return new Date(y,m-1,1).getDay();}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// ============================================================
// AUTH
// ============================================================
async function doLogin(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  const err=document.getElementById('login-err');
  err.style.display='none';
  const{error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){err.textContent=error.message;err.style.display='block';}
  else showApp();
}
async function doSignOut(){await sb.auth.signOut();document.getElementById('app-wrap').style.display='none';document.getElementById('login-wrap').style.display='flex';}
async function doSetPassword(){
  const pw=document.getElementById('setpass-new').value;
  const pw2=document.getElementById('setpass-confirm').value;
  const err=document.getElementById('setpass-err');
  err.style.display='none';
  if(pw.length<6){err.textContent='Password must be at least 6 characters.';err.style.display='block';return;}
  if(pw!==pw2){err.textContent='Passwords do not match.';err.style.display='block';return;}
  const{error}=await sb.auth.updateUser({password:pw});
  if(error){err.textContent=error.message;err.style.display='block';return;}
  document.getElementById('setpass-wrap').style.display='none';
  showApp();
}
async function checkSession(){
  // Check URL hash for invite/recovery tokens first
  const hash=window.location.hash;
  if(hash&&hash.includes('access_token')){
    const params=new URLSearchParams(hash.replace(/^#/,''));
    const type=params.get('type');
    const accessToken=params.get('access_token');
    const refreshToken=params.get('refresh_token');
    if((type==='invite'||type==='recovery')&&accessToken){
      // Set the session from the token so updateUser works
      await sb.auth.setSession({access_token:accessToken,refresh_token:refreshToken||''});
      // Clear hash from URL so refresh doesn't re-trigger
      history.replaceState(null,'',window.location.pathname+window.location.search);
      // Show set password screen
      document.getElementById('login-wrap').style.display='none';
      document.getElementById('setpass-wrap').style.display='flex';
      return;
    }
  }
  const{data:{session}}=await sb.auth.getSession();
  if(session)showApp();
}
function showApp(){
  document.getElementById('login-wrap').style.display='none';
  document.getElementById('app-wrap').style.display='block';
  sb.auth.getUser().then(({data:{user}})=>{if(user)document.getElementById('user-email').textContent=user.email;});
  // Default calendar to next Monday's month
  const d=new Date();
  const toMon=(8-d.getDay())%7||7;
  d.setDate(d.getDate()+toMon);
  calYear=d.getFullYear();calMonth=d.getMonth();
  // Pre-select next Monday
  selectMonday(d.toISOString().split('T')[0]);
  loadAll();
  startSwapPolling();
}

// ============================================================
// DATA
// ============================================================
async function loadAll(){
  try{
    const[s1,s2,s3,s4,s5]=await Promise.all([
      sb.from('staff').select('*').order('name'),
      sb.from('schedule').select('*').order('shift_date'),
      sb.from('pto').select('*').order('pto_date'),
      sb.from('equipment').select('*').order('name'),
      sb.from('camera_blockouts').select('*').order('start_date'),
    ]);
    if(s1.error) throw new Error('staff: '+s1.error.message);
    if(s2.error) throw new Error('schedule: '+s2.error.message);
    if(s3.error) throw new Error('pto: '+s3.error.message);
    STAFF=s1.data||[];
    SCHEDULE=s2.data||[];
    PTO=s3.data||[];
    // Equipment and blockouts ‚Äî non-fatal, default to empty if error
    EQUIPMENT=s4.error?[]:s4.data||[];
    BLOCKOUTS=s5.error?[]:s5.data||[];
    if(s4.error) console.warn('Equipment load warning:',s4.error.message);
    if(s5.error) console.warn('Blockouts load warning:',s5.error.message);
    renderAll();
  }catch(e){
    console.error('loadAll error:',e);
    toast('Failed to load data: '+e.message,'err');
  }
}

function renderAll(){
  document.getElementById('f-pto-staff').innerHTML='<option value="">All Staff</option>'+STAFF.map(s=>`<option>${s.name}</option>`).join('');
  try{renderDashboard();}catch(e){console.error('renderDashboard:',e);}
  try{initFairFilters();}catch(e){console.error('initFairFilters:',e);}
  try{renderSchedule();}catch(e){console.error('renderSchedule:',e);}
  try{renderStaff();}catch(e){console.error('renderStaff:',e);}
  try{renderPTO();}catch(e){console.error('renderPTO:',e);}
  try{renderEquipment();}catch(e){console.error('renderEquipment:',e);}
}

function goTo(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  // When switching to schedule tab, refresh grid if week already selected
  if(id==='schedule'&&SW_WEEK) renderWeekGrid();
  if(id==='swaps'){ loadAdminSwaps(); }
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const dates=wkDates();
  if(!dates.length){document.getElementById('dash-sub').textContent='No schedule data yet ‚Äî generate your first week!';return;}
  const todayISO=new Date().toISOString().split('T')[0];
  const today=closest(dates);
  const te=SCHEDULE.filter(s=>s.shift_date===today);

  // Subtitle: show actual today if scheduled, otherwise nearest scheduled day
  const isActuallyToday=today===todayISO;
  const todayLabel=isActuallyToday
    ?`Today ¬∑ ${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}`
    :`Next scheduled day ¬∑ ${fmtD(today)}`;
  document.getElementById('dash-sub').textContent=todayLabel;
  const dc={PET:0,General:0,Theranostics:0,Support:0};
  te.forEach(s=>{if(dc[s.department]!==undefined)dc[s.department]++;});
  const sc=[{k:'PET',c:'sc-pet',col:'#9d93ff',l:'PET'},{k:'General',c:'sc-gen',col:'#34d399',l:'General'},{k:'Theranostics',c:'sc-thera',col:'#fbbf24',l:'Theranostics'},{k:'Support',c:'sc-sup',col:'#f472b6',l:'Support'}];
  const statSubLabel=isActuallyToday?'Today':'Next day';
  document.getElementById('stats').innerHTML=sc.map(x=>`<div class="stat-card ${x.c}"><div class="stat-label">${x.l}</div><div class="stat-val" style="color:${x.col}">${dc[x.k]}</div><div class="stat-sub">${statSubLabel}</div></div>`).join('');
  document.getElementById('today-ttl').textContent=isActuallyToday?`Today's Assignments`:fmtD(today);
  document.getElementById('today-cnt').textContent=`${te.length} shifts`;
  document.getElementById('today-tbl').innerHTML=`<thead><tr><th>Dept</th><th>Room</th><th>Shift</th><th>Tech</th></tr></thead><tbody>${te.map(s=>`<tr><td>${dp(s.department)}</td><td><span class="rb">${s.room}</span></td><td><span class="sb">${s.shift_time}</span></td><td>${chip(s.assigned_tech)}</td></tr>`).join('')}</tbody>`;
  const t=new Date().toISOString().split('T')[0];
  const cut=new Date();cut.setDate(cut.getDate()+30);
  const up=PTO.filter(p=>p.pto_date>=t&&new Date(p.pto_date)<=cut).sort((a,b)=>a.pto_date.localeCompare(b.pto_date));
  const grp={};up.forEach(p=>{if(!grp[p.staff_name])grp[p.staff_name]=[];grp[p.staff_name].push(p.pto_date);});
  document.getElementById('pto-up').innerHTML=Object.entries(grp).slice(0,10).map(([n,ds])=>`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(38,48,64,0.6)">${chip(n)}<span style="font-size:11px;color:var(--text2)">${new Date(ds[0]+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}${ds.length>1?' ‚Äì '+new Date(ds[ds.length-1]+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):''}</span></div>`).join('')||'<div style="font-size:12px;color:var(--text2);padding:8px 0">No upcoming PTO</div>';
  renderFairnessChart();
}

// ============================================================
// FAIRNESS CHART
// ============================================================
const FAIR_COLORS={
  "PET|6:00am-2:30pm":"#4c45b8","PET|7:30am-4:00pm":"#7c6ff7",
  "PET|8:30am-5:00pm":"#a89cf9","PET|9:30am-6:00pm":"#cec8fc",
  "General|6:30am-3:00pm":"#047857","General|6:45am-3:15pm":"#059669",
  "General|7:30am-4:00pm":"#10b981","General|8:00am-4:30pm":"#34d399",
  "General|9:30am-6:00pm":"#6ee7b7",
  "Theranostics|7:30am-4:00pm":"#f59e0b",
  "Support|8:00am-4:30pm":"#ec4899"
};
const FAIR_SHORT={"6:00am-2:30pm":"6a","6:30am-3:00pm":"6:30a","6:45am-3:15pm":"6:45a","7:30am-4:00pm":"7:30a","8:00am-4:30pm":"8a","8:30am-5:00pm":"8:30a","9:30am-6:00pm":"9:30a"};
const FAIR_DPILL={all:["#00d4aa","#000"],PET:["#7c6ff7","#000"],General:["#10b981","#000"],Theranostics:["#f59e0b","#000"],Support:["#ec4899","#000"]};
let fairFilter="all", fairShowFuture=false;
const FAIR_TIP_DATA={};

function fairHatch(key){
  const c=FAIR_COLORS[key]||"#888";
  return `background:repeating-linear-gradient(45deg,${c}55 0px,${c}55 1.5px,transparent 1.5px,transparent 11px)`;
}
function fairIni(n){const m=n.match(/\(([^)]+)\)/);return m?m[1]:n.slice(0,2);}
function fairFirst(n){return n.split(" ")[0];}

function toggleFairFuture(){
  fairShowFuture=!fairShowFuture;
  const track=document.getElementById('fair-tog-track');
  const thumb=document.getElementById('fair-tog-thumb');
  const lbl=document.getElementById('fair-tog-lbl');
  if(fairShowFuture){
    track.style.background='rgba(245,158,11,0.2)';track.style.borderColor='#f59e0b';
    thumb.style.left='18px';thumb.style.background='#f59e0b';
    lbl.style.color='#f59e0b';
  } else {
    track.style.background='var(--surface2)';track.style.borderColor='var(--border2)';
    thumb.style.left='2px';thumb.style.background='var(--text3)';
    lbl.style.color='var(--text3)';
  }
  renderFairnessChart();
}

function setFairFilter(f,btn){
  fairFilter=f;
  document.querySelectorAll('.fair-fp').forEach(b=>{
    const[bg]=FAIR_DPILL[b.dataset.f];
    b.style.background='transparent';b.style.color=bg;b.style.borderColor=bg+'66';
  });
  const[bg,fg]=FAIR_DPILL[f];
  btn.style.background=bg;btn.style.color=fg;btn.style.borderColor=bg;
  renderFairnessChart();
}

function initFairFilters(){
  const fil=document.getElementById('fair-filters');
  if(!fil)return;
  fil.innerHTML=Object.keys(FAIR_DPILL).map(f=>`<button class="fair-fp" data-f="${f}" onclick="setFairFilter('${f}',this)">${f==='all'?'All':f}</button>`).join('');
  document.querySelectorAll('.fair-fp').forEach(b=>{
    const[bg]=FAIR_DPILL[b.dataset.f];b.style.color=bg;b.style.borderColor=bg+'66';
  });
  setFairFilter('all',document.querySelector('.fair-fp[data-f="all"]'));
}

function renderFairnessChart(){
  if(!document.getElementById('fair-chart'))return;
  const todayISO=new Date().toISOString().split('T')[0];

  // Build completed and future from SCHEDULE
  const comp={}, fut={};
  SCHEDULE.forEach(s=>{
    if(!s.assigned_tech||s.assigned_tech==='‚Äî'||s.assigned_tech==='Unassigned')return;
    const k=s.assigned_tech+'||'+s.department+'||'+s.shift_time;
    if(s.completed||s.shift_date<todayISO){
      comp[k]=(comp[k]||0)+1;
    } else {
      fut[k]=(fut[k]||0)+1;
    }
  });

  // Convert to array format
  const toArr=map=>Object.entries(map).map(([k,cnt])=>{
    const[tech,dept,shift]=k.split('||');
    return{tech,dept,shift,cnt};
  });
  const COMP=toArr(comp);
  const FUT=toArr(fut);

  const filt=fairFilter==='all'?null:fairFilter;
  const compData=filt?COMP.filter(r=>r.dept===filt):COMP;
  const futData=fairShowFuture?(filt?FUT.filter(r=>r.dept===filt):FUT):[];

  // Group by tech
  const map={};
  compData.forEach(r=>{
    if(!map[r.tech])map[r.tech]={comp:{},fut:{},compTotal:0,futTotal:0};
    const k=r.dept+'|'+r.shift;
    map[r.tech].comp[k]=(map[r.tech].comp[k]||0)+r.cnt;
    map[r.tech].compTotal+=r.cnt;
  });
  futData.forEach(r=>{
    if(!map[r.tech])map[r.tech]={comp:{},fut:{},compTotal:0,futTotal:0};
    const k=r.dept+'|'+r.shift;
    map[r.tech].fut[k]=(map[r.tech].fut[k]||0)+r.cnt;
    map[r.tech].futTotal+=r.cnt;
  });

  const techs=Object.entries(map).sort((a,b)=>(b[1].compTotal+b[1].futTotal)-(a[1].compTotal+a[1].futTotal));
  if(!techs.length){document.getElementById('fair-chart').innerHTML='<div style="color:var(--text3);font-size:12px;padding:12px">No completed shift data yet</div>';return;}
  const maxTotal=Math.max(...techs.map(([,v])=>v.compTotal+v.futTotal),1);

  // Legend
  const seen=new Set(),legs=[];
  [...compData,...futData].forEach(r=>{const k=r.dept+'|'+r.shift;if(!seen.has(k)){seen.add(k);legs.push({k,dept:r.dept,shift:r.shift});}});
  legs.sort((a,b)=>a.dept.localeCompare(b.dept)||a.shift.localeCompare(b.shift));
  let legHTML=legs.map(l=>`<div style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text3)"><div style="width:8px;height:8px;border-radius:2px;flex-shrink:0;background:${FAIR_COLORS[l.k]||'#888'}"></div><span>${l.dept} ${FAIR_SHORT[l.shift]||l.shift}</span></div>`).join('');
  if(fairShowFuture) legHTML+=`<div style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text3);margin-left:4px"><div style="width:14px;height:8px;border-radius:2px;${fairHatch('PET|9:30am-6:00pm')}"></div><span style="color:var(--text2)">Scheduled</span></div>`;
  document.getElementById('fair-legend').innerHTML=legHTML;

  const compSum=compData.reduce((a,r)=>a+r.cnt,0);
  const futSum=futData.reduce((a,r)=>a+r.cnt,0);
  document.getElementById('fair-sub').textContent=
    (fairFilter==='all'?'All departments':fairFilter)+' ¬∑ '+compSum+' completed'+(fairShowFuture?' + '+futSum+' scheduled':'')+' shifts';

  const step=Math.ceil(maxTotal/4)||1;
  document.getElementById('fair-xrow').innerHTML=[0,step,step*2,step*3,maxTotal].map(t=>`<span style="font-size:9px;color:var(--text3)">${t}</span>`).join('');

  Object.keys(FAIR_TIP_DATA).forEach(k=>delete FAIR_TIP_DATA[k]);

  document.getElementById('fair-chart').innerHTML=techs.map(([name,d],idx)=>{
    const total=d.compTotal+d.futTotal;
    const pct=(total/maxTotal*100).toFixed(2);
    const compPct=(d.compTotal/maxTotal*100).toFixed(2);
    FAIR_TIP_DATA[idx]={name,comp:d.comp,fut:d.fut,compTotal:d.compTotal,futTotal:d.futTotal};

    const compKeys=Object.entries(d.comp).sort((a,b)=>a[0].localeCompare(b[0]));
    const compSegs=compKeys.map(([k,cnt])=>{
      const w=d.compTotal>0?(cnt/d.compTotal*parseFloat(compPct)).toFixed(2):0;
      const show=d.compTotal>0&&cnt/d.compTotal>0.18;
      return `<div style="height:100%;width:${w}%;display:flex;align-items:center;justify-content:center;background:${FAIR_COLORS[k]||'#888'}">${show?`<span style="font-size:8px;font-weight:700;color:rgba(0,0,0,0.5);padding:0 2px">${cnt}</span>`:''}</div>`;
    }).join('');

    let futSegs='';
    if(fairShowFuture&&d.futTotal>0){
      const futPct=(d.futTotal/maxTotal*100).toFixed(2);
      const futKeys=Object.entries(d.fut).sort((a,b)=>a[0].localeCompare(b[0]));
      futSegs='<div style="width:2px;height:100%;background:rgba(255,255,255,0.25);flex-shrink:0"></div>';
      futSegs+=futKeys.map(([k,cnt],i)=>{
        const w=(cnt/d.futTotal*parseFloat(futPct)).toFixed(2);
        const show=cnt/d.futTotal>0.18;
        const div=i>0?'<div style="width:1px;height:100%;background:rgba(255,255,255,0.12);flex-shrink:0"></div>':'';
        return div+`<div style="height:100%;width:${w}%;display:flex;align-items:center;justify-content:center;${fairHatch(k)}">${show?`<span style="font-size:9px;font-weight:800;color:#fff;text-shadow:0 0 4px rgba(0,0,0,0.8);position:relative;z-index:1">${cnt}</span>`:''}</div>`;
      }).join('');
    }

    const totalLabel=fairShowFuture&&d.futTotal>0
      ?`<span style="color:var(--text2)">${d.compTotal}</span><span style="color:#f59e0b;font-size:9px"> +${d.futTotal}</span>`
      :`<span>${d.compTotal}</span>`;

    return `<div style="display:flex;align-items:center;gap:10px">
      <div style="width:100px;flex-shrink:0;text-align:right">
        <div style="font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--accent);line-height:1">${fairIni(name)}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">${fairFirst(name)}</div>
      </div>
      <div style="flex:1;height:24px;background:var(--surface2);border-radius:5px;overflow:hidden;display:flex;cursor:default"
        onmouseenter="showFairTip(event,${idx})" onmouseleave="hideFairTip()" onmousemove="moveFairTip(event)">
        <div style="height:100%;display:flex;width:${pct}%">${compSegs}${futSegs}</div>
      </div>
      <div style="width:36px;flex-shrink:0;font-size:11px;font-weight:700;padding-left:4px">${totalLabel}</div>
    </div>`;
  }).join('');
}

function showFairTip(e,idx){
  const d=FAIR_TIP_DATA[idx];if(!d)return;
  let html=`<div style="font-weight:700;font-size:12px;color:var(--text);border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:7px">${d.name}</div>`;
  if(Object.keys(d.comp).length){
    html+=`<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin:4px 0 3px">‚úì Completed</div>`;
    Object.entries(d.comp).sort().forEach(([k,cnt])=>{
      const[dept,shift]=k.split('|');
      html+=`<div style="display:flex;justify-content:space-between;padding:2px 0"><div style="display:flex;align-items:center;gap:6px"><div style="width:8px;height:8px;border-radius:2px;background:${FAIR_COLORS[k]||'#888'}"></div><span>${dept} ¬∑ ${shift}</span></div><strong style="color:var(--text)">${cnt}</strong></div>`;
    });
  }
  if(fairShowFuture&&Object.keys(d.fut).length){
    html+=`<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#f59e0b;margin:6px 0 3px">‚óà Scheduled</div>`;
    Object.entries(d.fut).sort().forEach(([k,cnt])=>{
      const[dept,shift]=k.split('|');
      html+=`<div style="display:flex;justify-content:space-between;padding:2px 0"><div style="display:flex;align-items:center;gap:6px"><div style="width:8px;height:8px;border-radius:2px;background:${FAIR_COLORS[k]||'#888'};opacity:0.5"></div><span>${dept} ¬∑ ${shift}</span></div><strong style="color:#f59e0b">${cnt}</strong></div>`;
    });
  }
  html+=`<div style="display:flex;justify-content:space-between;font-weight:700;font-size:11px;color:var(--text);border-top:1px solid var(--border);padding-top:6px;margin-top:6px"><span>Total</span><span>${d.compTotal}${d.futTotal?` <span style="color:#f59e0b;font-size:10px">+${d.futTotal}</span>`:''}</span></div>`;
  const tip=document.getElementById('fair-tip');
  tip.innerHTML=html;tip.style.display='block';moveFairTip(e);
}
function moveFairTip(e){
  const t=document.getElementById('fair-tip');
  t.style.left=Math.min(e.clientX+16,window.innerWidth-230)+'px';
  t.style.top=Math.max(e.clientY-10,4)+'px';
}
function hideFairTip(){document.getElementById('fair-tip').style.display='none';}

// ============================================================
// SCHEDULE
// ============================================================
// Track current week ISO and unsaved changes
// SW_WEEK and SW_CHANGES declared in renderSchedule block below

// Schedule tab state
let SW_WEEK=null, SW_CHANGES={}, SW_EDIT=false, SW_UNDO_STACK=[], SW_SUPPORT_SHIFTS={};
let swCalYear=new Date().getFullYear(), swCalMonth=new Date().getMonth();

function renderSchedule(){
  // Build set of published mondays for the calendar
  const mondays=getPublishedMondays();
  const count=mondays.size;
  document.getElementById('sched-sub').textContent=`${SCHEDULE.length} total shifts ¬∑ ${count} published week${count!==1?'s':''}`;
  // If schedule tab is active and we have a selected week, refresh grid
  if(document.getElementById('page-schedule').classList.contains('active')&&SW_WEEK){
    renderWeekGrid();
  }
}

function getPublishedMondays(){
  const mondays=new Set();
  SCHEDULE.forEach(s=>{
    const d=new Date(s.shift_date+'T12:00:00');
    const diff=(d.getDay()+6)%7;
    const mon=new Date(d);mon.setDate(d.getDate()-diff);
    mondays.add(mon.toISOString().split('T')[0]);
  });
  return mondays;
}

// ---- SCHEDULE CALENDAR ----
function toggleSwCal(){
  const dd=document.getElementById('sw-cal-dropdown');
  const tr=document.getElementById('sw-cal-trigger');
  const isOpen=dd.classList.contains('open');
  if(isOpen){dd.classList.remove('open');tr.classList.remove('open');}
  else{dd.classList.add('open');tr.classList.add('open');renderSwCal();}
}

function swCalNav(dir){
  swCalMonth+=dir;
  if(swCalMonth>11){swCalMonth=0;swCalYear++;}
  if(swCalMonth<0){swCalMonth=11;swCalYear--;}
  renderSwCal();
}

function renderSwCal(){
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAY_ABBR=['Su','Mo','Tu','We','Th','Fr','Sa'];
  document.getElementById('sw-cal-month-label').textContent=`${MNAMES[swCalMonth]} ${swCalYear}`;

  const publishedMondays=getPublishedMondays();
  const today=new Date().toISOString().split('T')[0];
  const firstDow=new Date(swCalYear,swCalMonth,1).getDay();
  const daysInMonth=new Date(swCalYear,swCalMonth+1,0).getDate();

  // Day headers
  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;width:100%">`;
  DAY_ABBR.forEach(d=>html+=`<div class="cal-dh">${d}</div>`);
  html+=`</div>`;

  // Build day array with padding
  let days=[];
  for(let i=0;i<firstDow;i++) days.push(null);
  for(let d=1;d<=daysInMonth;d++) days.push(d);
  while(days.length%7!==0) days.push(null);

  html+=`<div>`;
  for(let w=0;w<days.length/7;w++){
    const week=days.slice(w*7,w*7+7);
    // Find Monday (index 1 = Monday in Sun-start grid) ‚Äî use actual day value at col 1
    const monDay=week[1]; // col index 1 is always Monday in a Sun-start calendar
    // But if the row has no real days at all, skip it
    const hasAnyDay=week.some(d=>d!==null);
    if(!hasAnyDay){
      html+=`<div class="sw-week-empty">`;
      week.forEach(()=>html+=`<div class="sw-cal-day"></div>`);
      html+=`</div>`;
      continue;
    }
    // If Monday cell is null this week has no Monday (partial first/last row) ‚Äî render as non-clickable
    if(!monDay){
      html+=`<div class="sw-week-empty">`;
      week.forEach(d=>{
        if(!d){html+=`<div class="sw-cal-day"></div>`;return;}
        const iso=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday=iso===today;
        const todayRing=isToday?'style="background:rgba(0,212,170,0.15);border-radius:6px;"':'';
        html+=`<div class="sw-cal-day" ${todayRing}>${d}</div>`;
      });
      html+=`</div>`;
      continue;
    }
    const monISO=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(monDay).padStart(2,'0')}`;
    const isPublished=publishedMondays.has(monISO);
    const isSelected=SW_WEEK===monISO;
    const weekCls=`sw-week-row${isPublished?' sw-week-published':''}${isSelected?' sw-week-selected':''}`;
    const clickAttr=isPublished?`onclick="selectSwWeek('${monISO}')"`:'' ;

    html+=`<div class="${weekCls}" ${clickAttr}>`;
    week.forEach((d,di)=>{
      if(!d){html+=`<div class="sw-cal-day"></div>`;return;}
      const iso=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isToday=iso===today&&!isSelected;
      const dot=isPublished?`<span class="sw-pub-dot"></span>`:'';
      const todayRing=isToday?'style="background:rgba(0,212,170,0.15);border-radius:6px;"':'';
      html+=`<div class="sw-cal-day" ${todayRing}>${d}${dot}</div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  document.getElementById('sw-cal-grid').innerHTML=html;
}

function selectSwWeek(monISO){
  SW_WEEK=monISO;
  SW_EDIT=false;
  SW_CHANGES={};
  const mon=new Date(monISO+'T12:00:00');
  const fri=new Date(mon);fri.setDate(fri.getDate()+4);
  document.getElementById('sw-cal-trigger-text').textContent=
    `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${fri.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  document.getElementById('sw-cal-dropdown').classList.remove('open');
  document.getElementById('sw-cal-trigger').classList.remove('open');
  document.getElementById('sw-week-sel').value=monISO;

  // Update badge
  const today=new Date().toISOString().split('T')[0];
  const friISO=fri.toISOString().split('T')[0];
  const badge=document.getElementById('sw-week-badge');
  badge.style.display='inline-flex';
  if(today>=monISO&&today<=friISO){badge.className='badge badge-current';badge.textContent='‚óè Current Week';}
  else if(today>friISO){badge.className='badge badge-past';badge.textContent='Past Week';}
  else{badge.className='badge badge-future';badge.textContent='Future Week';}

  document.getElementById('sw-edit-btn').style.display='inline-flex';
  document.getElementById('sw-delete-btn').style.display='inline-flex';
  document.getElementById('sw-edit-banner').style.display='none';
  document.getElementById('sw-save-bar').style.display='none';
  document.getElementById('sw-edit-btn').innerHTML='‚úè Edit Week';
  document.getElementById('sw-edit-btn').style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';

  renderSwCal();
  renderWeekGrid();
}

// Close sw calendar on outside click
document.addEventListener('click',e=>{
  const wrap=document.getElementById('sw-cal-wrap');
  if(wrap&&!wrap.contains(e.target)){
    document.getElementById('sw-cal-dropdown')?.classList.remove('open');
    document.getElementById('sw-cal-trigger')?.classList.remove('open');
  }
});

// ---- EDIT MODE ----
function toggleSwEdit(){
  SW_EDIT=!SW_EDIT;
  SW_CHANGES={};
  SW_UNDO_STACK=[];
  SW_SUPPORT_SHIFTS={};
  const btn=document.getElementById('sw-edit-btn');
  const banner=document.getElementById('sw-edit-banner');
  const saveBar=document.getElementById('sw-save-bar');
  if(SW_EDIT){
    btn.innerHTML='üëÅ View Mode';
    btn.style.cssText='background:rgba(0,212,170,0.12);color:var(--accent);border:1px solid rgba(0,212,170,0.3)';
    banner.style.display='flex';
  } else {
    btn.innerHTML='‚úè Edit Week';
    btn.style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';
    banner.style.display='none';
    saveBar.style.display='none';
  }
  renderWeekGrid();
}

// Called from goTo when switching to schedule tab
function loadWeekView(monISO){
  if(monISO) selectSwWeek(monISO);
  else renderWeekGrid();
}

function stepWeek(dir){
  const sel=document.getElementById('sw-week-sel');
  const idx=sel.selectedIndex;
  const next=idx-dir; // reversed list so -1=newer, +1=older
  if(next>=0&&next<sel.options.length){
    sel.selectedIndex=next;
    loadWeekView(sel.value);
  }
}

function loadWeekView(mondayISO){
  if(!mondayISO) return;
  SW_WEEK=mondayISO;
  SW_CHANGES={};
  document.getElementById('sw-week-sel').value=mondayISO;

  // Badge
  const today=new Date().toISOString().split('T')[0];
  const fri=new Date(mondayISO+'T12:00:00');fri.setDate(fri.getDate()+4);
  const friISO=fri.toISOString().split('T')[0];
  const badge=document.getElementById('sw-week-badge');
  badge.style.display='inline-flex';
  if(today>=mondayISO&&today<=friISO){badge.className='badge badge-current';badge.textContent='‚óè Current Week';}
  else if(today>friISO){badge.className='badge badge-past';badge.textContent='Past Week';}
  else{badge.className='badge badge-future';badge.textContent='Future Week';}

  document.getElementById('sw-delete-btn').style.display='inline-flex';
  document.getElementById('sw-save-bar').style.display='none';
  renderWeekGrid();
}

function renderWeekGrid(){
  if(!SW_WEEK) return;
  const body=document.getElementById('sched-body');
  if(!body) return;
  const weekDates=getWeekDays(SW_WEEK);

  // Stats row
  const weekSlots=SCHEDULE.filter(s=>weekDates.includes(s.shift_date));
  const filled=weekSlots.filter(s=>s.assigned_tech).length;
  const unfilled=weekSlots.filter(s=>!s.assigned_tech).length;
  const onPTO=[...new Set(weekDates.flatMap(d=>PTO.filter(p=>p.pto_date===d).map(p=>p.staff_name)))].length;
  const blocked=BLOCKOUTS.filter(b=>weekDates.some(d=>d>=b.start_date&&d<=b.end_date)).length;
  const stats=document.getElementById('sw-stats');
  if(stats){
    stats.style.display='flex';
    stats.innerHTML=[
      {val:filled,lbl:'Shifts Filled',color:'var(--success)'},
      {val:unfilled,lbl:'Unfilled',color:'var(--danger)'},
      {val:onPTO,lbl:'Staff on PTO',color:'var(--pto)'},
      {val:blocked,lbl:'Cameras Blocked',color:'#eab308'},
    ].map(s=>`<div class="sw-stat"><div class="sw-stat-val" style="color:${s.color}">${s.val}</div><div class="sw-stat-lbl">${s.lbl}</div></div>`).join('');
  }

  // Day headers
  const DAY_ABBR=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let hdrs=`<th style="min-width:148px">ROOM / SHIFT</th>`;
  weekDates.forEach(d=>{
    const dt=new Date(d+'T12:00:00');
    const uf=weekSlots.filter(s=>s.shift_date===d&&!s.assigned_tech).length;
    const badge=uf?`<div class="sw-day-badge sw-day-warn">‚ö† ${uf} Unfilled</div>`:`<div class="sw-day-badge sw-day-ok">‚úì Staffed</div>`;
    hdrs+=`<th class="sw-day-col"><div class="sw-day-hd"><div class="sw-day-name">${DAY_ABBR[dt.getDay()]}</div><div class="sw-day-date">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>${badge}</div></th>`;
  });

  const deptGroups=[
    {label:'PET',color:'var(--pet)',slots:TEMPLATE.filter(t=>t.dept==='PET')},
    {label:'PET Support',color:'var(--support)',slots:TEMPLATE.filter(t=>t.support)},
    {label:'Theranostics',color:'var(--thera)',slots:TEMPLATE.filter(t=>t.dept==='Theranostics')},
    {label:'General',color:'var(--general)',slots:TEMPLATE.filter(t=>t.dept==='General')},
    {label:'PTO / Out',color:'var(--danger)',slots:[{_ptoRow:true}]},
  ];

  let rows='';
  deptGroups.forEach(grp=>{
    if(!grp.slots.length) return;
    rows+=`<tr class="sw-section-hd"><td colspan="${weekDates.length+1}"><span class="sw-dept-dot" style="background:${grp.color}"></span>${grp.label}</td></tr>`;

    // PTO rows ‚Äî always read-only
    if(grp.slots[0]&&grp.slots[0]._ptoRow){
      for(let pi=0;pi<5;pi++){
        rows+=`<tr><td class="sw-room-col"><div class="sw-room-name" style="color:var(--danger)">Out / PTO ${pi+1}</div></td>`;
        weekDates.forEach(d=>{
          const name=PTO.filter(p=>p.pto_date===d).map(p=>p.staff_name)[pi];
          rows+=name
            ?`<td class="sw-pto-cell"><span class="sw-pto-name">${name}</span></td>`
            :`<td style="text-align:center;color:var(--text3);font-size:11px">‚Äî</td>`;
        });
        rows+='</tr>';
      }
      return;
    }

    grp.slots.forEach(tmpl=>{
      // Support row room label ‚Äî no hardcoded shift time shown
      if(tmpl.support){
        if(SW_EDIT){
          // In edit mode just show room name; shift time picker is per-day cell
          rows+=`<tr><td class="sw-room-col"><div class="sw-room-name" style="font-size:11px">${tmpl.room}</div><div style="font-size:9px;color:var(--text3);margin-top:2px">shift per day</div></td>`;
        } else {
          rows+=`<tr><td class="sw-room-col"><div class="sw-room-name">${tmpl.room}</div></td>`;
        }
      } else {
        rows+=`<tr><td class="sw-room-col"><div class="sw-room-name">${tmpl.room}</div><div class="sw-room-shift">${tmpl.shift||''}</div></td>`;
      }
      weekDates.forEach(d=>{
        // Blocked camera
        if(isRoomBlocked(tmpl.room,d)){
          const bk=BLOCKOUTS.find(b=>b.room_code===tmpl.room&&d>=b.start_date&&d<=b.end_date);
          rows+=`<td class="sw-blocked-cell">üö´ ${bk?bk.reason:'Blocked'}</td>`;
          return;
        }
        // Support rows ‚Äî per-day handling
        if(tmpl.support){
          const petShifts=['6:00am-2:30pm','7:30am-4:00pm','8:30am-5:00pm','9:30am-6:00pm'];
          // Find any existing schedule record for this support slot on this day
          const existingSlot=SCHEDULE.find(s=>s.shift_date===d&&s.room===tmpl.room&&s.department==='Support');
          const savedShift=existingSlot?existingSlot.shift_time:'';
          const savedTech=existingSlot?existingSlot.assigned_tech:'';

          if(!SW_EDIT){
            // View mode: show tech only ‚Äî no shift time label unless explicitly assigned
            if(!existingSlot||!existingSlot.assigned_tech){rows+=`<td><div class="sw-cell-empty">‚Äî</div></td>`;return;}
            rows+=`<td><div class="sw-cell-ro">${existingSlot.assigned_tech}</div>${existingSlot.shift_time?`<div style="font-size:9px;color:var(--text3);padding:0 8px 4px">${existingSlot.shift_time}</div>`:''}</td>`;
            return;
          }

          // Edit mode: shift time select + tech select per day
          const supKey=`${tmpl.room}__${d}`;
          const effectiveShift=SW_SUPPORT_SHIFTS[supKey]||savedShift||'';
          const shiftOpts=`<option value="">‚Äî pick shift ‚Äî</option>`+petShifts.map(s=>`<option value="${s}"${s===effectiveShift?' selected':''}>${s}</option>`).join('');

          // Re-find slot with effective shift in case it changed
          const slotByShift=SCHEDULE.find(s=>s.shift_date===d&&s.room===tmpl.room&&s.shift_time===effectiveShift&&s.department==='Support');
          const slotId=slotByShift?slotByShift.id:`NEW__${tmpl.room}__${effectiveShift}__${d}`;
          const currentTech=slotByShift?(SW_CHANGES[slotByShift.id]!==undefined?SW_CHANGES[slotByShift.id]:slotByShift.assigned_tech):(SW_CHANGES[slotId]||'');
          const isChanged=SW_CHANGES[slotId]!==undefined||(slotByShift&&SW_CHANGES[slotByShift.id]!==undefined);
          const eligible=STAFF.filter(s=>['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'].includes(s.name));
          const techOpts='<option value="">‚Äî empty ‚Äî</option>'+eligible.map(s=>`<option${currentTech===s.name?' selected':''}>${s.name}</option>`).join('');

          rows+=`<td>
            <select class="fsel" style="font-size:9px;padding:2px 4px;margin-bottom:3px;background:var(--surface2);border-color:rgba(124,111,247,0.3);color:var(--pet);width:100%" onchange="setSupportDayShift('${tmpl.room}','${d}',this.value)">${shiftOpts}</select>
            <select class="fsel${isChanged?' sw-changed':''}${!currentTech?' unfilled':''}" data-id="${slotId}" data-date="${d}" data-support="1" data-room="${tmpl.room}" style="width:100%" onchange="handleSwChange(this)">${techOpts}</select>
          </td>`;
          return;
        }

        // READ-ONLY mode
        if(!SW_EDIT){
          if(!slot){rows+=`<td><div class="sw-cell-empty">‚Äî</div></td>`;return;}
          if(!slot.assigned_tech){rows+=`<td><div class="sw-cell-unassigned">‚Äî Unassigned ‚Äî</div></td>`;return;}
          rows+=`<td><div class="sw-cell-ro">${slot.assigned_tech}</div></td>`;
          return;
        }

        // EDIT mode ‚Äî same dropdown mechanism as generator
        // If no slot record exists in DB, create a virtual placeholder so it's still editable
        const slotId=slot?slot.id:`NEW__${tmpl.room}__${effectiveShift}__${d}`;
        const currentVal=slot?(SW_CHANGES[slot.id]!==undefined?SW_CHANGES[slot.id]:slot.assigned_tech):(SW_CHANGES[slotId]||'');
        const isChanged=SW_CHANGES[slotId]!==undefined;
        const isBad=!currentVal;
        const qual=tmpl.dept||'Support';
        // Support slots: Lexi/Natalie/Tyler first; PET/General: anyone with that qual (incl. support staff if qualified)
        const eligible=qual==='Support'
          ?STAFF.filter(s=>['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'].includes(s.name))
          :STAFF.filter(s=>s.qualifications?.includes(qual));
        const others=STAFF.filter(s=>!eligible.find(e=>e.name===s.name));
        let opts=`<option value="">‚Äî Unassigned ‚Äî</option>`;
        eligible.forEach(s=>{opts+=`<option value="${s.name}"${currentVal===s.name?' selected':''}>${s.name}</option>`;});
        if(others.length){opts+=`<optgroup label="‚ö† Outside quals">`;others.forEach(s=>{opts+=`<option value="${s.name}"${currentVal===s.name?' selected':''}>${s.name}</option>`;});opts+=`</optgroup>`;}
        // Check if currently double-booked ‚Äî only compare against real camera slots (exclude PTO/support/blocked)
        const realSlotsForDupe=SCHEDULE.filter(s=>
          s.shift_date===d && s.id!==slotId && s.assigned_tech &&
          !s._pto && !s._support && !s._blocked && !s._manual
        );
        const isDupe=currentVal&&realSlotsForDupe.some(s=>s.assigned_tech===currentVal);
        rows+=`<td><select class="sw-sel${isBad?' unfilled':''}${isChanged?' sw-changed':''}${isDupe?' sw-dupe':''}" data-id="${slotId}" data-room="${tmpl.room}" data-shift="${effectiveShift}" data-dept="${tmpl.dept||'Support'}" data-date="${d}" onchange="trackWeekChange(this,'${d}')">${opts}</select></td>`;
      });
      rows+='</tr>';
    });
  });

  body.innerHTML=`<div class="sw-wrap"><table class="sw-grid"><thead><tr>${hdrs}</tr></thead><tbody>${rows}</tbody></table></div>`;
}

function trackWeekChange(sel, dateISO){
  const id=sel.dataset.id;
  const val=sel.value||null;
  // Push previous value onto undo stack before applying change
  const slot=SCHEDULE.find(s=>s.id===id);
  const prevVal=SW_CHANGES.hasOwnProperty(id)?SW_CHANGES[id]:(slot?slot.assigned_tech:null);
  SW_UNDO_STACK.push({id, prevVal, sel});
  SW_CHANGES[id]=val;
  sel.classList.add('sw-changed');
  sel.classList.toggle('unfilled',!val);
  sel.classList.remove('sw-dupe');

  // Double-booking check ‚Äî only highlight the two conflicting cells
  // First clear all existing orange on this day
  document.querySelectorAll(`select[data-date="${dateISO}"]`).forEach(s=>s.classList.remove('sw-dupe'));

  if(val){
    const allSelects=Array.from(document.querySelectorAll(`select[data-date="${dateISO}"]`));
    // Only check real camera/dept slots ‚Äî exclude support rows
    const cameraSelects=allSelects.filter(s=>s.dataset.dept!=='Support'||sel.dataset.dept==='Support');
    const conflict=cameraSelects.find(s=>s!==sel&&s.value===val);
    if(conflict){
      sel.classList.add('sw-dupe');
      conflict.classList.add('sw-dupe');
      showDupeWarning(val,dateISO);
    }
  }

  // Show save bar
  const count=Object.keys(SW_CHANGES).length;
  const bar=document.getElementById('sw-save-bar');
  bar.style.display='flex';
  document.getElementById('sw-change-count').textContent=`${count} unsaved change${count!==1?'s':''}`;
  const undoBtn=document.getElementById('sw-undo-btn');
  if(undoBtn){const hasUndo=SW_UNDO_STACK.length>0;undoBtn.disabled=!hasUndo;undoBtn.style.opacity=hasUndo?'1':'0.4';undoBtn.style.cursor=hasUndo?'pointer':'not-allowed';}
}

function setSupportDayShift(room, date, shiftTime){
  // Store per-day shift selection
  SW_SUPPORT_SHIFTS[`${room}__${date}`]=shiftTime;
  // If there's an existing DB record for this day, queue a shift_time update
  const existing=SCHEDULE.find(s=>s.shift_date===date&&s.room===room&&s.department==='Support');
  if(existing){
    // Mark the slot id as needing a shift_time change
    if(!SW_SHIFT_TIME_CHANGES) window.SW_SHIFT_TIME_CHANGES={};
    SW_SHIFT_TIME_CHANGES[existing.id]=shiftTime;
  }
  renderWeekGrid();
}

function undoLastChange(){
  if(!SW_UNDO_STACK.length) return;
  const{id, prevVal}=SW_UNDO_STACK.pop();

  // Restore SW_CHANGES ‚Äî if prevVal was the original DB value, remove from changes
  const slot=SCHEDULE.find(s=>s.id===id);
  const originalVal=slot?slot.assigned_tech:null;
  if(prevVal===originalVal){
    delete SW_CHANGES[id];
  } else {
    SW_CHANGES[id]=prevVal;
  }

  // Update the actual select in the DOM
  const selEl=document.querySelector(`select[data-id="${id}"]`);
  if(selEl){
    selEl.value=prevVal||'';
    selEl.classList.remove('sw-dupe');
    const isChanged=SW_CHANGES.hasOwnProperty(id);
    selEl.classList.toggle('sw-changed', isChanged);
    selEl.classList.toggle('unfilled', !prevVal);
    // Re-run dupe check for this date
    const dateISO=selEl.dataset.date;
    document.querySelectorAll(`select[data-date="${dateISO}"]`).forEach(s=>s.classList.remove('sw-dupe'));
    if(prevVal){
      const allSelects=Array.from(document.querySelectorAll(`select[data-date="${dateISO}"]`));
      const conflict=allSelects.find(s=>s!==selEl&&s.value===prevVal);
      if(conflict){selEl.classList.add('sw-dupe');conflict.classList.add('sw-dupe');}
    }
  }

  // Update save bar
  const count=Object.keys(SW_CHANGES).length;
  const undoBtn=document.getElementById('sw-undo-btn');
  const hasUndo=SW_UNDO_STACK.length>0;
  if(undoBtn){undoBtn.disabled=!hasUndo;undoBtn.style.opacity=hasUndo?'1':'0.4';undoBtn.style.cursor=hasUndo?'pointer':'not-allowed';}
  if(count===0){
    document.getElementById('sw-save-bar').style.display='none';
  } else {
    document.getElementById('sw-change-count').textContent=`${count} unsaved change${count!==1?'s':''}`;
  }
}

async function saveWeekChanges(){
  const entries=Object.entries(SW_CHANGES);
  if(!entries.length&&!Object.keys(window.SW_SHIFT_TIME_CHANGES||{}).length) return;
  let errors=0;

  // Save shift_time changes for support rows
  for(const[id,shiftTime] of Object.entries(window.SW_SHIFT_TIME_CHANGES||{})){
    const{error}=await sb.from('schedule').update({shift_time:shiftTime}).eq('id',id);
    if(error) errors++;
  }

  for(const[id,val] of entries){
    if(!val) continue;
    if(id.startsWith('NEW__')){
      const parts=id.split('__');
      const room=parts[1];
      const shift=parts[2];
      const date=parts[3];
      const tmpl=TEMPLATE.find(t=>t.room===room);
      const dept=tmpl?tmpl.dept:'Support';
      // For support rows use the per-day selected shift time; fall back to template shift
      const effectiveShift=tmpl&&tmpl.support?(SW_SUPPORT_SHIFTS[`${room}__${date}`]||shift):shift;
      if(tmpl&&tmpl.support&&!effectiveShift){
        toast('Please select a shift time for '+room+' on '+date,'err');
        errors++;continue;
      }
      const{error}=await sb.from('schedule').insert({
        shift_date:date,department:dept,room,shift_time:effectiveShift,assigned_tech:val,notes:null
      });
      if(error) errors++;
    } else {
      const{error}=await sb.from('schedule').update({assigned_tech:val}).eq('id',id);
      if(error) errors++;
    }
  }
  if(errors){toast(`${errors} saves failed`,'err');return;}
  toast(`‚úì Changes republished`,'ok');
  SW_CHANGES={};window.SW_SHIFT_TIME_CHANGES={};
  SW_EDIT=false;
  document.getElementById('sw-save-bar').style.display='none';
  document.getElementById('sw-edit-banner').style.display='none';
  document.getElementById('sw-edit-btn').innerHTML='‚úè Edit Week';
  document.getElementById('sw-edit-btn').style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';
  await loadAll();
}

function discardWeekChanges(){
  SW_CHANGES={};
  SW_UNDO_STACK=[];
  SW_SUPPORT_SHIFTS={};
  window.SW_SHIFT_TIME_CHANGES={};
  document.getElementById('sw-save-bar').style.display='none';
  renderWeekGrid();
}

async function deletePublishedWeek(){
  if(!SW_WEEK) return;
  const fri=new Date(SW_WEEK+'T12:00:00');fri.setDate(fri.getDate()+4);
  const friISO=fri.toISOString().split('T')[0];
  const count=SCHEDULE.filter(s=>s.shift_date>=SW_WEEK&&s.shift_date<=friISO).length;
  if(!confirm(`Delete all ${count} shifts for this week? This cannot be undone.`)) return;
  const{error}=await sb.from('schedule').delete().gte('shift_date',SW_WEEK).lte('shift_date',friISO);
  if(error){toast('Delete failed: '+error.message,'err');return;}
  toast('Week deleted ‚úì','ok');
  SW_WEEK=null;SW_CHANGES={};
  document.getElementById('sw-delete-btn').style.display='none';
  document.getElementById('sw-week-badge').style.display='none';
  document.getElementById('sw-stats').style.display='none';
  document.getElementById('sw-save-bar').style.display='none';
  await loadAll();
}

// ============================================================
// SCHEDULE GENERATOR
// ============================================================
function getWeekDays(mondayISO){
  const days=[];const start=new Date(mondayISO+'T12:00:00');
  for(let i=0;i<5;i++){const d=new Date(start);d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
  return days;
}

function isOnPTO(name,date){return PTO.some(p=>p.staff_name===name&&p.pto_date===date);}

function isAvailable(staff,date){
  const dayName=DAY_NAMES[new Date(date+'T12:00:00').getDay()];
  return(staff.available_days||'').toLowerCase().includes(dayName.toLowerCase());
}

function isSupport(staff){return SUPPORT_STAFF.includes(staff.name);}

// ‚îÄ‚îÄ SWAP FAIRNESS TOGGLE ‚îÄ‚îÄ
let EXCLUDE_SWAPS_FROM_FAIRNESS = true; // default ON

function toggleSwapFairness(){
  EXCLUDE_SWAPS_FROM_FAIRNESS = !EXCLUDE_SWAPS_FROM_FAIRNESS;
  const track = document.getElementById('toggle-track');
  const thumb = document.getElementById('toggle-thumb');
  const label = document.getElementById('toggle-label');
  if(EXCLUDE_SWAPS_FROM_FAIRNESS){
    track.style.background = 'var(--accent)';
    thumb.style.left = '23px';
    label.style.color = 'var(--accent)';
    label.textContent = 'ON';
  } else {
    track.style.background = 'var(--border2)';
    thumb.style.left = '3px';
    label.style.color = 'var(--text3)';
    label.textContent = 'OFF';
  }
}

// Returns schedule rows filtered by swap fairness setting
function fairnessSchedule(){
  if(!EXCLUDE_SWAPS_FROM_FAIRNESS) return SCHEDULE;
  // Get IDs of shifts that were modified by an approved swap
  const swappedTechsBySlot = new Map();
  ADMIN_SWAPS.filter(s=>s.status==='approved').forEach(s=>{
    // The original requester's slot now has volunteer's tech ‚Äî exclude it
    const key1 = `${s.give_shift_date}|${s.give_room}|${s.give_shift_time}`;
    const key2 = `${s.volunteer_shift_date}|${s.volunteer_room}|${s.volunteer_shift_time}`;
    swappedTechsBySlot.set(key1, s.requester_name); // original tech for that slot
    swappedTechsBySlot.set(key2, s.volunteer_name);  // original tech for that slot
  });
  // Restore original assignments for scoring purposes
  return SCHEDULE.map(row => {
    const key = `${row.shift_date}|${row.room}|${row.shift_time}`;
    if(swappedTechsBySlot.has(key)){
      return {...row, assigned_tech: swappedTechsBySlot.get(key)};
    }
    return row;
  });
}

// Count shift types this week for fairness scoring
function shiftCounts(name,weekDates){
  const all=[...fairnessSchedule(),...DRAFT].filter(s=>s.assigned_tech===name&&weekDates.includes(s.shift_date));
  return{
    early:all.filter(s=>s.shift_time.startsWith('6:0')||s.shift_time.startsWith('6:3')||s.shift_time.startsWith('6:4')).length,
    late:all.filter(s=>s.shift_time.startsWith('9:3')).length,
    total:all.length
  };
}

// Get rooms worked recently ‚Äî capped at 3 months for fairness rebalancing
function recentRooms(name){
  const cutoff=new Date();cutoff.setMonth(cutoff.getMonth()-3);
  const cutISO=cutoff.toISOString().split('T')[0];
  return fairnessSchedule().filter(s=>s.assigned_tech===name&&s.shift_date>=cutISO).slice(-20).map(s=>s.room);
}

// Staff with fixed shift constraints (name -> allowed shift times)
const SHIFT_CONSTRAINTS={
  'John (JU)':['9:30am-6:00pm'],  // John only works 9:30-6pm PET
};

function isShiftAllowed(staffName, shiftTime){
  if(!SHIFT_CONSTRAINTS[staffName]) return true;
  return SHIFT_CONSTRAINTS[staffName].includes(shiftTime);
}

// Get the shift time this tech has already been assigned this week (for consistency)
function assignedShiftThisWeek(name, weekDates){
  const assigned=DRAFT.filter(s=>s.assigned_tech===name&&weekDates.includes(s.shift_date));
  if(!assigned.length) return null;
  // Return the most common shift time they've been given
  const counts={};
  assigned.forEach(s=>{counts[s.shift_time]=(counts[s.shift_time]||0)+1;});
  return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
}

function generateDraft(){
  const mondayISO=document.getElementById('gen-week-start').value;
  if(!mondayISO){toast('Please select a week','err');return;}
  const d=new Date(mondayISO+'T12:00:00');
  if(d.getDay()!==1){toast('Please pick a Monday','err');return;}

  DRAFT=[];
  const weekDates=getWeekDays(mondayISO);
  const alerts=[];

  // ---------------------------------------------------------------
  // SMART PRIORITY ALGORITHM
  //
  // Staff categories (from DB):
  //   PET-only:     Joe M, Joe A, John, Thomas, Maria C, Jen
  //   Dual PET+Gen: Adam, Andrew, Brittany, Eilena, McKinley, Naomi, Julianna
  //   General-only: Floyd, Lynn, Rebecca
  //   Support:      Lexi, Natalie, Tyler (manual only)
  //   Theranostics: Karina
  //
  // Priority order:
  //   1. Fill PET lanes with PET-only staff first (John locked to 9:30pm)
  //   2. Fill remaining PET lanes with dual staff only if needed
  //   3. Route ALL unused dual staff to General gaps
  //   4. Fill General-only lanes with General-only staff
  //   5. Any truly leftover dual staff can go to Support
  //   6. Keep same person in same lane all week ‚Äî only sub if unavailable
  // ---------------------------------------------------------------

  const petOnlyNames=['Joe M (JM)','Joe A (JA)','John (JU)','Thomas M (TM)','Maria C (MC)','Jen (JLM)'];
  const dualNames=['Adam (AS)','Andrew (AR)','Brittany (BLP)','Eilena (EK)','McKinley (MSP)','Naomi (NS)','Julianna (Jul)'];

  function isPETOnly(s){ return petOnlyNames.includes(s.name); }
  function isDual(s){ return dualNames.includes(s.name); }

  function canWorkLane(s, lane){
    if(isSupport(s)) return false;
    if(!s.qualifications?.includes(lane.dept)) return false;
    if(!isShiftAllowed(s.name, lane.shift)) return false;
    return true;
  }

  function availableOnDay(s, dateISO){
    return isAvailable(s, dateISO) && !isOnPTO(s.name, dateISO);
  }

  function availableSomeDayThisWeek(s, lane){
    return weekDates.some(d => availableOnDay(s,d) && canWorkLane(s,lane));
  }

  const petLanes       = TEMPLATE.filter(t=>t.dept==='PET' && !t.support);
  const generalLanes   = TEMPLATE.filter(t=>t.dept==='General' && !t.support);
  const theraLanes     = TEMPLATE.filter(t=>t.dept==='Theranostics' && !t.support);

  // usedByDay[dateISO] = Set of staff names already assigned that day
  const usedByDay={};
  weekDates.forEach(d=>usedByDay[d]=new Set());

  // laneOwner: laneKey -> staffName for whole week
  const laneOwner={};

  // ---- HELPER: pick best owner for a lane from a candidate pool ----
  // pickOwner: find best owner for a lane from pool ‚Äî each person can own AT MOST ONE lane
  function pickOwner(lane, pool, allowMultiOwn=false){
    const alreadyOwned=new Set(Object.values(laneOwner).filter(Boolean));
    const eligible=pool.filter(s=>{
      if(!canWorkLane(s,lane)) return false;
      if(!availableSomeDayThisWeek(s,lane)) return false;
      if(!allowMultiOwn && alreadyOwned.has(s.name)) return false; // each person owns exactly ONE lane
      return true;
    });
    if(!eligible.length) return null;
    const scored=eligible.map(s=>{
      let score=0;
      const coverDays=weekDates.filter(d=>availableOnDay(s,d)).length;
      score -= coverDays*4;  // strongly prefer someone who covers the most days
      const recent=recentRooms(s.name);
      if(recent.slice(-2).includes(lane.room)) score+=4;
      if(recent.slice(-5).includes(lane.room)) score+=2;
      score+=Math.random()*0.4;
      return{s,score};
    });
    scored.sort((a,b)=>a.score-b.score);
    return scored[0].s.name;
  }

  // ---- PRE-STEP: Calculate how many dual staff PET needs vs General needs ----
  // PET-only staff available this week
  const petOnlyAvailable=STAFF.filter(s=>isPETOnly(s)&&weekDates.some(d=>availableOnDay(s,d)&&canWorkLane(s,{dept:'PET',shift:'any',...s}))).length;
  // More precisely: count PET-only who can work any PET lane
  const petOnlyCount=STAFF.filter(s=>isPETOnly(s)&&weekDates.some(d=>availableOnDay(s,d))).length;
  const petLanesNeedingDual=Math.max(0, petLanes.length - petOnlyCount);

  // General-only staff available
  const genOnlyCount=STAFF.filter(s=>s.qualifications?.includes('General')&&!s.qualifications?.includes('PET')&&!isSupport(s)&&weekDates.some(d=>availableOnDay(s,d))).length;
  const generalLanesNeedingDual=Math.max(0, generalLanes.length - genOnlyCount);

  // Total duals available this week
  const dualsAvailable=STAFF.filter(s=>isDual(s)&&weekDates.some(d=>availableOnDay(s,d)));

  // PET gets first pick of duals, General gets the rest
  // Sort duals by coverage days descending so we assign the most-available people first
  const dualsSorted=dualsAvailable.slice().sort((a,b)=>{
    const dA=weekDates.filter(d=>availableOnDay(a,d)).length;
    const dB=weekDates.filter(d=>availableOnDay(b,d)).length;
    return dB-dA;
  });
  const reservedForPET=new Set(dualsSorted.slice(0,petLanesNeedingDual).map(s=>s.name));
  const reservedForGeneral=new Set(dualsSorted.slice(petLanesNeedingDual,petLanesNeedingDual+generalLanesNeedingDual).map(s=>s.name));

  // ---- STEP 1: Theranostics ----
  theraLanes.forEach(lane=>{
    const laneKey=`${lane.dept}|${lane.room}|${lane.shift}`;
    const pool=STAFF.filter(s=>!isSupport(s)&&s.qualifications?.includes('Theranostics'));
    laneOwner[laneKey]=pickOwner(lane,pool);
  });

  // ---- STEP 2: PET lanes ‚Äî PET-only staff only (no dual staff needed in PET) ----
  // John's 9:30pm lanes processed first ‚Äî guaranteed slot
  const johnLanes=petLanes.filter(l=>l.shift==='9:30am-6:00pm');
  const otherPetLanes=petLanes.filter(l=>l.shift!=='9:30am-6:00pm');
  const orderedPetLanes=[...johnLanes,...otherPetLanes];

  orderedPetLanes.forEach(lane=>{
    const laneKey=`${lane.dept}|${lane.room}|${lane.shift}`;
    // PET-only staff first ‚Äî never touch dual staff reserved for General
    const petOnlyPool=STAFF.filter(s=>isPETOnly(s));
    let owner=pickOwner(lane, petOnlyPool);
    if(!owner){
      // Use duals reserved for PET
      const petDuals=STAFF.filter(s=>isDual(s)&&reservedForPET.has(s.name));
      owner=pickOwner(lane, petDuals);
    }
    if(!owner){
      // PET must be filled ‚Äî use any available dual not yet owned
      owner=pickOwner(lane, STAFF.filter(s=>isDual(s)));
    }
    laneOwner[laneKey]=owner;
  });

  // ---- STEP 3: General lanes ‚Äî General-only first, then reserved duals ----
  generalLanes.forEach(lane=>{
    const laneKey=`${lane.dept}|${lane.room}|${lane.shift}`;
    const genOnlyPool=STAFF.filter(s=>s.qualifications?.includes('General')&&!s.qualifications?.includes('PET')&&!isSupport(s));
    let owner=pickOwner(lane, genOnlyPool);
    if(!owner){
      // Use duals reserved for General
      const reservedPool=STAFF.filter(s=>isDual(s)&&reservedForGeneral.has(s.name));
      owner=pickOwner(lane, reservedPool);
    }
    if(!owner){
      // Last resort: any available dual
      owner=pickOwner(lane, STAFF.filter(s=>isDual(s)), true);
    }
    laneOwner[laneKey]=owner;
  });

  // ---- STEP 4: Build day-by-day DRAFT from lane owners ----
  const allLanes=[...theraLanes,...orderedPetLanes,...generalLanes];

  allLanes.forEach(lane=>{
    const laneKey=`${lane.dept}|${lane.room}|${lane.shift}`;
    const owner=laneOwner[laneKey];

    weekDates.forEach(dateISO=>{
      const entry={shift_date:dateISO,department:lane.dept,room:lane.room,shift_time:lane.shift,assigned_tech:null,notes:null,_manual:false,_unfilled:false};

      // Skip if camera is blocked on this day
      if(isRoomBlocked(lane.room, dateISO)){
        entry._blocked=true;
        entry._unfilled=false;
        DRAFT.push(entry);return;
      }

      const ownerStaff=owner?STAFF.find(s=>s.name===owner):null;
      const ownerAvail=ownerStaff && availableOnDay(ownerStaff,dateISO) && canWorkLane(ownerStaff,lane);

      if(ownerAvail && !usedByDay[dateISO].has(owner)){
        entry.assigned_tech=owner;
        usedByDay[dateISO].add(owner);
      } else {
        // Find substitute ‚Äî prefer same category as owner, same shift time
        const isOwnerPETOnly=owner&&petOnlyNames.includes(owner);
        const isOwnerDual=owner&&dualNames.includes(owner);

        // Build sub pool: right quals, available, not already used today
        let subPool=STAFF.filter(s=>{
          if(isSupport(s)) return false;
          if(!canWorkLane(s,lane)) return false;
          if(!availableOnDay(s,dateISO)) return false;
          if(usedByDay[dateISO].has(s.name)) return false;
          return true;
        });

        if(!subPool.length){
          entry._unfilled=true;
          alerts.push(`‚ö† No available ${lane.dept} tech for ${lane.room} ${lane.shift} on ${fmtD(dateISO)}`);
        } else {
          const scored=subPool.map(s=>{
            let score=0;
            // Strongly prefer keeping same shift time all week for this sub
            const theirDraftShifts=DRAFT.filter(x=>x.assigned_tech===s.name&&weekDates.includes(x.shift_date));
            const theirShiftTimes=new Set(theirDraftShifts.map(x=>x.shift_time));
            if(theirShiftTimes.size>0 && theirShiftTimes.has(lane.shift)) score-=8; // already on this shift = ideal
            if(theirShiftTimes.size>0 && !theirShiftTimes.has(lane.shift)) score+=10; // switching shift = bad
            // Prefer PET-only for PET lanes (don't pull dual staff into PET if not needed)
            if(lane.dept==='PET' && isPETOnly(s)) score-=5;
            if(lane.dept==='PET' && isDual(s)) score+=3;
            // Spread load
            score+=theirDraftShifts.length*1.5;
            score+=Math.random()*0.4;
            return{s,score};
          });
          scored.sort((a,b)=>a.score-b.score);
          entry.assigned_tech=scored[0].s.name;
          usedByDay[dateISO].add(entry.assigned_tech);
        }
      }
      DRAFT.push(entry);
    });
  });

  // ---- STEP 5: PET Support slots ‚Äî auto-fill Lexi/Natalie/Tyler on days available ----
  const supportLanes=TEMPLATE.filter(t=>t.support);
  const supportStaffNames=['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'];

  // For each day, collect which support staff are available
  supportLanes.forEach((lane,laneIdx)=>{
    weekDates.forEach(dateISO=>{
      const entry={shift_date:dateISO,department:lane.dept,room:lane.room,shift_time:lane.shift,assigned_tech:null,notes:null,_manual:true,_support:true,_unfilled:false};
      // Find available support staff not yet used in a support slot this day
      const usedSupportToday=DRAFT.filter(x=>x.shift_date===dateISO&&x._support&&x.assigned_tech).map(x=>x.assigned_tech);
      const avail=supportStaffNames.filter(name=>{
        if(usedSupportToday.includes(name)) return false;
        const s=STAFF.find(x=>x.name===name);
        return s && isAvailable(s,dateISO) && !isOnPTO(name,dateISO);
      });
      if(avail.length>0) entry.assigned_tech=avail[0]; // assign first available
      DRAFT.push(entry);
    });
  });

  // ---- STEP 6: PTO row ‚Äî auto-detect who is on PTO each day ----
  // This is read-only display, stored as _pto entries
  weekDates.forEach(dateISO=>{
    const onPTO=STAFF.filter(s=>!isSupport(s)&&isOnPTO(s.name,dateISO)).map(s=>s.name);
    // Store up to 5 PTO entries per day
    for(let i=0;i<5;i++){
      DRAFT.push({shift_date:dateISO,department:'PTO',room:'PTO',shift_time:'',assigned_tech:onPTO[i]||null,notes:null,_manual:false,_pto:true,_unfilled:false,_ptoIdx:i});
    }
  });

  renderDraft(weekDates,[...new Set(alerts)]);
}

function buildOpts(slot, dateISO){
  const isSupport=slot._support||slot._manual;
  const qual=slot.department;
  let eligible, others;
  if(isSupport){
    // Support slots: primary = Lexi/Natalie/Tyler; fallback = anyone available
    eligible=STAFF.filter(s=>['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'].includes(s.name)&&isAvailable(s,dateISO)&&!isOnPTO(s.name,dateISO));
    others=STAFF.filter(s=>!eligible.find(e=>e.name===s.name)&&!isOnPTO(s.name,dateISO)&&isAvailable(s,dateISO));
  } else {
    // PET/General slots: include support staff if they're qualified AND available that day
    eligible=STAFF.filter(s=>s.qualifications?.includes(qual)&&isAvailable(s,dateISO)&&!isOnPTO(s.name,dateISO));
    others=STAFF.filter(s=>!eligible.find(e=>e.name===s.name)&&!isOnPTO(s.name,dateISO)&&isAvailable(s,dateISO));
  }
  let opts=`<option value="">‚Äî Unassigned ‚Äî</option>`;
  eligible.forEach(s=>{opts+=`<option value="${s.name}"${slot.assigned_tech===s.name?' selected':''}>${s.name}</option>`;});
  if(others.length){
    opts+=`<optgroup label="‚ö† Outside qualifications">`;
    others.forEach(s=>{opts+=`<option value="${s.name}"${slot.assigned_tech===s.name?' selected':''}>${s.name}</option>`;});
    opts+=`</optgroup>`;
  }
  return opts;
}

function renderDraft(weekDates,alerts){
  document.getElementById('gen-draft-area').style.display='block';
  const ws=new Date(weekDates[0]+'T12:00:00'),we=new Date(weekDates[4]+'T12:00:00');
  document.getElementById('draft-sub').textContent=`Week of ${ws.toLocaleDateString('en-US',{month:'long',day:'numeric'})} ‚Äì ${we.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`;
  document.getElementById('gen-alerts').innerHTML=alerts.map(a=>`<div class="alert-row">${a}</div>`).join('');

  // Day headers
  const DAY_ABBR=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let hdrs='<th style="width:160px">Room / Shift</th>';
  weekDates.forEach(d=>{
    const dt=new Date(d+'T12:00:00');
    const unfilledCount=DRAFT.filter(s=>s.shift_date===d&&!s.assigned_tech&&!s._manual&&!s._support&&!s._pto&&!s._blocked).length;
    const badge=unfilledCount?`<div style="font-size:9px;color:var(--danger);font-weight:600;margin-top:3px">‚ö† ${unfilledCount} unfilled</div>`:`<div style="font-size:9px;color:var(--success);margin-top:3px">‚úì Staffed</div>`;
    hdrs+=`<th class="day-th">${DAY_ABBR[dt.getDay()]} ${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})}${badge}</th>`;
  });

  // Build rows grouped by dept
  const deptGroups=[
    {label:'üü£  PET',slots:TEMPLATE.filter(t=>t.dept==='PET')},
    {label:'  PET Support',slots:TEMPLATE.filter(t=>t.support)},
    {label:'üü°  Theranostics',slots:TEMPLATE.filter(t=>t.dept==='Theranostics')},
    {label:'üü¢  General',slots:TEMPLATE.filter(t=>t.dept==='General')},
    {label:'üèñ  PTO / Out',slots:[{dept:'PTO',room:'PTO',shift:'',_ptoRow:true}]},
  ];

  let rows='';
  deptGroups.forEach(grp=>{
    if(!grp.slots.length) return;
    rows+=`<tr class="section-row"><td colspan="${weekDates.length+1}"><span>${grp.label}</span></td></tr>`;

    // Special PTO row ‚Äî read-only, shows 5 PTO staff per day
    if(grp.slots[0]&&grp.slots[0]._ptoRow){
      for(let ptoIdx=0;ptoIdx<5;ptoIdx++){
        rows+=`<tr style="background:rgba(248,81,73,0.03)"><td><div class="room-cell"><span class="room-cell-name" style="color:var(--danger)">Out / PTO ${ptoIdx+1}</span></div></td>`;
        weekDates.forEach(dateISO=>{
          const ptoEntry=DRAFT.find(s=>s._pto&&s.shift_date===dateISO&&s._ptoIdx===ptoIdx);
          const name=ptoEntry?.assigned_tech;
          if(name){
            rows+=`<td style="text-align:center"><span style="background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);border-radius:6px;padding:4px 8px;font-size:11px;color:var(--danger);white-space:nowrap">${name}</span></td>`;
          } else {
            rows+=`<td style="text-align:center;color:var(--text3);font-size:11px">‚Äî</td>`;
          }
        });
        rows+='</tr>';
      }
      return;
    }

    grp.slots.forEach(tmpl=>{
      rows+=`<tr><td><div class="room-cell"><span class="room-cell-name">${tmpl.room}</span><span class="room-cell-shift">${tmpl.shift||''}</span></div></td>`;
      weekDates.forEach(dateISO=>{
        const slot=DRAFT.find(s=>s.shift_date===dateISO&&s.room===tmpl.room&&s.shift_time===tmpl.shift&&s.department===tmpl.dept&&!s._pto);
        if(!slot){rows+=`<td style="color:var(--text3);font-size:11px;text-align:center">‚Äî</td>`;return;}
        if(slot._blocked){
          const bReason=BLOCKOUTS.find(b=>b.room_code===slot.room&&dateISO>=b.start_date&&dateISO<=b.end_date);
          rows+=`<td style="text-align:center"><span style="background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:6px;padding:4px 8px;font-size:10px;color:#fb923c;font-weight:600">üö´ ${bReason?bReason.reason:'Blocked'}</span></td>`;
          return;
        }
        const idx=DRAFT.indexOf(slot);
        const isBad=!slot.assigned_tech&&!slot._support&&!slot._pto;
        rows+=`<td><select class="grid-sel${isBad?' unfilled':''}" onchange="updateSlot(${idx},this.value)">${buildOpts(slot,dateISO)}</select></td>`;
      });
      rows+='</tr>';
    });
  });

  document.getElementById('gen-days').innerHTML=`
    <div class="gen-grid-wrap">
      <table class="sched-grid">
        <thead><tr>${hdrs}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function updateSlot(idx,val){
  DRAFT[idx].assigned_tech=val||null;
  DRAFT[idx]._unfilled=!val;

  // ---- Double-booking detection ----
  // Clear all existing orange highlights first
  document.querySelectorAll('.grid-sel.double-booked').forEach(el=>el.classList.remove('double-booked'));

  if(val){
    const thisDate=DRAFT[idx].shift_date;
    // Find all slots on the same day assigned to the same tech
    const dupes=DRAFT.map((s,i)=>({s,i})).filter(({s,i})=>
      s.assigned_tech===val && s.shift_date===thisDate && !s._pto
    );
    if(dupes.length>1){
      // Highlight all selects for this tech on this day
      const allSelects=document.querySelectorAll('.grid-sel');
      const draftSelects=[...document.querySelectorAll('.grid-sel')];
      // Map selects to draft indices by counting non-PTO, non-section selects
      let selIdx=0;
      const selectMap={};
      DRAFT.forEach((s,i)=>{if(!s._pto) selectMap[i]=selIdx++;});
      dupes.forEach(({s,i})=>{
        const si=selectMap[i];
        if(si!==undefined && draftSelects[si]) draftSelects[si].classList.add('double-booked');
      });
      // Show warning toast
      showDupeWarning(val, thisDate);
    }
  }

  // Refresh day header badges
  const weekDates=[...new Set(DRAFT.filter(s=>!s._pto).map(s=>s.shift_date))];
  const DAY_ABBR=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  document.querySelectorAll('.sched-grid th.day-th').forEach((th,i)=>{
    const d=weekDates[i];if(!d)return;
    const dt=new Date(d+'T12:00:00');
    const uf=DRAFT.filter(s=>s.shift_date===d&&!s.assigned_tech&&!s._manual&&!s._support&&!s._pto&&!s._blocked).length;
    const badge=uf?`<div style="font-size:9px;color:var(--danger);font-weight:600;margin-top:3px">‚ö† ${uf} unfilled</div>`:`<div style="font-size:9px;color:var(--success);margin-top:3px">‚úì Staffed</div>`;
    th.innerHTML=`${DAY_ABBR[dt.getDay()]} ${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})}${badge}`;
  });
}

function showDupeWarning(name, dateISO){
  let el=document.getElementById('dupe-warning');
  if(!el){
    el=document.createElement('div');
    el.id='dupe-warning';
    el.className='dupe-warning';
    document.body.appendChild(el);
  }
  const dt=new Date(dateISO+'T12:00:00');
  el.innerHTML=`‚ö† <strong>${name}</strong> is already scheduled on ${dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}. Both slots are highlighted orange.`;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),5000);
}

function clearDraft(){if(!confirm('Discard this draft?'))return;DRAFT=[];document.getElementById('gen-draft-area').style.display='none';}

async function publishDraft(){
  const unfilled=DRAFT.filter(s=>!s.assigned_tech&&!s._manual&&!s._support&&!s._pto&&!s._blocked);
  if(unfilled.length&&!confirm(`${unfilled.length} slot${unfilled.length>1?'s are':' is'} unfilled. Publish anyway?`)) return;
  document.getElementById('pub-btn').textContent='Publishing...';
  document.getElementById('pub-btn').disabled=true;
  const toPublish=DRAFT.filter(s=>s.assigned_tech).map(s=>({shift_date:s.shift_date,department:s.department,room:s.room,shift_time:s.shift_time,assigned_tech:s.assigned_tech,notes:s.notes||null}));
  const{error}=await sb.from('schedule').insert(toPublish);
  if(error){toast('Publish failed: '+error.message,'err');document.getElementById('pub-btn').textContent='‚úì Publish Live';document.getElementById('pub-btn').disabled=false;return;}
  const publishedMonday=toPublish[0].shift_date;
  toast(`‚úì ${toPublish.length} shifts are now live!`,'ok');
  DRAFT=[];
  document.getElementById('gen-draft-area').style.display='none';
  document.getElementById('pub-btn').textContent='‚úì Publish Live';
  document.getElementById('pub-btn').disabled=false;
  await loadAll();
  // Navigate to Schedule tab and open the published week
  goTo('schedule',document.querySelectorAll('.nav-btn')[1]);
  selectSwWeek(publishedMonday);
}

// ============================================================
// ============================================================
// EQUIPMENT & BLOCKOUTS
// ============================================================
function isRoomBlocked(roomCode, dateISO){
  return BLOCKOUTS.some(b=>b.room_code===roomCode && dateISO>=b.start_date && dateISO<=b.end_date);
}

function renderEquipment(){
  const grid=document.getElementById('eq-grid');
  if(!grid) return;
  const today=new Date().toISOString().split('T')[0];

  grid.innerHTML=EQUIPMENT.map(eq=>{
    const blockouts=BLOCKOUTS.filter(b=>b.equipment_id===eq.id&&b.end_date>=today);
    const isBlocked=blockouts.length>0;
    const deptColor=eq.department==='PET'?'var(--pet)':eq.department==='General'?'var(--general)':eq.department==='Theranostics'?'var(--thera)':'var(--text2)';
    const blockoutRows=blockouts.map(b=>`
      <div class="eq-blockout-row">
        <div>
          <div class="eq-blockout-reason">üö´ ${b.reason}</div>
          <div class="eq-blockout-dates">${b.start_date===b.end_date?b.start_date:`${b.start_date} ‚Üí ${b.end_date}`}</div>
        </div>
        <button class="btn-sm btn-sm-d" onclick="deleteBlockout('${b.id}')">Remove</button>
      </div>`).join('');

    return`<div class="eq-card ${isBlocked?'blocked':''}">
      <div class="eq-card-top">
        <div>
          <div class="eq-name">${eq.name}</div>
          <div class="eq-dept" style="color:${deptColor}">${eq.department} ¬∑ ${eq.room_code}</div>
        </div>
        <div class="eq-status ${isBlocked?'blocked':'active'}">${isBlocked?'üö´ Blocked':'‚óè Active'}</div>
      </div>
      ${blockoutRows?`<div class="eq-blockouts">${blockoutRows}</div>`:''}
      <div class="eq-actions">
        <button class="btn-sm btn-sm-o" onclick="openBlockoutModal('${eq.id}','${eq.room_code}','${eq.name}')">üö´ Block</button>
        <button class="btn-sm btn-sm-g" onclick="openEquipModal('${eq.id}')">Edit</button>
        <button class="btn-sm btn-sm-d" onclick="deleteEquip('${eq.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}


function openEquipModal(id=null){
  document.getElementById('eq-edit-id').value=id||'';
  if(id){
    const eq=EQUIPMENT.find(e=>e.id===id);
    if(eq){
      document.getElementById('eq-name').value=eq.name;
      document.getElementById('eq-code').value=eq.room_code;
      document.getElementById('eq-dept').value=eq.department;
      document.getElementById('eq-notes').value=eq.notes||'';
      document.getElementById('equip-modal-ttl').textContent='Edit Equipment';
    }
  } else {
    document.getElementById('eq-name').value='';
    document.getElementById('eq-code').value='';
    document.getElementById('eq-notes').value='';
    document.getElementById('equip-modal-ttl').textContent='Add Equipment';
  }
  document.getElementById('equip-modal').classList.add('open');
}


async function saveEquip(){
  const id=document.getElementById('eq-edit-id').value;
  const data={
    name:document.getElementById('eq-name').value.trim(),
    room_code:document.getElementById('eq-code').value.trim().toUpperCase(),
    department:document.getElementById('eq-dept').value,
    notes:document.getElementById('eq-notes').value.trim()||null,
  };
  if(!data.name||!data.room_code){toast('Name and room code required','err');return;}
  const{error}=id
    ? await sb.from('equipment').update(data).eq('id',id)
    : await sb.from('equipment').insert(data);
  if(error){toast('Save failed: '+error.message,'err');return;}
  closeModal('equip-modal');toast(id?'Equipment updated ‚úì':'Equipment added ‚úì');await loadAll();
}


async function deleteEquip(id){
  if(!confirm('Delete this equipment? All blockouts will also be removed.')) return;
  await sb.from('equipment').delete().eq('id',id);
  toast('Deleted ‚úì');await loadAll();
}

function openBlockoutModal(equipId, roomCode, roomName){
  document.getElementById('bo-equip-id').value=equipId;
  document.getElementById('bo-room-code').value=roomCode;
  document.getElementById('blockout-modal-ttl').textContent=`Block: ${roomName}`;
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('bo-single-date').value=today;
  document.getElementById('bo-start').value=today;
  document.getElementById('bo-end').value=today;
  document.getElementById('bo-week-start').value=today;
  document.getElementById('bo-type').value='single';
  toggleBlockType();
  document.getElementById('blockout-modal').classList.add('open');
  // Reset calendar state and re-init
  const now=new Date();
  ['single','range','week'].forEach(type=>{
    boCalState[type].year=now.getFullYear();
    boCalState[type].month=now.getMonth();
    boCalState[type].selected=null;
    if(type==='range'){boCalState[type].start=null;boCalState[type].end=null;boCalState[type].picking='start';}
  });
  document.getElementById('bo-single-text').textContent='Select a date‚Ä¶';
  document.getElementById('bo-range-text').textContent='Select date range‚Ä¶';
  document.getElementById('bo-week-text').textContent='Select a Monday‚Ä¶';
  document.getElementById('bo-range-hint').textContent='Click a start date';
  ['single','range','week'].forEach(type=>renderBoCal(type));
  // Close dropdown when clicking outside
  setTimeout(()=>{
    document.addEventListener('click', function boCal(e){
      if(!e.target.closest('.bo-cal-wrap')){
        document.querySelectorAll('.bo-cal-dropdown').forEach(d=>d.classList.remove('open'));
        document.removeEventListener('click',boCal);
      }
    });
  },100);
}

// Blockout calendar state
const boCalState={
  single:{year:0,month:0,selected:null},
  range:{year:0,month:0,start:null,end:null,picking:'start'},
  week:{year:0,month:0,selected:null}
};

function toggleBlockType(){
  const t=document.getElementById('bo-type').value;
  document.getElementById('bo-single-wrap').style.display=t==='single'?'block':'none';
  document.getElementById('bo-range-wrap').style.display=t==='range'?'block':'none';
  document.getElementById('bo-week-wrap').style.display=t==='week'?'block':'none';
}

function toggleBoCal(type){
  // Close all others
  ['single','range','week'].forEach(t=>{
    if(t!==type) document.getElementById(`bo-${t}-dropdown`).classList.remove('open');
  });
  document.getElementById(`bo-${type}-dropdown`).classList.toggle('open');
}

function boCalNav(type, dir){
  const s=boCalState[type];
  s.month+=dir;
  if(s.month>11){s.month=0;s.year++;}
  if(s.month<0){s.month=11;s.year--;}
  renderBoCal(type);
}

function renderBoCal(type){
  const s=boCalState[type];
  const MONTHS_SHORT=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAYS=['Su','Mo','Tu','We','Th','Fr','Sa'];
  document.getElementById(`bo-${type}-month`).textContent=`${MONTHS_SHORT[s.month]} ${s.year}`;

  const today=new Date().toISOString().split('T')[0];
  const firstDow=new Date(s.year,s.month,1).getDay();
  const daysInMonth=new Date(s.year,s.month+1,0).getDate();

  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px;">`;
  DAYS.forEach(d=>html+=`<div style="text-align:center;font-size:9px;font-weight:700;color:var(--text3);padding:2px 0">${d}</div>`);
  html+=`</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;">`;

  for(let i=0;i<firstDow;i++) html+=`<div class="bo-day"></div>`;

  for(let d=1;d<=daysInMonth;d++){
    const iso=`${s.year}-${String(s.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow=new Date(iso+'T12:00:00').getDay();
    const isToday=iso===today;
    let cls='bo-day';
    let click='';
    let extraStyle='';

    if(type==='single'){
      cls+=' selectable';
      if(s.selected===iso) cls+=' selected';
      if(isToday) cls+=' today-bo';
      click=`onclick="boSelectSingle('${iso}')"`;
    } else if(type==='range'){
      cls+=' selectable';
      if(s.start&&s.end&&iso>=s.start&&iso<=s.end){
        if(iso===s.start) cls+=' range-start';
        else if(iso===s.end) cls+=' range-end';
        else cls+=' in-range';
      } else if(iso===s.start) cls+=' selected';
      if(isToday) cls+=' today-bo';
      click=`onclick="boSelectRange('${iso}')"`;
    } else if(type==='week'){
      if(dow===1){
        cls+=' monday-only';
        // Highlight selected week Mon-Fri
        if(s.selected){
          const selMon=new Date(s.selected+'T12:00:00');
          const selFri=new Date(selMon);selFri.setDate(selFri.getDate()+4);
          const cur=new Date(iso+'T12:00:00');
          if(cur>=selMon&&cur<=selFri) cls+=' selected';
          if(iso===s.selected) cls+=' selected';
        }
        if(isToday) cls+=' today-bo';
        click=`onclick="boSelectWeek('${iso}')"`;
      }
    }
    html+=`<div class="${cls}" ${click} style="${extraStyle}">${d}</div>`;
  }
  html+=`</div>`;
  document.getElementById(`bo-${type}-grid`).innerHTML=html;
}

function boSelectSingle(iso){
  boCalState.single.selected=iso;
  document.getElementById('bo-single-date').value=iso;
  const dt=new Date(iso+'T12:00:00');
  document.getElementById('bo-single-text').textContent=dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  renderBoCal('single');
  setTimeout(()=>document.getElementById('bo-single-dropdown').classList.remove('open'),200);
}

function boSelectRange(iso){
  const s=boCalState.range;
  if(s.picking==='start'||!s.start||(s.start&&s.end)){
    s.start=iso;s.end=null;s.picking='end';
    document.getElementById('bo-range-hint').textContent='Now click an end date';
  } else {
    if(iso<s.start){s.end=s.start;s.start=iso;}
    else s.end=iso;
    s.picking='start';
    document.getElementById('bo-start').value=s.start;
    document.getElementById('bo-end').value=s.end;
    const ds=new Date(s.start+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const de=new Date(s.end+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    document.getElementById('bo-range-text').textContent=`${ds} ‚Üí ${de}`;
    document.getElementById('bo-range-hint').textContent='Click start date to change';
    setTimeout(()=>document.getElementById('bo-range-dropdown').classList.remove('open'),300);
  }
  renderBoCal('range');
}

function boSelectWeek(iso){
  const mon=new Date(iso+'T12:00:00');
  const fri=new Date(mon);fri.setDate(fri.getDate()+4);
  boCalState.week.selected=iso;
  document.getElementById('bo-week-start').value=iso;
  const ds=mon.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const de=fri.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('bo-week-text').textContent=`${ds} ‚Äì ${de}`;
  renderBoCal('week');
  setTimeout(()=>document.getElementById('bo-week-dropdown').classList.remove('open'),200);
}

function initBoCalendars(){
  const now=new Date();
  ['single','range','week'].forEach(type=>{
    boCalState[type].year=now.getFullYear();
    boCalState[type].month=now.getMonth();
    renderBoCal(type);
  });
}

async function saveBlockout(){
  const equipId=document.getElementById('bo-equip-id').value;
  const roomCode=document.getElementById('bo-room-code').value;
  const reason=document.getElementById('bo-reason').value;
  const type=document.getElementById('bo-type').value;
  let startDate,endDate;
  if(type==='single'){
    startDate=endDate=document.getElementById('bo-single-date').value;
    if(!startDate){toast('Please select a date','err');return;}
  } else if(type==='range'){
    startDate=document.getElementById('bo-start').value;
    endDate=document.getElementById('bo-end').value;
    if(!startDate||!endDate){toast('Please select start and end dates','err');return;}
    if(endDate<startDate){toast('End date must be after start date','err');return;}
  } else {
    const mon=document.getElementById('bo-week-start').value;
    if(!mon){toast('Please select a Monday','err');return;}
    const monD=new Date(mon+'T12:00:00');
    const fri=new Date(monD);fri.setDate(fri.getDate()+4);
    startDate=mon;endDate=fri.toISOString().split('T')[0];
  }
  const{error}=await sb.from('camera_blockouts').insert({equipment_id:equipId,room_code:roomCode,start_date:startDate,end_date:endDate,reason});
  if(error){toast('Failed: '+error.message,'err');return;}
  closeModal('blockout-modal');
  toast(`üö´ ${roomCode} blocked ${startDate===endDate?startDate:`${startDate}‚Üí${endDate}`}`,'warn');
  await loadAll();
}

async function deleteBlockout(id){
  await sb.from('camera_blockouts').delete().eq('id',id);
  toast('Blockout removed ‚úì');await loadAll();
}

// SCHEDULE EDIT
// ============================================================
function openShiftModal(id=null){
  document.getElementById('shift-edit-id').value=id||'';
  document.getElementById('s-tech').innerHTML=STAFF.map(s=>`<option>${s.name}</option>`).join('');
  if(id){
    const s=SCHEDULE.find(x=>x.id===id);
    document.getElementById('shift-modal-ttl').textContent='Edit Shift';
    document.getElementById('s-date').value=s.shift_date;document.getElementById('s-dept').value=s.department;
    document.getElementById('s-room').value=s.room;document.getElementById('s-shift').value=s.shift_time;
    document.getElementById('s-tech').value=s.assigned_tech;document.getElementById('s-notes').value=s.notes||'';
  }else{
    document.getElementById('shift-modal-ttl').textContent='Add Shift';
    document.getElementById('s-date').value=wkDates()[0]||new Date().toISOString().split('T')[0];
    document.getElementById('s-notes').value='';
  }
  document.getElementById('shift-modal').classList.add('open');
}
function editShift(id){openShiftModal(id);}
async function deleteShift(id){
  if(!confirm('Delete this shift?'))return;
  const{error}=await sb.from('schedule').delete().eq('id',id);
  if(error){toast('Delete failed','err');return;}
  toast('Deleted ‚úì');await loadAll();
}
async function saveShift(){
  const id=document.getElementById('shift-edit-id').value;
  const data={shift_date:document.getElementById('s-date').value,department:document.getElementById('s-dept').value,room:document.getElementById('s-room').value,shift_time:document.getElementById('s-shift').value,assigned_tech:document.getElementById('s-tech').value,notes:document.getElementById('s-notes').value||null,updated_at:new Date().toISOString()};
  const op=id?sb.from('schedule').update(data).eq('id',id):sb.from('schedule').insert(data);
  const{error}=await op;
  if(error){toast('Save failed','err');return;}
  closeModal('shift-modal');toast(id?'Updated ‚úì':'Added ‚úì');await loadAll();
}

// ============================================================
// PTO
// ============================================================
function renderPTO(){
  const sF=document.getElementById('f-pto-staff').value;
  const srch=document.getElementById('f-pto-srch').value.toLowerCase().trim();
  let html='';
  Object.entries(MONTHS).forEach(([month,info])=>{
    const start=dowStart(2026,info.n);
    const dayMap={};
    PTO.filter(p=>{
      const d=new Date(p.pto_date+'T12:00:00');
      if(d.getFullYear()!==2026||d.getMonth()+1!==info.n)return false;
      if(sF&&p.staff_name!==sF)return false;
      if(srch&&!p.staff_name.toLowerCase().includes(srch)&&!p.staff_initials.toLowerCase().includes(srch))return false;
      return true;
    }).forEach(p=>{
      const day=new Date(p.pto_date+'T12:00:00').getDate();
      if(!dayMap[day])dayMap[day]=[];
      dayMap[day].push({init:p.staff_initials,name:p.staff_name,date:p.pto_date});
    });
    html+=`<div class="mc"><div class="mch">${month.toUpperCase()} 2026<span style="font-size:10px;color:var(--text2)">${[...new Set(Object.values(dayMap).flat().map(x=>x.init))].length} staff</span></div><div class="cg">`;
    html+=['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=>`<div class="cdh">${d}</div>`).join('');
    for(let i=0;i<start;i++)html+=`<div class="cd empty"></div>`;
    for(let d=1;d<=info.d;d++){
      const dw=(start+d-1)%7,we=dw===0||dw===6;
      const hits=dayMap[d]||[];
      const iso=`2026-${String(info.n).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      html+=`<div class="cd ${we?'we':''} ${hits.length?'hp':''}" ${!we?`onclick="openPTOModal('${iso}')"`:''}><span class="dn">${d}</span>${hits.length?`<div class="pt">${hits.map(h=>`<span class="ptag" onclick="event.stopPropagation();quickRemovePTO('${h.date}','${h.init}')">${h.init}</span>`).join('')}</div>`:''}${!we?`<div class="add-hint">+ add</div>`:''}</div>`;
    }
    const tot=start+info.d;for(let i=tot%7;i>0&&i<7;i++)html+=`<div class="cd empty"></div>`;
    html+=`</div></div>`;
  });
  document.getElementById('pto-grid').innerHTML=html;
}
function openPTOModal(iso){
  document.getElementById('pto-date-val').value=iso;
  const d=new Date(iso+'T12:00:00');
  document.getElementById('pto-modal-ttl').textContent=`PTO ‚Äî ${d.toLocaleDateString('en-US',{month:'long',day:'numeric'})}`;
  document.getElementById('pto-staff-sel').innerHTML=STAFF.map(s=>`<option value="${s.initials}|${s.name}">${s.name}</option>`).join('');
  document.getElementById('pto-modal').classList.add('open');
}
async function quickRemovePTO(iso,init){
  if(!confirm(`Remove PTO for ${init} on ${iso}?`))return;
  const{error}=await sb.from('pto').delete().eq('pto_date',iso).eq('staff_initials',init);
  if(error){toast('Failed','err');return;}
  toast('Removed ‚úì');await loadAll();
}
async function savePTO(){
  const iso=document.getElementById('pto-date-val').value;
  const[init,name]=document.getElementById('pto-staff-sel').value.split('|');
  const action=document.getElementById('pto-action').value;
  let error;
  if(action==='add'){const r=await sb.from('pto').insert({staff_initials:init,staff_name:name,pto_date:iso});error=r.error;}
  else{const r=await sb.from('pto').delete().eq('pto_date',iso).eq('staff_initials',init);error=r.error;}
  if(error&&!error.message?.includes('duplicate')){toast('Save failed','err');return;}
  closeModal('pto-modal');toast(`PTO ${action==='add'?'added':'removed'} ‚úì`);await loadAll();
}

// ============================================================
// STAFF
// ============================================================
function renderStaff(){
  const qF=document.getElementById('f-qual').value;
  const sF=document.getElementById('f-staff').value.toLowerCase().trim();
  let list=STAFF;
  if(qF)list=list.filter(s=>s.qualifications?.includes(qF));
  if(sF)list=list.filter(s=>s.name.toLowerCase().includes(sF));
  document.getElementById('staff-sub').textContent=`${list.length} staff member${list.length!==1?'s':''}`;
  document.getElementById('staff-grid').innerHTML=list.map(s=>{
    const roleBadge=s.role==='Chief Technologist'
      ?`<span style="font-size:10px;font-weight:700;background:rgba(234,179,8,0.15);color:#eab308;border:1px solid rgba(234,179,8,0.3);padding:2px 8px;border-radius:20px;margin-left:6px">üëë Chief</span>`
      :s.role==='Lead Technologist'
      ?`<span style="font-size:10px;font-weight:700;background:rgba(124,111,247,0.15);color:var(--pet);border:1px solid rgba(124,111,247,0.3);padding:2px 8px;border-radius:20px;margin-left:6px">‚≠ê Lead</span>`
      :'';
    return `<div class="sc2"><div class="sca"><button class="btn-icon" onclick="editStaff('${s.id}')">‚úè</button><button class="btn-icon" style="background:rgba(248,81,73,0.1);color:var(--danger);border-color:rgba(248,81,73,0.3)" onclick="deleteStaff('${s.id}','${s.name.replace(/'/g,"\\'")}')">‚úï</button></div><div class="avl" style="background:${tc(s.name)}">${s.initials}</div><div style="flex:1;min-width:0"><div class="sn">${s.name}${roleBadge}</div><div class="sm">üìÖ ${s.available_days}</div><div class="sq">${(s.qualifications||[]).map(q=>`<span class="dept-pill dp-${q}">${q}</span>`).join('')}</div>${s.pto_dates?`<div class="sp"><div class="spl">PTO 2026</div><div>${s.pto_dates}</div></div>`:''}</div></div>`;
  }).join('');
}
function editStaff(id){const s=STAFF.find(x=>x.id===id);openStaffModal(s);}
async function deleteStaff(id,name){
  if(!confirm(`Remove ${name}?\n\nThis will also delete all of their PTO records.`))return;
  // Delete PTO records first
  await sb.from('pto').delete().eq('staff_id',id);
  // Then delete the staff record
  const{error}=await sb.from('staff').delete().eq('id',id);
  if(error){toast('Failed','err');return;}
  toast('Removed ‚úì');await loadAll();
}
async function saveStaff(){
  const id=document.getElementById('staff-edit-id').value;
  const quals=document.getElementById('st-quals').value.split(',').map(q=>q.trim()).filter(Boolean);
  const data={
    name:document.getElementById('st-name').value.trim(),
    initials:document.getElementById('st-init').value.trim().toUpperCase(),
    available_days:document.getElementById('st-days').value.trim(),
    qualifications:quals,
    role:document.getElementById('st-role').value||null,
    pto_dates:null
  };
  if(!data.name){toast('Name required','err');return;}
  const op=id?sb.from('staff').update(data).eq('id',id):sb.from('staff').insert(data).select();
  const{data:result,error}=await op;
  if(error){toast('Save failed','err');return;}

  // Insert PTO rows if any dates selected
  const staffId=id||(result&&result[0]?.id);
  if(staffId&&stPtoDates.size>0){
    const staffName=data.name;
    const staffInit=data.initials;
    // For edits: delete existing PTO first then re-insert
    if(id) await sb.from('pto').delete().eq('staff_id',staffId);
    const ptoRows=[...stPtoDates].sort().map(d=>({
      staff_id:staffId,staff_name:staffName,staff_initials:staffInit,pto_date:d
    }));
    await sb.from('pto').insert(ptoRows);
  } else if(id&&stPtoDates.size===0){
    // Cleared all PTO on edit
    await sb.from('pto').delete().eq('staff_id',id);
  }

  closeModal('staff-modal');toast(id?'Updated ‚úì':'Added ‚úì');await loadAll();
}

// ‚îÄ‚îÄ STAFF MODAL CHIP & MINI CALENDAR ‚îÄ‚îÄ
let stCalYear=new Date().getFullYear(), stCalMonth=new Date().getMonth();
let stPtoDates=new Set(); // ISO dates selected for new staff PTO

function toggleRoleChip(btn){
  // Only one role at a time ‚Äî clicking active one deselects it
  const wasActive=btn.classList.contains('active');
  document.querySelectorAll('.role-chip').forEach(c=>c.classList.remove('active'));
  if(!wasActive) btn.classList.add('active');
  document.getElementById('st-role').value=wasActive?'':btn.dataset.role;
}

function toggleDayChip(btn){
  btn.classList.toggle('active');
  const days=['Monday','Tuesday','Wednesday','Thursday','Friday']
    .filter(d=>document.querySelector(`.day-chip[data-day="${d}"]`)?.classList.contains('active'));
  document.getElementById('st-days').value=days.join(', ');
}

function toggleQualChip(btn){
  btn.classList.toggle('active');
  const quals=['PET','General','Theranostics','Support']
    .filter(q=>document.querySelector(`.qual-chip[data-qual="${q}"]`)?.classList.contains('active'));
  document.getElementById('st-quals').value=quals.join(', ');
}

function stCalNav(dir){
  stCalMonth+=dir;
  if(stCalMonth>11){stCalMonth=0;stCalYear++;}
  if(stCalMonth<0){stCalMonth=11;stCalYear--;}
  renderStCal();
}

function renderStCal(){
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAY=['Su','Mo','Tu','We','Th','Fr','Sa'];
  document.getElementById('st-cal-label').textContent=`${MNAMES[stCalMonth]} ${stCalYear}`;
  const firstDow=new Date(stCalYear,stCalMonth,1).getDay();
  const daysInMonth=new Date(stCalYear,stCalMonth+1,0).getDate();
  let html=DAY.map(d=>`<div style="text-align:center;font-size:9px;font-weight:700;color:var(--text3);padding:2px 0;text-transform:uppercase">${d}</div>`).join('');
  for(let i=0;i<firstDow;i++) html+=`<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const dow=new Date(stCalYear,stCalMonth,d).getDay();
    const iso=`${stCalYear}-${String(stCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isWe=dow===0||dow===6;
    const isSel=stPtoDates.has(iso);
    const cls=`st-cal-day${isWe?' we':''}${isSel?' pto-selected':''}`;
    const click=isWe?'':` onclick="toggleStPto('${iso}')"`;
    html+=`<div class="${cls}"${click}>${d}</div>`;
  }
  document.getElementById('st-cal-grid').innerHTML=html;
  renderStPtoTags();
}

function toggleStPto(iso){
  if(stPtoDates.has(iso)) stPtoDates.delete(iso);
  else stPtoDates.add(iso);
  document.getElementById('st-pto').value=[...stPtoDates].sort().join(',');
  renderStCal();
}

function renderStPtoTags(){
  const sorted=[...stPtoDates].sort();
  document.getElementById('st-pto-tags').innerHTML=sorted.map(iso=>{
    const d=new Date(iso+'T12:00:00');
    const label=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return `<span class="pto-tag">${label}<button onclick="toggleStPto('${iso}')">‚úï</button></span>`;
  }).join('');
}

function openStaffModal(s=null){
  // Reset chips
  document.querySelectorAll('.day-chip,.qual-chip,.role-chip').forEach(c=>c.classList.remove('active'));
  stPtoDates=new Set();
  stCalYear=new Date().getFullYear();stCalMonth=new Date().getMonth();
  document.getElementById('staff-edit-id').value=s?.id||'';
  document.getElementById('staff-modal-ttl').textContent=s?'Edit Staff':'Add Staff Member';
  document.getElementById('st-name').value=s?.name||'';
  document.getElementById('st-init').value=s?.initials||'';
  document.getElementById('st-role').value=s?.role||'';
  // Set role chip
  if(s?.role){
    const rc=document.querySelector(`.role-chip[data-role="${s.role}"]`);
    if(rc) rc.classList.add('active');
  }  // Set day chips
  if(s?.available_days){
    s.available_days.split(',').map(x=>x.trim()).forEach(day=>{
      const chip=document.querySelector(`.day-chip[data-day="${day}"]`);
      if(chip) chip.classList.add('active');
    });
    document.getElementById('st-days').value=s.available_days;
  }
  // Set qual chips
  if(s?.qualifications){
    s.qualifications.forEach(q=>{
      const chip=document.querySelector(`.qual-chip[data-qual="${q}"]`);
      if(chip) chip.classList.add('active');
    });
    document.getElementById('st-quals').value=s.qualifications.join(', ');
  }
  // Load existing PTO from DB for edit
  if(s?.id){
    const existingPTO=PTO.filter(p=>p.staff_id===s.id).map(p=>p.pto_date);
    existingPTO.forEach(d=>stPtoDates.add(d));
    document.getElementById('st-pto').value=[...stPtoDates].sort().join(',');
  }
  renderStCal();
  document.getElementById('staff-modal').classList.add('open');
}

function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// ============================================================
// CALENDAR PICKER
// ============================================================
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth();
let calSelected=null;

function toggleCal(){
  const dd=document.getElementById('cal-dropdown');
  const tr=document.getElementById('cal-trigger');
  const isOpen=dd.classList.contains('open');
  if(isOpen){dd.classList.remove('open');tr.classList.remove('open');}
  else{dd.classList.add('open');tr.classList.add('open');renderCal();}
}

function calNav(dir){
  calMonth+=dir;
  if(calMonth>11){calMonth=0;calYear++;}
  if(calMonth<0){calMonth=11;calYear--;}
  renderCal();
}

function renderCal(){
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-month-label').textContent=`${MNAMES[calMonth]} ${calYear}`;

  const scheduledMondays=new Set();
  SCHEDULE.forEach(s=>{const d=new Date(s.shift_date+'T12:00:00');if(d.getDay()===1)scheduledMondays.add(s.shift_date);});

  // Every individual day that has a camera blocked (not just Mondays)
  const blockedDays=new Set();
  BLOCKOUTS.forEach(b=>{
    let cur=new Date(b.start_date+'T12:00:00');
    const end=new Date(b.end_date+'T12:00:00');
    while(cur<=end){
      blockedDays.add(cur.toISOString().split('T')[0]);
      cur.setDate(cur.getDate()+1);
    }
  });

  const firstDay=new Date(calYear,calMonth,1);
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const startOffset=firstDay.getDay();
  const today=new Date().toISOString().split('T')[0];

  const dayHeaders=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let html=dayHeaders.map((h,i)=>`<div class="cal-dh${i===1?' hl':''}">${h}</div>`).join('');

  for(let i=0;i<firstDay.getDay();i++) html+=`<div class="cal-day"></div>`;

  for(let d=1;d<=daysInMonth;d++){
    const dow=new Date(calYear,calMonth,d).getDay();
    const iso=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isMon=dow===1;
    let cls='cal-day';
    if(isMon) cls+=' monday';
    if(calSelected===iso) cls+=' selected';
    if(scheduledMondays.has(iso)) cls+=' has-sched';
    if(iso===today) cls+=' is-today';
    const click=isMon?`onclick="selectMonday('${iso}')"`:'';
    const hasBlock=blockedDays.has(iso);
    if(hasBlock) cls+=' has-block';
    const tip=isMon?(scheduledMondays.has(iso)?'Already scheduled ‚Äî can still add more':hasBlock?'‚ö† Camera blocked this week':'Click to select this week'):'';
    html+=`<div class="${cls}" ${click} title="${tip}">${d}</div>`;
  }

  // Trailing blank cells to complete last row
  const total=startOffset+daysInMonth;
  const trail=(7-total%7)%7;
  for(let i=0;i<trail;i++) html+=`<div class="cal-day"></div>`;

  document.getElementById('cal-full-grid').innerHTML=html;
}

function selectMonday(iso){
  calSelected=iso;
  document.getElementById('gen-week-start').value=iso;
  const d=new Date(iso+'T12:00:00');
  const wEnd=new Date(d);wEnd.setDate(wEnd.getDate()+4);
  document.getElementById('cal-trigger-text').textContent=
    `${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${wEnd.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  document.getElementById('cal-dropdown').classList.remove('open');
  document.getElementById('cal-trigger').classList.remove('open');
  renderCal();
}

// Close calendar when clicking outside
document.addEventListener('click',e=>{
  const wrap=document.getElementById('cal-wrap');
  if(wrap&&!wrap.contains(e.target)){
    document.getElementById('cal-dropdown')?.classList.remove('open');
    document.getElementById('cal-trigger')?.classList.remove('open');
  }
});

checkSession();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî SWAP REQUESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ADMIN_SWAPS=[];

async function loadAdminSwaps(){
  const{data,error}=await sb.from('shift_swap_requests').select('*').order('created_at',{ascending:false});
  if(error){console.warn('Swap load:',error.message);return;}
  ADMIN_SWAPS=data||[];
  await expireOldSwaps();
  // Re-fetch after expiry cleanup
  const{data:fresh}=await sb.from('shift_swap_requests').select('*').order('created_at',{ascending:false});
  ADMIN_SWAPS=fresh||[];
  const pending=ADMIN_SWAPS.filter(s=>s.status==='pending').length;
  const wrap=document.getElementById('swap-pending-wrap');
  if(wrap) wrap.style.display=pending?'inline':'none';
  const cnt=document.getElementById('swap-pending-count');
  if(cnt) cnt.textContent=pending;
  const navBtn=document.getElementById('admin-swaps-nav');
  if(navBtn) navBtn.innerHTML=`üîÑ Swap Requests${pending?` <span style="background:#f59e0b;color:#000;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700;margin-left:3px">${pending}</span>`:''}`;
  const subEl=document.getElementById('swaps-admin-sub');
  if(subEl) subEl.textContent=`${ADMIN_SWAPS.length} total ¬∑ ${pending} pending approval`;
  renderAdminSwaps();
}

function renderAdminSwaps(){
  const filter=document.getElementById('swaps-admin-filter')?.value||'all';
  const list=filter==='all'?ADMIN_SWAPS:ADMIN_SWAPS.filter(s=>s.status===filter);
  const body=document.getElementById('admin-swaps-body');
  if(!body) return;
  if(!list.length){
    body.innerHTML=`<div style="text-align:center;padding:60px;color:var(--text2)"><div style="font-size:40px;opacity:0.3;margin-bottom:12px">üîÑ</div><div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">No swap requests</div><div style="font-size:13px">Nothing in this category</div></div>`;
    return;
  }
  body.innerHTML=list.map(r=>renderAdminSwapCard(r)).join('');
}

function renderAdminSwapCard(r){
  const dc=d=>d==='PET'?'var(--pet)':d==='General'?'var(--general)':d==='Theranostics'?'var(--thera)':'var(--accent)';
  const mon=d=>new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  const ago=iso=>{const m=Math.floor((new Date()-new Date(iso))/60000);return m<60?`${m}m ago`:m<1440?`${Math.floor(m/60)}h ago`:`${Math.floor(m/1440)}d ago`;};
  const pillStyle={open:'background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.25)',pending:'background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.25)',approved:'background:rgba(63,185,80,0.1);color:var(--success);border:1px solid rgba(63,185,80,0.25)',denied:'background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.25)'}[r.status]||'';
  const pillLabel={open:'Open',pending:'‚è≥ Pending Approval',approved:'‚úì Approved',denied:'‚úï Denied'}[r.status]||r.status;
  const shiftBadge=(room,shift,date,dept)=>`<div style="display:inline-flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border2);border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600"><span style="width:6px;height:6px;border-radius:50%;background:${dc(dept)};display:inline-block;flex-shrink:0"></span>${room} ¬∑ ${shift}<br><span style="color:var(--text2);font-size:10px;font-weight:400">${mon(date)}</span></div>`;

  let tradeHTML='';
  if(r.volunteer_name){
    tradeHTML=`<div style="display:grid;grid-template-columns:1fr 36px 1fr;gap:10px;align-items:center;background:var(--surface2);border-radius:12px;padding:14px 16px;margin-bottom:12px">
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);margin-bottom:5px">${r.requester_name} gives up</div>${shiftBadge(r.give_room,r.give_shift_time,r.give_shift_date,r.give_department)}</div>
      <div style="text-align:center;font-size:20px;color:var(--text3)">‚áÑ</div>
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);margin-bottom:5px">${r.volunteer_name} gives up</div>${shiftBadge(r.volunteer_room,r.volunteer_shift_time,r.volunteer_shift_date,r.volunteer_department)}</div>
    </div>`;
  } else {
    const wHTML=(r.wanted_shifts||[]).map(w=>`<span style="display:inline-flex;align-items:center;gap:5px;background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.2);border-radius:6px;padding:4px 10px;font-size:11px;font-weight:600"><span style="width:5px;height:5px;border-radius:50%;background:${dc(w.department)};display:inline-block"></span>${w.room} ¬∑ ${w.shift_time}</span>`).join('');
    tradeHTML=`<div style="margin-bottom:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);margin-bottom:6px">Wants to give up</div>${shiftBadge(r.give_room,r.give_shift_time,r.give_shift_date,r.give_department)}</div>
    <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);margin-bottom:6px">Would accept in return</div><div style="display:flex;flex-wrap:wrap;gap:6px">${wHTML}</div></div>`;
  }

  const deleteBtn=`<button class="swap-delete-btn" onclick="deleteSwap('${r.id}')" style="background:rgba(248,81,73,0.08);border:1px solid rgba(248,81,73,0.2);border-radius:8px;color:var(--danger);font-size:11px;font-weight:600;padding:5px 12px;cursor:pointer;margin-left:auto">üóë Delete</button>`;
  const actionHTML=r.status==='pending'
    ?`<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input class="si" placeholder="Optional note to techs‚Ä¶" id="anote-${r.id}" style="flex:1;min-width:160px;font-size:12px;padding:7px 10px">
        <button class="btn btn-s" style="background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3);padding:7px 16px;font-size:12px" onclick="actionSwap('${r.id}','denied')">‚úï Deny</button>
        <button class="btn btn-p" style="padding:7px 16px;font-size:12px" onclick="actionSwap('${r.id}','approved')">‚úì Approve Swap</button>
        ${deleteBtn}
      </div>`
    :r.status==='open'
    ?`<div style="display:flex;align-items:center;gap:10px"><div style="font-size:12px;color:var(--text2);flex:1">Waiting for a volunteer ‚Äî no action needed yet</div>${deleteBtn}</div>`
    :r.status==='approved'
    ?`<div style="display:flex;align-items:center;gap:10px"><div style="font-size:12px;color:var(--success);flex:1">‚úì Approved by ${r.actioned_by||'admin'} ¬∑ Schedule updated automatically</div>${deleteBtn}</div>`
    :`<div style="display:flex;align-items:center;gap:10px"><div style="font-size:12px;color:var(--danger);flex:1">‚úï Denied${r.admin_note?` ‚Äî "${r.admin_note}"`:''}</div>${deleteBtn}</div>`;

  const borderColor={open:'var(--accent)',pending:'#f59e0b',approved:'var(--success)',denied:'var(--danger)'}[r.status]||'var(--border)';
  return `<div data-swap-id="${r.id}" style="background:var(--surface);border:1px solid var(--border);border-left:3px solid ${borderColor};border-radius:16px;overflow:hidden;margin-bottom:16px;transition:opacity 0.2s">
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px 0">
      <div style="width:36px;height:36px;border-radius:50%;background:var(--surface2);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--accent);font-family:'Space Mono',monospace;flex-shrink:0">${(r.requester_name.match(/\(([^)]+)\)/)||[,'??'])[1]}</div>
      <div style="flex:1"><div style="font-weight:700;font-size:14px">${r.requester_name}</div><div style="font-size:11px;color:var(--text3);margin-top:2px">${ago(r.created_at)}</div></div>
      <span style="padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;${pillStyle}">${pillLabel}</span>
    </div>
    <div style="padding:14px 20px">${tradeHTML}${r.note?`<div style="font-size:12px;color:var(--text2);font-style:italic;padding:8px 12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--border2);margin-top:10px">üí¨ &nbsp;${r.note}</div>`:''}</div>
    <div style="padding:12px 20px 16px;border-top:1px solid var(--border)">${actionHTML}</div>
  </div>`;
}

async function deleteSwap(id){
  const r=ADMIN_SWAPS.find(s=>s.id===id);
  if(!r) return;
  const name=r.requester_name;
  if(!confirm(`Delete ${name}'s swap request? This cannot be undone.`)) return;
  swapIsDeleting=true; // pause polling
  // Visual feedback ‚Äî grey out the card
  const card=document.querySelector(`[data-swap-id="${id}"]`);
  if(card){card.style.opacity='0.4';card.style.pointerEvents='none';card.querySelector('.swap-delete-btn').textContent='Deleting‚Ä¶';}
  const{error}=await sb.from('shift_swap_requests').delete().eq('id',id);
  swapIsDeleting=false; // resume polling
  if(error){
    if(card){card.style.opacity='';card.style.pointerEvents='';card.querySelector('.swap-delete-btn').textContent='üóë Delete';}
    toast('Error deleting request: '+error.message,'err');return;
  }
  toast(`üóë ${name}'s swap request deleted`,'ok');
  await loadAdminSwaps();
}

async function expireOldSwaps(){
  // Auto-delete any OPEN requests where the shift date has already passed
  const today=new Date().toISOString().split('T')[0];
  const expired=ADMIN_SWAPS.filter(s=>s.status==='open'&&s.give_shift_date<today);
  if(!expired.length) return;
  for(const r of expired){
    await sb.from('shift_swap_requests').delete().eq('id',r.id);
  }
  if(expired.length) toast(`üßπ ${expired.length} expired swap request${expired.length>1?'s':''} auto-removed`,'ok');
}

// Poll every 30s for new volunteer offers
let swapPollInterval=null;
let swapIsDeleting=false; // guard against poll firing during delete
function startSwapPolling(){
  if(swapPollInterval) clearInterval(swapPollInterval);
  swapPollInterval=setInterval(async()=>{
    if(swapIsDeleting) return; // skip poll if a delete is in progress
    if(document.getElementById('page-swaps').classList.contains('active')){
      const prevPending=ADMIN_SWAPS.filter(s=>s.status==='pending').length;
      await loadAdminSwaps();
      const newPending=ADMIN_SWAPS.filter(s=>s.status==='pending').length;
      if(newPending>prevPending) toast(`üîî New swap offer received ‚Äî ${newPending} pending approval`,'ok');
    }
  },30000);
}

async function actionSwap(id, action){
  const r=ADMIN_SWAPS.find(s=>s.id===id);
  if(!r) return;
  const note=document.getElementById('anote-'+id)?.value||null;
  const{data:userData}=await sb.auth.getUser();
  const adminEmail=userData?.user?.email||'admin';

  if(action==='approved'){
    // Swap the two techs in the published schedule
    const{error:e1}=await sb.from('schedule').update({assigned_tech:r.volunteer_name})
      .eq('shift_date',r.give_shift_date).eq('room',r.give_room).eq('shift_time',r.give_shift_time);
    const{error:e2}=await sb.from('schedule').update({assigned_tech:r.requester_name})
      .eq('shift_date',r.volunteer_shift_date).eq('room',r.volunteer_room).eq('shift_time',r.volunteer_shift_time);
    if(e1||e2){toast('Error updating schedule: '+((e1||e2).message),'err');return;}
  }

  const{error}=await sb.from('shift_swap_requests').update({
    status:action,actioned_by:adminEmail,actioned_at:new Date().toISOString(),admin_note:note
  }).eq('id',id);
  if(error){toast('Error: '+error.message,'err');return;}
  toast(action==='approved'?'‚úì Swap approved ‚Äî schedule updated!':'Request denied','ok');
  await loadAll();
  await loadAdminSwaps();
}



function getPublishedMondays(){
  const mondays=new Set();
  SCHEDULE.forEach(s=>{
    const d=new Date(s.shift_date+'T12:00:00');
    const diff=(d.getDay()+6)%7;
    const mon=new Date(d);mon.setDate(d.getDate()-diff);
    mondays.add(mon.toISOString().split('T')[0]);
  });
  return mondays;
}

// ---- SCHEDULE CALENDAR ----
function toggleSwCal(){
  const dd=document.getElementById('sw-cal-dropdown');
  const tr=document.getElementById('sw-cal-trigger');
  const isOpen=dd.classList.contains('open');
  if(isOpen){dd.classList.remove('open');tr.classList.remove('open');}
  else{dd.classList.add('open');tr.classList.add('open');renderSwCal();}
}

function swCalNav(dir){
  swCalMonth+=dir;
  if(swCalMonth>11){swCalMonth=0;swCalYear++;}
  if(swCalMonth<0){swCalMonth=11;swCalYear--;}
  renderSwCal();
}

function renderSwCal(){
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAY_ABBR=['Su','Mo','Tu','We','Th','Fr','Sa'];
  document.getElementById('sw-cal-month-label').textContent=`${MNAMES[swCalMonth]} ${swCalYear}`;

  const publishedMondays=getPublishedMondays();
  const today=new Date().toISOString().split('T')[0];
  const firstDow=new Date(swCalYear,swCalMonth,1).getDay();
  const daysInMonth=new Date(swCalYear,swCalMonth+1,0).getDate();

  // Day headers
  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;width:100%">`;
  DAY_ABBR.forEach(d=>html+=`<div class="cal-dh">${d}</div>`);
  html+=`</div>`;

  // Build day array with padding
  let days=[];
  for(let i=0;i<firstDow;i++) days.push(null);
  for(let d=1;d<=daysInMonth;d++) days.push(d);
  while(days.length%7!==0) days.push(null);

  html+=`<div>`;
  for(let w=0;w<days.length/7;w++){
    const week=days.slice(w*7,w*7+7);
    // Find Monday (index 1 = Monday in Sun-start grid) ‚Äî use actual day value at col 1
    const monDay=week[1]; // col index 1 is always Monday in a Sun-start calendar
    // But if the row has no real days at all, skip it
    const hasAnyDay=week.some(d=>d!==null);
    if(!hasAnyDay){
      html+=`<div class="sw-week-empty">`;
      week.forEach(()=>html+=`<div class="sw-cal-day"></div>`);
      html+=`</div>`;
      continue;
    }
    // If Monday cell is null this week has no Monday (partial first/last row) ‚Äî render as non-clickable
    if(!monDay){
      html+=`<div class="sw-week-empty">`;
      week.forEach(d=>{
        if(!d){html+=`<div class="sw-cal-day"></div>`;return;}
        const iso=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday=iso===today;
        const todayRing=isToday?'style="background:rgba(0,212,170,0.15);border-radius:6px;"':'';
        html+=`<div class="sw-cal-day" ${todayRing}>${d}</div>`;
      });
      html+=`</div>`;
      continue;
    }
    const monISO=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(monDay).padStart(2,'0')}`;
    const isPublished=publishedMondays.has(monISO);
    const isSelected=SW_WEEK===monISO;
    const weekCls=`sw-week-row${isPublished?' sw-week-published':''}${isSelected?' sw-week-selected':''}`;
    const clickAttr=isPublished?`onclick="selectSwWeek('${monISO}')"`:'' ;

    html+=`<div class="${weekCls}" ${clickAttr}>`;
    week.forEach((d,di)=>{
      if(!d){html+=`<div class="sw-cal-day"></div>`;return;}
      const iso=`${swCalYear}-${String(swCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isToday=iso===today&&!isSelected;
      const dot=isPublished?`<span class="sw-pub-dot"></span>`:'';
      const todayRing=isToday?'style="background:rgba(0,212,170,0.15);border-radius:6px;"':'';
      html+=`<div class="sw-cal-day" ${todayRing}>${d}${dot}</div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  document.getElementById('sw-cal-grid').innerHTML=html;
}

function selectSwWeek(monISO){
  SW_WEEK=monISO;
  SW_EDIT=false;
  SW_CHANGES={};
  const mon=new Date(monISO+'T12:00:00');
  const fri=new Date(mon);fri.setDate(fri.getDate()+4);
  document.getElementById('sw-cal-trigger-text').textContent=
    `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${fri.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  document.getElementById('sw-cal-dropdown').classList.remove('open');
  document.getElementById('sw-cal-trigger').classList.remove('open');
  document.getElementById('sw-week-sel').value=monISO;

  // Update badge
  const today=new Date().toISOString().split('T')[0];
  const friISO=fri.toISOString().split('T')[0];
  const badge=document.getElementById('sw-week-badge');
  badge.style.display='inline-flex';
  if(today>=monISO&&today<=friISO){badge.className='badge badge-current';badge.textContent='‚óè Current Week';}
  else if(today>friISO){badge.className='badge badge-past';badge.textContent='Past Week';}
  else{badge.className='badge badge-future';badge.textContent='Future Week';}

  document.getElementById('sw-edit-btn').style.display='inline-flex';
  document.getElementById('sw-delete-btn').style.display='inline-flex';
  document.getElementById('sw-edit-banner').style.display='none';
  document.getElementById('sw-save-bar').style.display='none';
  document.getElementById('sw-edit-btn').innerHTML='‚úè Edit Week';
  document.getElementById('sw-edit-btn').style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';

  renderSwCal();
  renderWeekGrid();
}

// Close sw calendar on outside click
document.addEventListener('click',e=>{
  const wrap=document.getElementById('sw-cal-wrap');
  if(wrap&&!wrap.contains(e.target)){
    document.getElementById('sw-cal-dropdown')?.classList.remove('open');
    document.getElementById('sw-cal-trigger')?.classList.remove('open');
  }
});

// ---- EDIT MODE ----
function toggleSwEdit(){
  SW_EDIT=!SW_EDIT;
  SW_CHANGES={};
  SW_UNDO_STACK=[];
  SW_SUPPORT_SHIFTS={};
  const btn=document.getElementById('sw-edit-btn');
  const banner=document.getElementById('sw-edit-banner');
  const saveBar=document.getElementById('sw-save-bar');
  if(SW_EDIT){
    btn.innerHTML='üëÅ View Mode';
    btn.style.cssText='background:rgba(0,212,170,0.12);color:var(--accent);border:1px solid rgba(0,212,170,0.3)';
    banner.style.display='flex';
  } else {
    btn.innerHTML='‚úè Edit Week';
    btn.style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';
    banner.style.display='none';
    saveBar.style.display='none';
  }
  renderWeekGrid();
}

// Called from goTo when switching to schedule tab
function loadWeekView(monISO){
  if(monISO) selectSwWeek(monISO);
  else renderWeekGrid();
}

function stepWeek(dir){
  const sel=document.getElementById('sw-week-sel');
  const idx=sel.selectedIndex;
  const next=idx-dir; // reversed list so -1=newer, +1=older
  if(next>=0&&next<sel.options.length){
    sel.selectedIndex=next;
    loadWeekView(sel.value);
  }
}

function loadWeekView(mondayISO){
  if(!mondayISO) return;
  SW_WEEK=mondayISO;
  SW_CHANGES={};
  document.getElementById('sw-week-sel').value=mondayISO;

  // Badge
  const today=new Date().toISOString().split('T')[0];
  const fri=new Date(mondayISO+'T12:00:00');fri.setDate(fri.getDate()+4);
  const friISO=fri.toISOString().split('T')[0];
  const badge=document.getElementById('sw-week-badge');
  badge.style.display='inline-flex';
  if(today>=mondayISO&&today<=friISO){badge.className='badge badge-current';badge.textContent='‚óè Current Week';}
  else if(today>friISO){badge.className='badge badge-past';badge.textContent='Past Week';}
  else{badge.className='badge badge-future';badge.textContent='Future Week';}

  document.getElementById('sw-delete-btn').style.display='inline-flex';
  document.getElementById('sw-save-bar').style.display='none';
  renderWeekGrid();
}

function renderWeekGrid(){
  if(!SW_WEEK) return;
  const body=document.getElementById('sched-body');
  if(!body) return;
  const weekDates=getWeekDays(SW_WEEK);

  // Stats row
  const weekSlots=SCHEDULE.filter(s=>weekDates.includes(s.shift_date));
  const filled=weekSlots.filter(s=>s.assigned_tech).length;
  const unfilled=weekSlots.filter(s=>!s.assigned_tech).length;
  const onPTO=[...new Set(weekDates.flatMap(d=>PTO.filter(p=>p.pto_date===d).map(p=>p.staff_name)))].length;
  const blocked=BLOCKOUTS.filter(b=>weekDates.some(d=>d>=b.start_date&&d<=b.end_date)).length;
  const stats=document.getElementById('sw-stats');
  if(stats){
    stats.style.display='flex';
    stats.innerHTML=[
      {val:filled,lbl:'Shifts Filled',color:'var(--success)'},
      {val:unfilled,lbl:'Unfilled',color:'var(--danger)'},
      {val:onPTO,lbl:'Staff on PTO',color:'var(--pto)'},
      {val:blocked,lbl:'Cameras Blocked',color:'#eab308'},
    ].map(s=>`<div class="sw-stat"><div class="sw-stat-val" style="color:${s.color}">${s.val}</div><div class="sw-stat-lbl">${s.lbl}</div></div>`).join('');
  }

  // Day headers
  const DAY_ABBR=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let hdrs=`<th style="min-width:148px">ROOM / SHIFT</th>`;
  weekDates.forEach(d=>{
    const dt=new Date(d+'T12:00:00');
    const uf=weekSlots.filter(s=>s.shift_date===d&&!s.assigned_tech).length;
    const badge=uf?`<div class="sw-day-badge sw-day-warn">‚ö† ${uf} Unfilled</div>`:`<div class="sw-day-badge sw-day-ok">‚úì Staffed</div>`;
    hdrs+=`<th class="sw-day-col"><div class="sw-day-hd"><div class="sw-day-name">${DAY_ABBR[dt.getDay()]}</div><div class="sw-day-date">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>${badge}</div></th>`;
  });

  const deptGroups=[
    {label:'PET',color:'var(--pet)',slots:TEMPLATE.filter(t=>t.dept==='PET')},
    {label:'PET Support',color:'var(--support)',slots:TEMPLATE.filter(t=>t.support)},
    {label:'Theranostics',color:'var(--thera)',slots:TEMPLATE.filter(t=>t.dept==='Theranostics')},
    {label:'General',color:'var(--general)',slots:TEMPLATE.filter(t=>t.dept==='General')},
    {label:'PTO / Out',color:'var(--danger)',slots:[{_ptoRow:true}]},
  ];

  let rows='';
  deptGroups.forEach(grp=>{
    if(!grp.slots.length) return;
    rows+=`<tr class="sw-section-hd"><td colspan="${weekDates.length+1}"><span class="sw-dept-dot" style="background:${grp.color}"></span>${grp.label}</td></tr>`;

    // PTO rows ‚Äî always read-only
    if(grp.slots[0]&&grp.slots[0]._ptoRow){
      for(let pi=0;pi<5;pi++){
        rows+=`<tr><td class="sw-room-col"><div class="sw-room-name" style="color:var(--danger)">Out / PTO ${pi+1}</div></td>`;
        weekDates.forEach(d=>{
          const name=PTO.filter(p=>p.pto_date===d).map(p=>p.staff_name)[pi];
          rows+=name
            ?`<td class="sw-pto-cell"><span class="sw-pto-name">${name}</span></td>`
            :`<td style="text-align:center;color:var(--text3);font-size:11px">‚Äî</td>`;
        });
        rows+='</tr>';
      }
      return;
    }

    grp.slots.forEach(tmpl=>{
      // Support row room label ‚Äî no hardcoded shift time shown
      if(tmpl.support){
        if(SW_EDIT){
          // In edit mode just show room name; shift time picker is per-day cell
          rows+=`<tr><td class="sw-room-col"><div class="sw-room-name" style="font-size:11px">${tmpl.room}</div><div style="font-size:9px;color:var(--text3);margin-top:2px">shift per day</div></td>`;
        } else {
          rows+=`<tr><td class="sw-room-col"><div class="sw-room-name">${tmpl.room}</div></td>`;
        }
      } else {
        rows+=`<tr><td class="sw-room-col"><div class="sw-room-name">${tmpl.room}</div><div class="sw-room-shift">${tmpl.shift||''}</div></td>`;
      }
      weekDates.forEach(d=>{
        // Blocked camera
        if(isRoomBlocked(tmpl.room,d)){
          const bk=BLOCKOUTS.find(b=>b.room_code===tmpl.room&&d>=b.start_date&&d<=b.end_date);
          rows+=`<td class="sw-blocked-cell">üö´ ${bk?bk.reason:'Blocked'}</td>`;
          return;
        }
        // Support rows ‚Äî per-day handling
        if(tmpl.support){
          const petShifts=['6:00am-2:30pm','7:30am-4:00pm','8:30am-5:00pm','9:30am-6:00pm'];
          // Find any existing schedule record for this support slot on this day
          const existingSlot=SCHEDULE.find(s=>s.shift_date===d&&s.room===tmpl.room&&s.department==='Support');
          const savedShift=existingSlot?existingSlot.shift_time:'';
          const savedTech=existingSlot?existingSlot.assigned_tech:'';

          if(!SW_EDIT){
            // View mode: show tech only ‚Äî no shift time label unless explicitly assigned
            if(!existingSlot||!existingSlot.assigned_tech){rows+=`<td><div class="sw-cell-empty">‚Äî</div></td>`;return;}
            rows+=`<td><div class="sw-cell-ro">${existingSlot.assigned_tech}</div>${existingSlot.shift_time?`<div style="font-size:9px;color:var(--text3);padding:0 8px 4px">${existingSlot.shift_time}</div>`:''}</td>`;
            return;
          }

          // Edit mode: shift time select + tech select per day
          const supKey=`${tmpl.room}__${d}`;
          const effectiveShift=SW_SUPPORT_SHIFTS[supKey]||savedShift||'';
          const shiftOpts=`<option value="">‚Äî pick shift ‚Äî</option>`+petShifts.map(s=>`<option value="${s}"${s===effectiveShift?' selected':''}>${s}</option>`).join('');

          // Re-find slot with effective shift in case it changed
          const slotByShift=SCHEDULE.find(s=>s.shift_date===d&&s.room===tmpl.room&&s.shift_time===effectiveShift&&s.department==='Support');
          const slotId=slotByShift?slotByShift.id:`NEW__${tmpl.room}__${effectiveShift}__${d}`;
          const currentTech=slotByShift?(SW_CHANGES[slotByShift.id]!==undefined?SW_CHANGES[slotByShift.id]:slotByShift.assigned_tech):(SW_CHANGES[slotId]||'');
          const isChanged=SW_CHANGES[slotId]!==undefined||(slotByShift&&SW_CHANGES[slotByShift.id]!==undefined);
          const eligible=STAFF.filter(s=>['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'].includes(s.name));
          const techOpts='<option value="">‚Äî empty ‚Äî</option>'+eligible.map(s=>`<option${currentTech===s.name?' selected':''}>${s.name}</option>`).join('');

          rows+=`<td>
            <select class="fsel" style="font-size:9px;padding:2px 4px;margin-bottom:3px;background:var(--surface2);border-color:rgba(124,111,247,0.3);color:var(--pet);width:100%" onchange="setSupportDayShift('${tmpl.room}','${d}',this.value)">${shiftOpts}</select>
            <select class="fsel${isChanged?' sw-changed':''}${!currentTech?' unfilled':''}" data-id="${slotId}" data-date="${d}" data-support="1" data-room="${tmpl.room}" style="width:100%" onchange="handleSwChange(this)">${techOpts}</select>
          </td>`;
          return;
        }

        // READ-ONLY mode
        if(!SW_EDIT){
          if(!slot){rows+=`<td><div class="sw-cell-empty">‚Äî</div></td>`;return;}
          if(!slot.assigned_tech){rows+=`<td><div class="sw-cell-unassigned">‚Äî Unassigned ‚Äî</div></td>`;return;}
          rows+=`<td><div class="sw-cell-ro">${slot.assigned_tech}</div></td>`;
          return;
        }

        // EDIT mode ‚Äî same dropdown mechanism as generator
        // If no slot record exists in DB, create a virtual placeholder so it's still editable
        const slotId=slot?slot.id:`NEW__${tmpl.room}__${effectiveShift}__${d}`;
        const currentVal=slot?(SW_CHANGES[slot.id]!==undefined?SW_CHANGES[slot.id]:slot.assigned_tech):(SW_CHANGES[slotId]||'');
        const isChanged=SW_CHANGES[slotId]!==undefined;
        const isBad=!currentVal;
        const qual=tmpl.dept||'Support';
        // Support slots: Lexi/Natalie/Tyler first; PET/General: anyone with that qual (incl. support staff if qualified)
        const eligible=qual==='Support'
          ?STAFF.filter(s=>['Lexi (LEX)','Natalie (NAT)','Tyler (TB)'].includes(s.name))
          :STAFF.filter(s=>s.qualifications?.includes(qual));
        const others=STAFF.filter(s=>!eligible.find(e=>e.name===s.name));
        let opts=`<option value="">‚Äî Unassigned ‚Äî</option>`;
        eligible.forEach(s=>{opts+=`<option value="${s.name}"${currentVal===s.name?' selected':''}>${s.name}</option>`;});
        if(others.length){opts+=`<optgroup label="‚ö† Outside quals">`;others.forEach(s=>{opts+=`<option value="${s.name}"${currentVal===s.name?' selected':''}>${s.name}</option>`;});opts+=`</optgroup>`;}
        // Check if currently double-booked ‚Äî only compare against real camera slots (exclude PTO/support/blocked)
        const realSlotsForDupe=SCHEDULE.filter(s=>
          s.shift_date===d && s.id!==slotId && s.assigned_tech &&
          !s._pto && !s._support && !s._blocked && !s._manual
        );
        const isDupe=currentVal&&realSlotsForDupe.some(s=>s.assigned_tech===currentVal);
        rows+=`<td><select class="sw-sel${isBad?' unfilled':''}${isChanged?' sw-changed':''}${isDupe?' sw-dupe':''}" data-id="${slotId}" data-room="${tmpl.room}" data-shift="${effectiveShift}" data-dept="${tmpl.dept||'Support'}" data-date="${d}" onchange="trackWeekChange(this,'${d}')">${opts}</select></td>`;
      });
      rows+='</tr>';
    });
  });

  body.innerHTML=`<div class="sw-wrap"><table class="sw-grid"><thead><tr>${hdrs}</tr></thead><tbody>${rows}</tbody></table></div>`;
}

function trackWeekChange(sel, dateISO){
  const id=sel.dataset.id;
  const val=sel.value||null;
  // Push previous value onto undo stack before applying change
  const slot=SCHEDULE.find(s=>s.id===id);
  const prevVal=SW_CHANGES.hasOwnProperty(id)?SW_CHANGES[id]:(slot?slot.assigned_tech:null);
  SW_UNDO_STACK.push({id, prevVal, sel});
  SW_CHANGES[id]=val;
  sel.classList.add('sw-changed');
  sel.classList.toggle('unfilled',!val);
  sel.classList.remove('sw-dupe');

  // Double-booking check ‚Äî only highlight the two conflicting cells
  // First clear all existing orange on this day
  document.querySelectorAll(`select[data-date="${dateISO}"]`).forEach(s=>s.classList.remove('sw-dupe'));

  if(val){
    const allSelects=Array.from(document.querySelectorAll(`select[data-date="${dateISO}"]`));
    // Only check real camera/dept slots ‚Äî exclude support rows
    const cameraSelects=allSelects.filter(s=>s.dataset.dept!=='Support'||sel.dataset.dept==='Support');
    const conflict=cameraSelects.find(s=>s!==sel&&s.value===val);
    if(conflict){
      sel.classList.add('sw-dupe');
      conflict.classList.add('sw-dupe');
      showDupeWarning(val,dateISO);
    }
  }

  // Show save bar
  const count=Object.keys(SW_CHANGES).length;
  const bar=document.getElementById('sw-save-bar');
  bar.style.display='flex';
  document.getElementById('sw-change-count').textContent=`${count} unsaved change${count!==1?'s':''}`;
  const undoBtn=document.getElementById('sw-undo-btn');
  if(undoBtn){const hasUndo=SW_UNDO_STACK.length>0;undoBtn.disabled=!hasUndo;undoBtn.style.opacity=hasUndo?'1':'0.4';undoBtn.style.cursor=hasUndo?'pointer':'not-allowed';}
}

function setSupportDayShift(room, date, shiftTime){
  // Store per-day shift selection
  SW_SUPPORT_SHIFTS[`${room}__${date}`]=shiftTime;
  // If there's an existing DB record for this day, queue a shift_time update
  const existing=SCHEDULE.find(s=>s.shift_date===date&&s.room===room&&s.department==='Support');
  if(existing){
    // Mark the slot id as needing a shift_time change
    if(!SW_SHIFT_TIME_CHANGES) window.SW_SHIFT_TIME_CHANGES={};
    SW_SHIFT_TIME_CHANGES[existing.id]=shiftTime;
  }
  renderWeekGrid();
}

function undoLastChange(){
  if(!SW_UNDO_STACK.length) return;
  const{id, prevVal}=SW_UNDO_STACK.pop();

  // Restore SW_CHANGES ‚Äî if prevVal was the original DB value, remove from changes
  const slot=SCHEDULE.find(s=>s.id===id);
  const originalVal=slot?slot.assigned_tech:null;
  if(prevVal===originalVal){
    delete SW_CHANGES[id];
  } else {
    SW_CHANGES[id]=prevVal;
  }

  // Update the actual select in the DOM
  const selEl=document.querySelector(`select[data-id="${id}"]`);
  if(selEl){
    selEl.value=prevVal||'';
    selEl.classList.remove('sw-dupe');
    const isChanged=SW_CHANGES.hasOwnProperty(id);
    selEl.classList.toggle('sw-changed', isChanged);
    selEl.classList.toggle('unfilled', !prevVal);
    // Re-run dupe check for this date
    const dateISO=selEl.dataset.date;
    document.querySelectorAll(`select[data-date="${dateISO}"]`).forEach(s=>s.classList.remove('sw-dupe'));
    if(prevVal){
      const allSelects=Array.from(document.querySelectorAll(`select[data-date="${dateISO}"]`));
      const conflict=allSelects.find(s=>s!==selEl&&s.value===prevVal);
      if(conflict){selEl.classList.add('sw-dupe');conflict.classList.add('sw-dupe');}
    }
  }

  // Update save bar
  const count=Object.keys(SW_CHANGES).length;
  const undoBtn=document.getElementById('sw-undo-btn');
  const hasUndo=SW_UNDO_STACK.length>0;
  if(undoBtn){undoBtn.disabled=!hasUndo;undoBtn.style.opacity=hasUndo?'1':'0.4';undoBtn.style.cursor=hasUndo?'pointer':'not-allowed';}
  if(count===0){
    document.getElementById('sw-save-bar').style.display='none';
  } else {
    document.getElementById('sw-change-count').textContent=`${count} unsaved change${count!==1?'s':''}`;
  }
}

async function saveWeekChanges(){
  const entries=Object.entries(SW_CHANGES);
  if(!entries.length&&!Object.keys(window.SW_SHIFT_TIME_CHANGES||{}).length) return;
  let errors=0;

  // Save shift_time changes for support rows
  for(const[id,shiftTime] of Object.entries(window.SW_SHIFT_TIME_CHANGES||{})){
    const{error}=await sb.from('schedule').update({shift_time:shiftTime}).eq('id',id);
    if(error) errors++;
  }

  for(const[id,val] of entries){
    if(!val) continue;
    if(id.startsWith('NEW__')){
      const parts=id.split('__');
      const room=parts[1];
      const shift=parts[2];
      const date=parts[3];
      const tmpl=TEMPLATE.find(t=>t.room===room);
      const dept=tmpl?tmpl.dept:'Support';
      // For support rows use the per-day selected shift time; fall back to template shift
      const effectiveShift=tmpl&&tmpl.support?(SW_SUPPORT_SHIFTS[`${room}__${date}`]||shift):shift;
      if(tmpl&&tmpl.support&&!effectiveShift){
        toast('Please select a shift time for '+room+' on '+date,'err');
        errors++;continue;
      }
      const{error}=await sb.from('schedule').insert({
        shift_date:date,department:dept,room,shift_time:effectiveShift,assigned_tech:val,notes:null
      });
      if(error) errors++;
    } else {
      const{error}=await sb.from('schedule').update({assigned_tech:val}).eq('id',id);
      if(error) errors++;
    }
  }
  if(errors){toast(`${errors} saves failed`,'err');return;}
  toast(`‚úì Changes republished`,'ok');
  SW_CHANGES={};window.SW_SHIFT_TIME_CHANGES={};
  SW_EDIT=false;
  document.getElementById('sw-save-bar').style.display='none';
  document.getElementById('sw-edit-banner').style.display='none';
  document.getElementById('sw-edit-btn').innerHTML='‚úè Edit Week';
  document.getElementById('sw-edit-btn').style.cssText='background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)';
  await loadAll();
}

function discardWeekChanges(){
  SW_CHANGES={};
  SW_UNDO_STACK=[];
  SW_SUPPORT_SHIFTS={};
  window.SW_SHIFT_TIME_CHANGES={};
  document.getElementById('sw-save-bar').style.display='none';
  renderWeekGrid();
}

async function deletePublishedWeek(){
  if(!SW_WEEK) return;
  const fri=new Date(SW_WEEK+'T12:00:00');fri.setDate(fri.getDate()+4);
  const friISO=fri.toISOString().split('T')[0];
  const count=SCHEDULE.filter(s=>s.shift_date>=SW_WEEK&&s.shift_date<=friISO).length;
  if(!confirm(`Delete all ${count} shifts for this week? This cannot be undone.`)) return;
  const{error}=await sb.from('schedule').delete().gte('shift_date',SW_WEEK).lte('shift_date',friISO);
  if(error){toast('Delete failed: '+error.message,'err');return;}
  toast('Week deleted ‚úì','ok');
  SW_WEEK=null;SW_CHANGES={};
  document.getElementById('sw-delete-btn').style.display='none';
  document.getElementById('sw-week-badge').style.display='none';
  document.getElementById('sw-stats').style.display='none';
  document.getElementById('sw-save-bar').style.display='none';
  await loadAll();
}


</script>


<style>
:root {
  --bg:#0a0e14;--surface:#131920;--surface2:#1a2332;--surface3:#1f2d40;--border:#263040;--border2:#2d3a4a;
  --accent:#00d4aa;--adim:rgba(0,212,170,0.12);--aborder:rgba(0,212,170,0.3);
  --pet:#7c6ff7;--general:#10b981;--thera:#f59e0b;--support:#ec4899;
  --text:#dce8f5;--text2:#7a90a8;--text3:#4a5a6a;--pto:#f97316;--danger:#f85149;--success:#3fb950;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
.login-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:40px;width:100%;max-width:400px;text-align:center;}
.login-logo{font-family:'Space Mono',monospace;font-size:28px;font-weight:700;color:var(--accent);margin-bottom:8px;}
.login-sub{font-size:13px;color:var(--text2);margin-bottom:32px;}
.login-badge{display:inline-block;font-size:11px;font-weight:600;background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3);padding:3px 10px;border-radius:20px;margin-bottom:24px;}
.fi{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:12px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.15s;margin-bottom:12px;}
.fi:focus{border-color:var(--accent);}
.btn-login{width:100%;background:var(--accent);color:#000;border:none;border-radius:10px;padding:13px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity 0.15s;margin-top:4px;}
.btn-login:hover{opacity:0.85;}
.login-err{font-size:12px;color:var(--danger);margin-top:12px;display:none;}
.app-wrap{display:none;}
header{background:rgba(10,14,20,0.97);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;gap:20px;height:58px;position:sticky;top:0;z-index:200;}
.logo{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);letter-spacing:0.06em;}
.admin-badge{font-size:10px;font-weight:700;background:rgba(248,81,73,0.15);color:var(--danger);border:1px solid rgba(248,81,73,0.3);padding:2px 8px;border-radius:20px;letter-spacing:0.06em;}
nav{display:flex;gap:2px;flex:1;}
.nav-btn{background:none;border:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;padding:7px 16px;border-radius:8px;cursor:pointer;transition:all 0.15s;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:var(--surface2);color:var(--accent);}
.nav-btn.gen-nav{color:var(--accent);border:1px solid var(--aborder);}
.nav-btn.gen-nav.active{background:var(--adim);}
.user-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:12px;color:var(--text2);}
.btn-signout{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;transition:color 0.15s;}
.btn-signout:hover{color:var(--danger);}
main{padding:28px;max-width:1440px;margin:0 auto;}
.page{display:none;animation:fi 0.2s ease;}.page.active{display:block;}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;gap:16px;flex-wrap:wrap;}
.page-title{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;}
.page-sub{font-size:13px;color:var(--text2);margin-top:4px;}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.fsel,.si{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.si{width:210px;}.si:focus,.fsel:focus{border-color:var(--accent);}
.btn{border:none;border-radius:8px;padding:8px 18px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.btn-p{background:var(--accent);color:#000;}.btn-p:hover{opacity:0.85;}
.btn-g{background:var(--surface2);color:var(--text);border:1px solid var(--border);}.btn-g:hover{border-color:var(--accent);color:var(--accent);}
.btn-d{background:rgba(248,81,73,0.12);color:var(--danger);border:1px solid rgba(248,81,73,0.3);}.btn-d:hover{background:rgba(248,81,73,0.22);}
.btn-warn{background:rgba(245,158,11,0.12);color:var(--thera);border:1px solid rgba(245,158,11,0.3);}
.btn-icon{padding:6px 10px;font-size:14px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:6px;cursor:pointer;transition:all 0.15s;}
.btn-icon:hover{color:var(--accent);border-color:var(--accent);}
.dept-pill{display:inline-block;font-size:11px;font-weight:600;padding:2px 9px;border-radius:20px;text-transform:uppercase;}
.dp-PET{background:rgba(124,111,247,0.15);color:#9d93ff;border:1px solid rgba(124,111,247,0.3);}
.dp-General{background:rgba(16,185,129,0.15);color:#34d399;border:1px solid rgba(16,185,129,0.3);}
.dp-Theranostics{background:rgba(245,158,11,0.15);color:#fbbf24;border:1px solid rgba(245,158,11,0.3);}
.dp-Support{background:rgba(236,72,153,0.15);color:#f472b6;border:1px solid rgba(236,72,153,0.3);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;}
.card-title{font-size:13px;font-weight:600;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}@media(max-width:600px){.g2,.g4{grid-template-columns:1fr}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc-pet::after{background:var(--pet)}.sc-gen::after{background:var(--general)}.sc-thera::after{background:var(--thera)}.sc-sup::after{background:var(--support)}
.stat-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;}
.stat-val{font-family:'Space Mono',monospace;font-size:34px;font-weight:700;margin:8px 0 4px;}
.stat-sub{font-size:12px;color:var(--text2);}
.dt{width:100%;border-collapse:collapse;}
.dt th{background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);}
.dt td{padding:10px 16px;border-bottom:1px solid rgba(38,48,64,0.6);font-size:13px;vertical-align:middle;}
.dt tr:last-child td{border-bottom:none;}
.dt tbody tr:hover td{background:rgba(255,255,255,0.015);}
.ea{display:flex;gap:6px;opacity:0;transition:opacity 0.15s;}
.dt tbody tr:hover .ea{opacity:1;}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:500;white-space:nowrap;}
.av{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#fff;flex-shrink:0;}
.avl{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.sb{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);background:rgba(0,212,170,0.08);padding:2px 8px;border-radius:4px;border:1px solid rgba(0,212,170,0.2);white-space:nowrap;}
.rb{font-size:11px;font-weight:600;color:var(--text2);background:var(--bg);border:1px solid var(--border);padding:2px 8px;border-radius:4px;white-space:nowrap;}
.ib{font-size:11px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:3px 9px;border-radius:20px;}
.ib-g{background:rgba(16,185,129,0.1);color:#34d399;border-color:rgba(16,185,129,0.3);}
.ib-a{background:rgba(245,158,11,0.1);color:#fbbf24;border-color:rgba(245,158,11,0.3);}
.ib-r{background:rgba(248,81,73,0.1);color:var(--danger);border-color:rgba(248,81,73,0.3);}
.sd{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text3);display:flex;align-items:center;gap:12px;margin:24px 0 14px;}
.sd::after{content:'';flex:1;height:1px;background:var(--border);}
.mg{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:20px;}
.mc{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.mch{background:var(--surface2);padding:12px 16px;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;letter-spacing:0.12em;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.cg{display:grid;grid-template-columns:repeat(7,1fr);}
.cdh{text-align:center;font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;padding:7px 2px 5px;background:var(--surface2);}
.cd{text-align:center;padding:5px 2px;border:1px solid rgba(38,48,64,0.4);min-height:48px;cursor:pointer;transition:background 0.1s;}
.cd:not(.we):hover{background:var(--surface3);}
.cd.hp{background:rgba(249,115,22,0.06);}
.dn{font-family:'Space Mono',monospace;font-size:10px;color:var(--text2);display:block;}
.cd.we .dn{color:var(--text3);}
.pt{display:flex;flex-wrap:wrap;gap:1px;justify-content:center;margin-top:2px;}
.ptag{font-size:7px;font-weight:700;background:rgba(249,115,22,0.2);color:var(--pto);border:1px solid rgba(249,115,22,0.3);padding:1px 3px;border-radius:2px;cursor:pointer;}
.ptag:hover{background:rgba(249,115,22,0.4);}
.add-hint{font-size:8px;color:var(--text3);margin-top:2px;display:none;}
.cd:not(.we):hover .add-hint{display:block;}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:16px;}
.sc2{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;gap:14px;align-items:flex-start;transition:border-color 0.15s;position:relative;}
.sc2:hover{border-color:var(--aborder);}
.sca{position:absolute;top:12px;right:12px;display:flex;gap:6px;opacity:0;transition:opacity 0.15s;}
.sc2:hover .sca{opacity:1;}
.sn{font-size:14px;font-weight:600;}
.sm{font-size:11px;color:var(--text2);margin:4px 0 8px;line-height:1.5;}
.sq{display:flex;gap:6px;flex-wrap:wrap;}
.sp{margin-top:8px;font-size:11px;color:var(--text2);}
.spl{font-size:10px;font-weight:600;color:var(--pto);text-transform:uppercase;letter-spacing:0.08em;}

/* GENERATOR STYLES */
.gen-setup{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;margin-bottom:24px;}
.gen-setup-title{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);margin-bottom:20px;}
.week-picker{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap;}
.draft-banner{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px;flex-wrap:wrap;}
.draft-banner-text{font-size:13px;color:var(--thera);font-weight:600;}
.draft-banner-sub{font-size:12px;color:var(--text2);margin-top:2px;}
.alert-row{background:rgba(248,81,73,0.06);border:1px solid rgba(248,81,73,0.2);border-radius:8px;padding:10px 16px;display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px;color:var(--danger);}
.gen-day-section{margin-bottom:20px;}
.gen-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.gen-day-title{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;}
.sched-grid{width:100%;border-collapse:collapse;min-width:860px;}
.sched-grid th{background:var(--surface2);padding:10px 14px;text-align:left;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.07em;border-bottom:2px solid var(--border);white-space:nowrap;}
.sched-grid th.day-th{color:var(--accent);font-family:'Space Mono',monospace;font-size:10px;text-align:center;min-width:155px;}
.sched-grid td{padding:7px 12px;border-bottom:1px solid rgba(38,48,64,0.45);vertical-align:middle;}
.sched-grid tbody tr:last-child td{border-bottom:none;}
.sched-grid tbody tr:hover td{background:rgba(255,255,255,0.012);}
.sched-grid .section-row td{background:var(--surface2);padding:5px 14px;}
.sched-grid .section-row td span{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);}
.room-cell{display:flex;flex-direction:column;gap:2px;}
.room-cell-name{font-size:12px;font-weight:600;color:var(--text);}
.room-cell-shift{font-family:'Space Mono',monospace;font-size:9px;color:var(--accent);}
.grid-sel{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:11px;outline:none;cursor:pointer;}
.grid-sel:focus{border-color:var(--accent);}
.grid-sel.unfilled{border-color:var(--danger);color:var(--danger);}
.manual-tag{font-size:10px;font-weight:600;background:rgba(236,72,153,0.1);color:#f472b6;border:1px solid rgba(236,72,153,0.3);padding:2px 7px;border-radius:20px;}
.sched-grid .pto-row td{background:rgba(248,81,73,0.04);}
.sched-grid .section-row.pto-section td{background:rgba(248,81,73,0.08);}
.sched-grid .section-row.pto-section td span{color:var(--danger);}
.grid-sel.double-booked{border-color:#f97316 !important;background:rgba(249,115,22,0.12) !important;color:#fb923c !important;animation:pulse-orange 1s ease 3;}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 0 0 rgba(249,115,22,0.4)}50%{box-shadow:0 0 0 4px rgba(249,115,22,0.2)}}
.dupe-warning{position:fixed;bottom:70px;right:24px;background:#1c1a14;border:1px solid #f97316;border-radius:10px;padding:10px 16px;font-size:12px;color:#fb923c;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;max-width:320px;}
.dupe-warning.show{transform:translateY(0);opacity:1;}
.gen-grid-wrap{overflow-x:auto;}

/* CALENDAR PICKER */
.cal-wrap{position:relative;display:inline-block;}
.cal-trigger{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;color:var(--text);font-family:"DM Sans",sans-serif;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:10px;min-width:260px;transition:border-color 0.15s;user-select:none;}
.cal-trigger:hover,.cal-trigger.open{border-color:var(--accent);}
.cal-trigger-text{flex:1;}
.cal-trigger-arrow{color:var(--text3);font-size:11px;transition:transform 0.15s;}
.cal-trigger.open .cal-trigger-arrow{transform:rotate(180deg);}
.cal-dropdown{position:absolute;top:calc(100% + 8px);left:0;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:20px;z-index:400;width:322px;box-shadow:0 20px 60px rgba(0,0,0,0.6);display:none;}
.cal-dropdown.open{display:block;animation:mi 0.15s ease;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-nav-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:8px;width:34px;height:34px;cursor:pointer;font-size:18px;transition:all 0.15s;display:flex;align-items:center;justify-content:center;line-height:1;}
.cal-nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.cal-month-label{font-family:"Space Mono",monospace;font-size:13px;font-weight:700;color:var(--text);}
.cal-full-grid{display:block;width:100%;}
.cal-dh{text-align:center;font-size:10px;font-weight:700;padding:0 0 10px;text-transform:uppercase;color:var(--text3);letter-spacing:0.06em;min-width:0;}
.cal-dh.hl{color:var(--accent);}
.cal-day{text-align:center;border-radius:8px;font-size:13px;color:var(--text3);height:38px;display:flex;align-items:center;justify-content:center;position:relative;transition:all 0.1s;}
.cal-day.monday{color:var(--text);cursor:pointer;font-weight:700;background:rgba(0,212,170,0.08);outline:1px solid rgba(0,212,170,0.18);}
.cal-day.monday:hover{background:rgba(0,212,170,0.22);outline-color:var(--accent);color:var(--accent);transform:scale(1.06);}
.cal-day.monday.selected{background:var(--accent) !important;color:#000 !important;outline-color:var(--accent);}
.cal-day.is-today:not(.monday){outline:1px solid var(--text3);color:var(--text);}
.cal-day.is-today.monday{outline:2px solid var(--accent);}
.cal-day.has-sched::after{content:"";position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--pet);}
.cal-day.monday.selected::after{background:#000;}
.cal-day.has-block{outline:2px solid #eab308 !important;box-shadow:0 0 0 1px rgba(234,179,8,0.25);}
/* Schedule calendar ‚Äî full week rows selectable */
.sw-week-row{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-radius:6px;overflow:hidden;margin-bottom:3px;cursor:default;width:100%;}
.sw-cal-day{text-align:center;font-size:12px;height:34px;min-width:0;display:flex;align-items:center;justify-content:center;position:relative;color:var(--text3);transition:background 0.1s;}
.sw-week-published{cursor:pointer;}
.sw-week-published .sw-cal-day{color:var(--text);background:rgba(0,212,170,0.07);border-top:1px solid rgba(0,212,170,0.12);border-bottom:1px solid rgba(0,212,170,0.12);}
.sw-week-published .sw-cal-day:first-child{border-left:1px solid rgba(0,212,170,0.12);border-radius:6px 0 0 6px;}
.sw-week-published .sw-cal-day:last-child{border-right:1px solid rgba(0,212,170,0.12);border-radius:0 6px 6px 0;}
.sw-week-published:hover .sw-cal-day{background:rgba(0,212,170,0.18);}
.sw-week-published.sw-week-selected .sw-cal-day{background:var(--accent)!important;color:#000!important;font-weight:700;}
.sw-pub-dot{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--pet);}
.sw-week-selected .sw-pub-dot{background:#000;}
.sw-week-empty{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:3px;width:100%;}
/* Read-only cell styles */
.sw-cell-ro{padding:7px 10px;font-size:12px;color:var(--text);}
.sw-cell-empty{padding:7px 10px;font-size:11px;color:var(--text3);text-align:center;}
.sw-cell-unassigned{padding:7px 10px;font-size:11px;color:var(--danger);text-align:center;background:rgba(248,81,73,0.05);}
.cal-day.monday.has-block:hover{outline:2px solid #facc15 !important;}
.cal-day.selected.has-block{outline:2px solid #eab308 !important;}
.cal-footer{display:flex;align-items:center;gap:14px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);font-size:10px;color:var(--text2);}
.cal-footer-item{display:flex;align-items:center;gap:5px;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.6);animation:mi 0.2s ease;}
@keyframes mi{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal-title{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.modal-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px;line-height:1;}
.modal-close:hover{color:var(--text);}
.fg{margin-bottom:16px;}
.fg label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;}
.mfi{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.mfi:focus{border-color:var(--accent);}
.fr{display:flex;gap:12px;}.fr .fg{flex:1;}
.ma{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(63,185,80,0.4);color:var(--success);}
.toast.err{border-color:rgba(248,81,73,0.4);color:var(--danger);}
.toast.warn{border-color:rgba(245,158,11,0.4);color:var(--thera);}
mark{background:rgba(0,212,170,0.15);color:var(--accent);border-radius:2px;}
/* EQUIPMENT */
.eq-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px;}
.eq-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;position:relative;}
.eq-card.blocked{border-color:rgba(249,115,22,0.4);background:rgba(249,115,22,0.04);}
.eq-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.eq-name{font-size:14px;font-weight:700;}
.eq-dept{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text2);}
.eq-status{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;}
.eq-status.active{color:var(--success);}
.eq-status.blocked{color:#fb923c;}
.eq-blockouts{margin-top:10px;}
.eq-blockout-row{display:flex;align-items:center;justify-content:space-between;background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.2);border-radius:6px;padding:6px 10px;font-size:11px;margin-bottom:6px;}
.eq-blockout-reason{color:#fb923c;font-weight:600;}
.eq-blockout-dates{color:var(--text2);font-family:'Space Mono',monospace;font-size:10px;}
.eq-actions{display:flex;gap:6px;margin-top:12px;}
.btn-sm{border:none;border-radius:6px;padding:5px 12px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.btn-sm-o{background:rgba(249,115,22,0.1);color:#fb923c;border:1px solid rgba(249,115,22,0.3);}
.btn-sm-o:hover{background:rgba(249,115,22,0.2);}
.btn-sm-d{background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3);}
.btn-sm-d:hover{background:rgba(248,81,73,0.2);}
.btn-sm-g{background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.3);}
.btn-sm-g:hover{background:rgba(0,212,170,0.2);}
.section-divider{border:none;border-top:1px solid var(--border);margin:32px 0 24px;}
/* SCHEDULE WEEK VIEW */
.sw-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;position:relative;z-index:1;}
.role-chip{border:1px solid var(--border2);background:var(--surface);color:var(--text2);border-radius:20px;padding:5px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.role-chip[data-role="Chief Technologist"].active{background:rgba(234,179,8,0.15);border-color:#eab308;color:#eab308;}
.role-chip[data-role="Lead Technologist"].active{background:rgba(124,111,247,0.15);border-color:var(--pet);color:var(--pet);}
.day-chip,.qual-chip{border:1px solid var(--border2);background:var(--surface);color:var(--text2);border-radius:20px;padding:5px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.fair-fp{border:1px solid;background:transparent;border-radius:20px;padding:3px 12px;font-size:10px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;letter-spacing:0.04em;transition:all 0.15s;}
.day-chip.active{background:rgba(0,212,170,0.15);border-color:var(--accent);color:var(--accent);}
.qual-chip[data-qual="PET"].active{background:rgba(124,111,247,0.15);border-color:var(--pet);color:var(--pet);}
.qual-chip[data-qual="General"].active{background:rgba(16,185,129,0.15);border-color:var(--general);color:var(--general);}
.qual-chip[data-qual="Theranostics"].active{background:rgba(245,158,11,0.15);border-color:var(--thera);color:var(--thera);}
.qual-chip[data-qual="Support"].active{background:rgba(236,72,153,0.15);border-color:var(--support);color:var(--support);}
.pto-tag{display:inline-flex;align-items:center;gap:4px;background:rgba(249,115,22,0.12);border:1px solid rgba(249,115,22,0.3);color:var(--pto);border-radius:20px;padding:2px 8px;font-size:11px;font-weight:600;}
.pto-tag button{background:none;border:none;color:var(--pto);cursor:pointer;padding:0;font-size:12px;line-height:1;}
.st-cal-day{height:28px;display:flex;align-items:center;justify-content:center;font-size:11px;border-radius:4px;cursor:pointer;color:var(--text2);transition:background 0.1s;}
.st-cal-day:hover{background:var(--surface3);}
.st-cal-day.pto-selected{background:rgba(249,115,22,0.2);color:var(--pto);font-weight:700;}
.st-cal-day.we{color:var(--text3);cursor:default;}
.sw-grid{width:100%;border-collapse:collapse;font-size:12px;}
.sw-grid th{background:var(--surface2);border:1px solid var(--border);padding:9px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text2);white-space:nowrap;position:sticky;top:0;z-index:2;}
.sw-grid th.sw-day-col{text-align:center;min-width:155px;}
.sw-grid td{border:1px solid var(--border);padding:0;vertical-align:middle;}
.sw-room-col{background:var(--surface);padding:8px 14px;min-width:145px;position:sticky;left:0;z-index:1;border-right:2px solid var(--border2);}
.sw-room-name{font-weight:700;font-size:12px;}
.sw-room-shift{font-size:10px;color:var(--text2);margin-top:2px;font-family:'Space Mono',monospace;}
.sw-section-hd td{background:var(--surface2);padding:7px 14px;font-weight:700;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;border-bottom:1px solid var(--border2);}
.sw-dept-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;}
.sw-day-hd{text-align:center;}
.sw-day-name{font-size:11px;font-weight:700;color:var(--text);}
.sw-day-date{font-size:10px;color:var(--text2);margin:2px 0;}
.sw-day-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;display:inline-block;margin-top:2px;}
.sw-day-ok{background:rgba(63,185,80,0.1);color:var(--success);}
.sw-day-warn{background:rgba(248,81,73,0.1);color:var(--danger);}
.sw-sel{width:100%;background:transparent;border:none;padding:7px 10px;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none;transition:background 0.1s;}
.sw-sel:hover,.sw-sel:focus{background:var(--surface2);}
.sw-sel.unfilled{background:rgba(248,81,73,0.08);color:var(--danger);}
.sw-sel.sw-changed{background:rgba(0,212,170,0.06);border-left:3px solid var(--accent);}
.sw-sel.sw-dupe{border-left:3px solid #f97316 !important;background:rgba(249,115,22,0.1) !important;animation:pulse-orange 1.2s ease-in-out infinite;}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 0 0 rgba(249,115,22,0.4)}50%{box-shadow:0 0 0 4px rgba(249,115,22,0)}}
.sw-sel.double-booked-sw{border-left:3px solid #f97316 !important;background:rgba(249,115,22,0.1) !important;}
.sw-blocked-cell{text-align:center;padding:7px;font-size:10px;font-weight:600;color:#fb923c;background:rgba(249,115,22,0.06);}
.sw-pto-cell{text-align:center;padding:5px;}
.sw-pto-name{display:inline-block;background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.2);border-radius:4px;padding:2px 7px;font-size:10px;color:var(--danger);margin:1px;}
.sw-stat{display:flex;flex-direction:column;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 16px;min-width:100px;}
.sw-stat-val{font-size:20px;font-weight:700;font-family:'Space Mono',monospace;}
.sw-stat-lbl{font-size:10px;color:var(--text2);font-weight:500;margin-top:2px;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-past{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}
.badge-current{background:rgba(0,212,170,0.12);color:var(--accent);border:1px solid rgba(0,212,170,0.3);}
.badge-future{background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3);}
/* BLOCKOUT CALENDAR PICKERS */
.bo-cal-wrap{position:relative;}
.bo-cal-trigger{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;cursor:pointer;font-size:13px;transition:border-color 0.15s;}
.bo-cal-trigger:hover{border-color:var(--accent);}
.bo-cal-trigger-text{flex:1;color:var(--text);}
.bo-cal-dropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:14px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.bo-cal-dropdown.open{display:block;}
.bo-day{position:relative;aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:12px;cursor:default;color:var(--text2);}
.bo-day.selectable{cursor:pointer;color:var(--text);background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);}
.bo-day.selectable:hover{background:rgba(0,212,170,0.18);border-color:var(--accent);}
.bo-day.selected{background:var(--accent)!important;color:#000!important;font-weight:700;border-color:var(--accent)!important;}
.bo-day.in-range{background:rgba(0,212,170,0.12);border-color:rgba(0,212,170,0.2);color:var(--text);}
.bo-day.range-start{background:var(--accent);color:#000;font-weight:700;border-radius:6px 0 0 6px;}
.bo-day.range-end{background:var(--accent);color:#000;font-weight:700;border-radius:0 6px 6px 0;}
.bo-day.monday-only{cursor:pointer;color:var(--text);background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);}
.bo-day.monday-only:hover{background:rgba(0,212,170,0.18);}
.bo-day.today-bo{outline:2px solid var(--accent);outline-offset:1px;}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div class="login-wrap" id="login-wrap">
  <div class="login-box">
    <div class="login-logo">‚ò¢ NUCMED</div>
    <div class="login-sub">Staff Scheduling System</div>
    <div class="login-badge">ADMIN ACCESS</div>
    <input type="email" class="fi" id="login-email" placeholder="Email address" />
    <input type="password" class="fi" id="login-pass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()" />
    <button class="btn-login" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- APP -->
<div class="app-wrap" id="app-wrap">
<header>
  <div class="logo">‚ò¢ NUCMED</div>
  <span class="admin-badge">ADMIN</span>
  <nav>
    <button class="nav-btn active" onclick="goTo('dashboard',this)">Dashboard</button>
    <button class="nav-btn" onclick="goTo('schedule',this)">Schedule</button>
    <button class="nav-btn gen-nav" onclick="goTo('generator',this)">‚ö° Generate Week</button>
    <button class="nav-btn" onclick="goTo('pto',this)">PTO Calendar</button>
    <button class="nav-btn" onclick="goTo('staff',this)">Staff Roster</button>
    <button class="nav-btn" id="admin-swaps-nav" onclick="goTo('swaps',this)">üîÑ Swap Requests</button>
  </nav>
  <div class="user-pill">
    <span id="user-email">‚Äî</span>
    <button class="btn-signout" onclick="doSignOut()">Sign out</button>
  </div>
</header>

<main>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <div><div class="page-title">Admin Dashboard</div><div class="page-sub" id="dash-sub">‚Äî</div></div>
    <button class="btn btn-p" onclick="goTo('generator',document.querySelectorAll('.nav-btn')[2])">‚ö° Generate Next Week</button>
  </div>
  <div class="g4" style="margin-bottom:24px" id="stats"></div>
  <!-- Today + compact PTO -->
  <div class="g2" style="margin-bottom:20px">
    <div class="card">
      <div class="card-header"><div class="card-title" id="today-ttl">Today</div><span class="ib ib-g" id="today-cnt"></span></div>
      <div style="overflow-x:auto"><table class="dt" id="today-tbl"></table></div>
    </div>
    <div class="card" style="max-height:320px;overflow:hidden;display:flex;flex-direction:column">
      <div class="card-header" style="flex-shrink:0"><div class="card-title">Upcoming PTO</div><span class="ib ib-a">30 days</span></div>
      <div style="overflow-y:auto;padding:4px 16px 12px" id="pto-up"></div>
    </div>
  </div>

  <!-- Fairness Chart full width -->
  <div class="card">
    <div class="card-header" style="flex-wrap:wrap;gap:10px">
      <div>
        <div class="card-title">&#9878; Shift Fairness</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px" id="fair-sub"></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-left:auto">
        <div style="display:flex;align-items:center;gap:7px;cursor:pointer;user-select:none" onclick="toggleFairFuture()">
          <div id="fair-tog-track" style="width:34px;height:18px;background:var(--surface2);border:1px solid var(--border2);border-radius:20px;position:relative;transition:all 0.2s;flex-shrink:0"><div id="fair-tog-thumb" style="position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--text3);transition:all 0.2s"></div></div>
          <span id="fair-tog-lbl" style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.04em">Future shifts</span>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap" id="fair-filters"></div>
      </div>
    </div>
    <div style="padding:0 4px 4px">
      <div style="display:flex;flex-wrap:wrap;gap:3px 10px;margin-bottom:14px;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px" id="fair-legend"></div>
      <div id="fair-chart" style="display:flex;flex-direction:column;gap:7px"></div>
      <div id="fair-xrow" style="display:flex;margin-left:110px;padding-right:46px;justify-content:space-between;margin-top:6px;border-top:1px solid var(--border);padding-top:4px"></div>
    </div>
  </div>
</div>
<div id="fair-tip" style="position:fixed;background:#1c2333;border:1px solid var(--border2);border-radius:10px;padding:10px 14px;pointer-events:none;z-index:999;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.8);min-width:210px;font-family:'DM Sans',sans-serif;font-size:11px;color:var(--text2)"></div>

<!-- SCHEDULE -->
<div class="page" id="page-schedule">
  <div class="page-header">
    <div>
      <div class="page-title">Published Schedules</div>
      <div class="page-sub" id="sched-sub">Select a week to view</div>
    </div>
    <div class="controls">
      <span id="sw-week-badge" style="display:none" class="badge"></span>
      <button class="btn" id="sw-edit-btn" style="display:none;background:rgba(124,111,247,0.12);color:var(--pet);border:1px solid rgba(124,111,247,0.3)" onclick="toggleSwEdit()">‚úè Edit Week</button>
      <button class="btn btn-s" id="sw-delete-btn" style="display:none;background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.3)" onclick="deletePublishedWeek()">üóë Delete Week</button>
    </div>
  </div>

  <!-- CALENDAR WEEK PICKER -->
  <div style="margin-bottom:20px">
    <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px">Select Week</label>
    <div class="cal-wrap" id="sw-cal-wrap">
      <div class="cal-trigger" id="sw-cal-trigger" onclick="toggleSwCal()">
        <span>üìÖ</span>
        <span class="cal-trigger-text" id="sw-cal-trigger-text">Pick a published week‚Ä¶</span>
        <span class="cal-trigger-arrow">‚ñº</span>
      </div>
      <div class="cal-dropdown" id="sw-cal-dropdown">
        <div class="cal-nav">
          <button class="cal-nav-btn" onclick="swCalNav(-1)">‚Äπ</button>
          <span class="cal-month-label" id="sw-cal-month-label"></span>
          <button class="cal-nav-btn" onclick="swCalNav(1)">‚Ä∫</button>
        </div>
        <div class="cal-full-grid" id="sw-cal-grid"></div>
        <div class="cal-footer">
          <div class="cal-footer-item"><div style="width:6px;height:6px;border-radius:50%;background:var(--pet)"></div>Published week</div>
          <div class="cal-footer-item"><div style="width:28px;height:12px;border-radius:3px;background:var(--accent);opacity:0.8"></div>Selected</div>
        </div>
      </div>
    </div>
    <input type="hidden" id="sw-week-sel" />
  </div>

  <!-- EDIT MODE BANNER -->
  <div id="sw-edit-banner" style="display:none;align-items:center;gap:12px;background:rgba(124,111,247,0.08);border:1px solid rgba(124,111,247,0.25);border-radius:10px;padding:10px 16px;margin-bottom:16px;font-size:12px;color:var(--pet)">
    ‚úè <strong>Edit Mode</strong> ‚Äî Changes save directly to the published schedule.
    <button class="btn btn-s" style="margin-left:auto;font-size:11px;padding:5px 12px" onclick="toggleSwEdit()">Cancel</button>
  </div>

  <!-- STATS -->
  <div id="sw-stats" style="display:none;gap:10px;flex-wrap:wrap;margin-bottom:20px"></div>

  <!-- GRID -->
  <div id="sched-body"></div>

  <!-- SAVE BAR -->
  <div id="sw-save-bar" style="display:none;position:sticky;bottom:20px;z-index:50;justify-content:flex-end;align-items:center;gap:10px;padding:12px 20px;background:var(--surface);border:1px solid var(--border2);border-radius:14px;margin-top:8px;box-shadow:0 8px 40px rgba(0,0,0,0.6)">
    <span id="sw-change-count" style="font-size:12px;color:var(--text2);flex:1"></span>
    <button class="btn btn-s" id="sw-undo-btn" onclick="undoLastChange()" disabled style="opacity:0.35;cursor:not-allowed;border:1px solid var(--border2)" title="Undo last change">‚Ü© Undo</button>
    <button class="btn btn-s" onclick="discardWeekChanges()" style="color:var(--danger);border-color:rgba(248,81,73,0.3)">‚úï Discard All</button>
    <button class="btn btn-p" onclick="saveWeekChanges()">üíæ Republish Changes</button>
  </div>
</div>

<!-- SWAP APPROVAL PAGE -->
<div class="page" id="page-swaps">
  <div class="page-header">
    <div>
      <div class="page-title">üîÑ Swap Requests</div>
      <div class="page-sub" id="swaps-admin-sub">Loading‚Ä¶</div>
    </div>
    <div class="controls">
      <select class="fsel" id="swaps-admin-filter" onchange="renderAdminSwaps()">
        <option value="all">All Requests</option>
        <option value="pending">Pending Approval</option>
        <option value="open">Open</option>
        <option value="approved">Approved</option>
        <option value="denied">Denied</option>
      </select>
    </div>
  </div>
  <div id="admin-swaps-body"></div>
</div>

<!-- GENERATOR -->
<div class="page" id="page-generator">
  <div class="page-header">
    <div><div class="page-title">‚ö° Schedule Generator</div><div class="page-sub">Generate a draft week, review every slot, then publish live</div></div>
  </div>

  <div class="gen-setup">
    <div class="gen-setup-title">üìÖ Select the week to schedule ‚Äî only Mondays are selectable</div>
    <div class="week-picker">
      <div>
        <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px;">Week Starting (Monday)</label>
        <div class="cal-wrap" id="cal-wrap">
          <div class="cal-trigger" id="cal-trigger" onclick="toggleCal()">
            <span>üìÖ</span>
            <span class="cal-trigger-text" id="cal-trigger-text">Pick a Monday‚Ä¶</span>
            <span class="cal-trigger-arrow">‚ñº</span>
          </div>
          <div class="cal-dropdown" id="cal-dropdown">
            <div class="cal-nav">
              <button class="cal-nav-btn" onclick="calNav(-1)">‚Äπ</button>
              <span class="cal-month-label" id="cal-month-label"></span>
              <button class="cal-nav-btn" onclick="calNav(1)">‚Ä∫</button>
            </div>
            <div class="cal-full-grid" id="cal-full-grid"></div>
            <div class="cal-footer">
              <div class="cal-footer-item"><div style="width:12px;height:12px;border-radius:3px;background:rgba(0,212,170,0.12);outline:1px solid rgba(0,212,170,0.3)"></div> Selectable Monday</div>
              <div class="cal-footer-item"><div style="width:6px;height:6px;border-radius:50%;background:var(--pet)"></div> Scheduled</div>
              <div class="cal-footer-item"><div style="width:12px;height:12px;border-radius:3px;outline:2px solid #eab308;background:transparent"></div> Camera blocked</div>
            </div>
          </div>
        </div>
        <input type="hidden" id="gen-week-start" />
      </div>
      <button class="btn btn-p" style="height:42px;align-self:flex-end" onclick="generateDraft()">‚ö° Generate Draft</button>
    </div>

    <!-- Fairness toggle -->
    <div style="margin-top:16px;padding:14px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px">Exclude approved swaps from fairness scoring</div>
        <div style="font-size:11px;color:var(--text2)">When ON ‚Äî swapped shifts don't count against a tech's history. Fairness only applies to originally generated assignments.</div>
      </div>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;flex-shrink:0">
        <div style="position:relative;width:44px;height:24px" onclick="toggleSwapFairness()">
          <input type="checkbox" id="exclude-swaps-toggle" style="opacity:0;position:absolute;width:100%;height:100%;cursor:pointer;margin:0" checked>
          <div id="toggle-track" style="position:absolute;inset:0;border-radius:12px;background:var(--accent);transition:background 0.2s"></div>
          <div id="toggle-thumb" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#000;transition:left 0.2s"></div>
        </div>
        <span id="toggle-label" style="font-size:12px;font-weight:600;color:var(--accent)">ON</span>
      </label>
    </div>
  </div><!-- end gen-setup -->

  <div id="gen-draft-area" style="display:none">
    <div class="draft-banner">
      <div>
        <div class="draft-banner-text">üìã DRAFT ‚Äî Not yet published</div>
        <div class="draft-banner-sub" id="draft-sub">Review all slots, adjust any assignments, then publish</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-warn" onclick="clearDraft()">‚úï Discard</button>
        <button class="btn btn-p" onclick="publishDraft()" id="pub-btn">‚úì Publish Live</button>
      </div>
    </div>
    <div id="gen-alerts"></div>
    <div id="gen-days"></div>
  </div>
</div>

<!-- PTO -->
<div class="page" id="page-pto">
  <div class="page-header">
    <div><div class="page-title">PTO Calendar 2026</div><div class="page-sub">Click any weekday to add/remove PTO</div></div>
    <div class="controls">
      <select class="fsel" id="f-pto-staff" onchange="renderPTO()"><option value="">All Staff</option></select>
      <input class="si" placeholder="Filter by name‚Ä¶" id="f-pto-srch" oninput="renderPTO()" />
    </div>
  </div>
  <div class="mg" id="pto-grid"></div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="page-header">
    <div><div class="page-title">Staff Roster</div><div class="page-sub" id="staff-sub">‚Äî</div></div>
    <div class="controls">
      <select class="fsel" id="f-qual" onchange="renderStaff()">
        <option value="">All Qualifications</option>
        <option>PET</option><option>General</option><option>Theranostics</option>
      </select>
      <input class="si" placeholder="Search staff‚Ä¶" id="f-staff" oninput="renderStaff()" />
      <button class="btn btn-p" onclick="openStaffModal()">+ Add Staff</button>
    </div>
  </div>
  <div class="sg" id="staff-grid"></div>

  <hr class="section-divider" />

  <div class="page-header" style="margin-top:0">
    <div>
      <div class="page-title" style="font-size:18px">üè• Equipment & Cameras</div>
      <div class="page-sub">Manage rooms and block cameras for maintenance or downtime</div>
    </div>
    <button class="btn btn-p" onclick="openEquipModal()">+ Add Equipment</button>
  </div>
  <div class="eq-grid" id="eq-grid"></div>
</div>

</main>
</div>

<!-- EQUIPMENT MODAL -->
<div class="overlay" id="equip-modal">
  <div class="modal">
    <div class="modal-title"><span id="equip-modal-ttl">Add Equipment</span><button class="modal-close" onclick="closeModal('equip-modal')">‚úï</button></div>
    <input type="hidden" id="eq-edit-id" />
    <div class="fr">
      <div class="fg"><label>Name / Room</label><input type="text" class="mfi" id="eq-name" placeholder="e.g. NM1" /></div>
      <div class="fg"><label>Room Code</label><input type="text" class="mfi" id="eq-code" placeholder="e.g. NM1" /></div>
    </div>
    <div class="fg"><label>Department</label>
      <select class="mfi" id="eq-dept">
        <option>PET</option><option>General</option><option>Theranostics</option><option>Support</option>
      </select>
    </div>
    <div class="fg"><label>Notes</label><input type="text" class="mfi" id="eq-notes" placeholder="Optional description" /></div>
    <div class="ma">
      <button class="btn btn-s" onclick="closeModal('equip-modal')">Cancel</button>
      <button class="btn btn-p" onclick="saveEquip()">Save Equipment</button>
    </div>
  </div>
</div>

<!-- BLOCKOUT MODAL -->
<div class="overlay" id="blockout-modal">
  <div class="modal">
    <div class="modal-title"><span id="blockout-modal-ttl">Block Camera</span><button class="modal-close" onclick="closeModal('blockout-modal')">‚úï</button></div>
    <input type="hidden" id="bo-equip-id" />
    <input type="hidden" id="bo-room-code" />
    <div class="fg"><label>Reason for blockout</label>
      <select class="mfi" id="bo-reason">
        <option>Maintenance</option>
        <option>Construction</option>
        <option>Repair</option>
        <option>Calibration</option>
        <option>Inspection</option>
        <option>Other</option>
      </select>
    </div>
    <div class="fg"><label>Block type</label>
      <select class="mfi" id="bo-type" onchange="toggleBlockType()">
        <option value="single">Single day</option>
        <option value="range">Date range</option>
        <option value="week">Whole week</option>
      </select>
    </div>
    <!-- SINGLE DAY PICKER -->
    <div id="bo-single-wrap" class="fg">
      <label>Date</label>
      <div class="bo-cal-wrap" id="bo-single-cal-wrap">
        <div class="bo-cal-trigger" id="bo-single-trigger" onclick="toggleBoCal('single')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-single-text">Select a date‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-single-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('single',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-single-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('single',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-single-grid"></div>
        </div>
      </div>
      <input type="hidden" id="bo-single-date" />
    </div>

    <!-- RANGE PICKER -->
    <div id="bo-range-wrap" style="display:none" class="fg">
      <label>Date Range ‚Äî click start then end date</label>
      <div class="bo-cal-wrap" id="bo-range-cal-wrap">
        <div class="bo-cal-trigger" id="bo-range-trigger" onclick="toggleBoCal('range')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-range-text">Select date range‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-range-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('range',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-range-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('range',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-range-grid"></div>
          <div style="font-size:10px;color:var(--text2);margin-top:8px;text-align:center" id="bo-range-hint">Click a start date</div>
        </div>
      </div>
      <input type="hidden" id="bo-start" />
      <input type="hidden" id="bo-end" />
    </div>

    <!-- WEEK PICKER (Mondays only) -->
    <div id="bo-week-wrap" style="display:none" class="fg">
      <label>Week ‚Äî select a Monday</label>
      <div class="bo-cal-wrap" id="bo-week-cal-wrap">
        <div class="bo-cal-trigger" id="bo-week-trigger" onclick="toggleBoCal('week')">
          <span>üìÖ</span><span class="bo-cal-trigger-text" id="bo-week-text">Select a Monday‚Ä¶</span><span style="color:var(--text3);font-size:11px">‚ñº</span>
        </div>
        <div class="bo-cal-dropdown" id="bo-week-dropdown">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="boCalNav('week',-1)">‚Äπ</button>
            <span class="cal-month-label" id="bo-week-month"></span>
            <button class="cal-nav-btn" onclick="boCalNav('week',1)">‚Ä∫</button>
          </div>
          <div class="cal-full-grid" id="bo-week-grid"></div>
          <div style="font-size:10px;color:var(--text2);margin-top:8px">Only Mondays are selectable ‚Äî blocks Mon‚ÄìFri</div>
        </div>
      </div>
      <input type="hidden" id="bo-week-start" />
    </div>
    <div class="ma">
      <button class="btn btn-s" onclick="closeModal('blockout-modal')">Cancel</button>
      <button class="btn btn-p" style="background:#f97316" onclick="saveBlockout()">üö´ Block Camera</button>
    </div>
  </div>
</div>

<!-- SHIFT MODAL -->
<div class="overlay" id="shift-modal">
  <div class="modal">
    <div class="modal-title"><span id="shift-modal-ttl">Add Shift</span><button class="modal-close" onclick="closeModal('shift-modal')">‚úï</button></div>
    <input type="hidden" id="shift-edit-id" />
    <div class="fg"><label>Date</label><input type="date" class="mfi" id="s-date" /></div>
    <div class="fr">
      <div class="fg"><label>Department</label><select class="mfi" id="s-dept"><option>PET</option><option>General</option><option>Theranostics</option><option>Support</option></select></div>
      <div class="fg"><label>Room</label><select class="mfi" id="s-room"><option>NM1</option><option>NM2</option><option>NM4</option><option>NM6</option><option>NM7</option><option>NM8</option><option>NM9</option><option>Pharmacy</option><option>Wet Work</option><option>Therapy Room</option><option>PET SUPPORT</option></select></div>
    </div>
    <div class="fg"><label>Shift Time</label><select class="mfi" id="s-shift"><option>6:00am-2:30pm</option><option>6:30am-3:00pm</option><option>6:45am-3:15pm</option><option>7:30am-4:00pm</option><option>8:00am-4:30pm</option><option>8:30am-5:00pm</option><option>9:30am-6:00pm</option></select></div>
    <div class="fg"><label>Assigned Tech</label><select class="mfi" id="s-tech"></select></div>
    <div class="fg"><label>Notes (optional)</label><input type="text" class="mfi" id="s-notes" placeholder="Any notes‚Ä¶" /></div>
    <div class="ma"><button class="btn btn-g" onclick="closeModal('shift-modal')">Cancel</button><button class="btn btn-p" onclick="saveShift()">Save Shift</button></div>
  </div>
</div>

<!-- STAFF MODAL -->
<div class="overlay" id="staff-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-title"><span id="staff-modal-ttl">Add Staff Member</span><button class="modal-close" onclick="closeModal('staff-modal')">‚úï</button></div>
    <input type="hidden" id="staff-edit-id" />

    <!-- Name + Initials -->
    <div class="fr">
      <div class="fg"><label>Full Name</label><input type="text" class="mfi" id="st-name" placeholder="Jane Smith (JS)" /></div>
      <div class="fg"><label>Initials</label><input type="text" class="mfi" id="st-init" placeholder="JS" maxlength="4" /></div>
    </div>

    <!-- Role toggle -->
    <div class="fg">
      <label>Role <span style="font-size:10px;color:var(--text2);font-weight:400">(optional)</span></label>
      <input type="hidden" id="st-role" />
      <div style="display:flex;gap:8px;margin-top:4px">
        <button type="button" class="role-chip" data-role="Chief Technologist" onclick="toggleRoleChip(this)">üëë Chief Technologist</button>
        <button type="button" class="role-chip" data-role="Lead Technologist"  onclick="toggleRoleChip(this)">‚≠ê Lead Technologist</button>
      </div>
    </div>

    <!-- Available Days multi-select chips -->
    <div class="fg">
      <label>Available Days</label>
      <input type="hidden" id="st-days" />
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px" id="st-days-chips">
        <button type="button" class="day-chip" data-day="Monday"    onclick="toggleDayChip(this)">Mon</button>
        <button type="button" class="day-chip" data-day="Tuesday"   onclick="toggleDayChip(this)">Tue</button>
        <button type="button" class="day-chip" data-day="Wednesday" onclick="toggleDayChip(this)">Wed</button>
        <button type="button" class="day-chip" data-day="Thursday"  onclick="toggleDayChip(this)">Thu</button>
        <button type="button" class="day-chip" data-day="Friday"    onclick="toggleDayChip(this)">Fri</button>
      </div>
    </div>

    <!-- Qualifications multi-select chips -->
    <div class="fg">
      <label>Qualifications</label>
      <input type="hidden" id="st-quals" />
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px" id="st-quals-chips">
        <button type="button" class="qual-chip" data-qual="PET"          onclick="toggleQualChip(this)">PET</button>
        <button type="button" class="qual-chip" data-qual="General"      onclick="toggleQualChip(this)">General</button>
        <button type="button" class="qual-chip" data-qual="Theranostics" onclick="toggleQualChip(this)">Theranostics</button>
        <button type="button" class="qual-chip" data-qual="Support"      onclick="toggleQualChip(this)">Support</button>
      </div>
    </div>

    <!-- PTO mini calendar -->
    <div class="fg">
      <label>PTO Dates <span style="font-size:10px;color:var(--text2);font-weight:400">(optional ‚Äî click days to add)</span></label>
      <input type="hidden" id="st-pto" />
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:4px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <button type="button" class="cal-nav-btn" onclick="stCalNav(-1)">‚Äπ</button>
          <span id="st-cal-label" style="font-size:12px;font-weight:700;color:var(--text)"></span>
          <button type="button" class="cal-nav-btn" onclick="stCalNav(1)">‚Ä∫</button>
        </div>
        <div id="st-cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;width:100%"></div>
        <div id="st-pto-tags" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;min-height:20px"></div>
      </div>
    </div>

    <div class="ma"><button class="btn btn-g" onclick="closeModal('staff-modal')">Cancel</button><button class="btn btn-p" onclick="saveStaff()">Save</button></div>
  </div>
</div>

<!-- PTO MODAL -->
<div class="overlay" id="pto-modal">
  <div class="modal" style="max-width:400px">
    <div class="modal-title"><span id="pto-modal-ttl">Edit PTO</span><button class="modal-close" onclick="closeModal('pto-modal')">‚úï</button></div>
    <div class="fg"><label>Staff Member</label><select class="mfi" id="pto-staff-sel"></select></div>
    <div class="fg"><label>Action</label><select class="mfi" id="pto-action"><option value="add">Add PTO this day</option><option value="remove">Remove PTO this day</option></select></div>
    <input type="hidden" id="pto-date-val" />
    <div class="ma"><button class="btn btn-g" onclick="closeModal('pto-modal')">Cancel</button><button class="btn btn-p" onclick="savePTO()">Save</button></div>
  </div>
</div>



  <div style="text-align:center;padding:18px;font-size:11px;color:var(--text3);border-top:1px solid var(--border);margin-top:32px">
    ¬© 2026 NucMed Scheduler ¬∑ Thomas ModicaAmore ¬∑ All Rights Reserved
  </div>
</body>
</html>
