<!DOCTYPE html>
<!--
  NucMed Scheduling System
  ¬© 2026 Thomas ModicaAmore. All Rights Reserved.
  Unauthorized copying, distribution, or use of this software
  is strictly prohibited without written permission.
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NucMed Schedule ‚Äî Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0e14; --surface: #131920; --surface2: #1a2332; --border: #263040;
  --accent: #00d4aa; --pet: #7c6ff7; --general: #10b981; --thera: #f59e0b; --support: #ec4899;
  --text: #dce8f5; --text2: #7a90a8; --text3: #4a5a6a; --pto: #f97316;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }
header { background: rgba(10,14,20,0.97); border-bottom: 1px solid var(--border); padding: 0 28px; display: flex; align-items: center; gap: 20px; height: 58px; position: sticky; top: 0; z-index: 100; }
.logo { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; color: var(--accent); letter-spacing: 0.06em; }
nav { display: flex; gap: 2px; flex: 1; }
.nav-btn { background: none; border: none; color: var(--text2); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; padding: 7px 16px; border-radius: 8px; cursor: pointer; transition: all 0.15s; }
.nav-btn:hover { background: var(--surface2); color: var(--text); }
.nav-btn.active { background: var(--surface2); color: var(--accent); }
.live-badge { display: flex; align-items: center; gap: 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 11px; color: var(--text2); }
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: glow 2s infinite; }
@keyframes glow { 0%,100%{opacity:1}50%{opacity:0.4} }
main { padding: 28px; max-width: 1440px; margin: 0 auto; }
.page { display: none; animation: fi 0.2s ease; }
.page.active { display: block; }
@keyframes fi { from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)} }
.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 28px; gap: 16px; flex-wrap: wrap; }
.page-title { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; }
.page-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
.controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.search-box, .fsel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; transition: border-color 0.15s; }
.search-box { width: 200px; } .search-box:focus, .fsel:focus { border-color: var(--accent); }
.dept-pill { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 9px; border-radius: 20px; text-transform: uppercase; }
.dp-PET { background: rgba(124,111,247,0.15); color: #9d93ff; border: 1px solid rgba(124,111,247,0.3); }
.dp-General { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
.dp-Theranostics { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
.dp-Support { background: rgba(236,72,153,0.15); color: #f472b6; border: 1px solid rgba(236,72,153,0.3); }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
.card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.card-title { font-size: 13px; font-weight: 600; }
.card-body { padding: 20px; }
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.g4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; }
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}} @media(max-width:600px){.g2,.g4{grid-template-columns:1fr}}
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; position: relative; overflow: hidden; }
.stat-card::after { content:''; position:absolute; top:0;left:0;right:0;height:2px; }
.sc-pet::after{background:var(--pet)}.sc-gen::after{background:var(--general)}.sc-thera::after{background:var(--thera)}.sc-sup::after{background:var(--support)}
.stat-label { font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; }
.stat-val { font-family: 'Space Mono', monospace; font-size: 34px; font-weight: 700; margin: 8px 0 4px; }
.stat-sub { font-size: 12px; color: var(--text2); }
.dt { width: 100%; border-collapse: collapse; }
.dt th { background: var(--surface2); color: var(--text2); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); }
.dt td { padding: 10px 16px; border-bottom: 1px solid rgba(38,48,64,0.6); font-size: 13px; vertical-align: middle; }
.dt tr:last-child td { border-bottom: none; }
.dt tbody tr:hover td { background: rgba(255,255,255,0.015); }
.chip { display: inline-flex; align-items: center; gap: 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 3px 10px; font-size: 12px; font-weight: 500; white-space: nowrap; }
.av { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; color: #fff; flex-shrink: 0; }
.sb { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); background: rgba(0,212,170,0.08); padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0,212,170,0.2); white-space: nowrap; }
.rb { font-size: 11px; font-weight: 600; color: var(--text2); background: var(--bg); border: 1px solid var(--border); padding: 2px 8px; border-radius: 4px; white-space: nowrap; }
.ib { font-size: 11px; background: var(--surface2); border: 1px solid var(--border); color: var(--text2); padding: 3px 9px; border-radius: 20px; }
.ib-g { background: rgba(16,185,129,0.1); color: #34d399; border-color: rgba(16,185,129,0.3); }
.ib-a { background: rgba(245,158,11,0.1); color: #fbbf24; border-color: rgba(245,158,11,0.3); }
.sd { font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text3); display: flex; align-items: center; gap: 12px; margin: 24px 0 14px; }
.sd::after { content:''; flex:1; height:1px; background: var(--border); }
.mg { display: grid; grid-template-columns: repeat(auto-fill,minmax(290px,1fr)); gap: 20px; }
.mc { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
.mch { background: var(--surface2); padding: 12px 16px; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; letter-spacing: 0.12em; color: var(--accent); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.cg { display: grid; grid-template-columns: repeat(7,1fr); }
.cdh { text-align: center; font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; padding: 7px 2px 5px; background: var(--surface2); }
.cd { text-align: center; padding: 5px 2px; border: 1px solid rgba(38,48,64,0.4); min-height: 48px; }
.cd.hp { background: rgba(249,115,22,0.06); }
.dn { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text2); display: block; }
.cd.we .dn { color: var(--text3); }
.pt { display: flex; flex-wrap: wrap; gap: 1px; justify-content: center; margin-top: 2px; }
.ptag { font-size: 7px; font-weight: 700; background: rgba(249,115,22,0.2); color: var(--pto); border: 1px solid rgba(249,115,22,0.3); padding: 1px 3px; border-radius: 2px; }
.sg { display: grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap: 16px; }
.sc2 { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px; display: flex; gap: 14px; align-items: flex-start; transition: border-color 0.15s; }
.sc2:hover { border-color: rgba(0,212,170,0.3); }
.avl { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0; }
.sn { font-size: 14px; font-weight: 600; }
.sm { font-size: 11px; color: var(--text2); margin: 4px 0 8px; line-height: 1.5; }
.sq { display: flex; gap: 6px; flex-wrap: wrap; }
.sp { margin-top: 8px; font-size: 11px; color: var(--text2); }
.spl { font-size: 10px; font-weight: 600; color: var(--pto); text-transform: uppercase; letter-spacing: 0.08em; }
.cr { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.cl { font-size: 12px; color: var(--text2); width: 110px; text-align: right; }
.ct { flex:1; background: var(--surface2); border-radius: 4px; height: 20px; overflow: hidden; }
.cf { height: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; transition: width 0.6s ease; }
.cf span { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.8); }
.cn { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text2); width: 28px; }
mark { background: rgba(0,212,170,0.15); color: var(--accent); border-radius: 2px; }
::-webkit-scrollbar{width:5px;height:5px} ::-webkit-scrollbar-track{background:var(--bg)} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.loading { text-align: center; padding: 60px; color: var(--text2); }
.loading-spin { font-size: 32px; animation: spin 1s linear infinite; display: block; margin-bottom: 12px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{border:none;border-radius:10px;padding:9px 18px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:7px;}
.btn-p{background:var(--accent);color:#000;}
.btn-p:hover{background:#00f0c0;}
.btn-s{background:var(--surface2);color:var(--text);border:1px solid var(--border2);}
.btn-s:hover{border-color:var(--accent);color:var(--accent);}
/* ‚îÄ‚îÄ SWAP BOARD ‚îÄ‚îÄ */
.swap-filter{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all 0.15s;}
.swap-filter.active{background:rgba(0,212,170,0.1);border-color:var(--accent);color:var(--accent);}
.swap-fcount{display:inline-block;background:var(--surface2);border-radius:10px;padding:1px 7px;font-size:10px;margin-left:3px;}
.swap-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;transition:border-color 0.2s;}
.swap-card.s-open{border-left:3px solid var(--accent);}
.swap-card.s-pending{border-left:3px solid #f59e0b;}
.swap-card.s-approved{border-left:3px solid var(--success);opacity:0.75;}
.swap-card.s-denied{border-left:3px solid var(--danger);opacity:0.6;}
.sc-top{display:flex;align-items:center;gap:12px;padding:16px 20px 0;}
.sc-avatar{width:36px;height:36px;border-radius:50%;background:var(--surface2);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--accent);font-family:'Space Mono',monospace;flex-shrink:0;}
.sc-who{flex:1;}
.sc-name{font-weight:700;font-size:14px;}
.sc-time{font-size:11px;color:var(--text3);margin-top:2px;}
.sc-pill{padding:4px 11px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;flex-shrink:0;}
.pill-open{background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.25);}
.pill-pending{background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.25);}
.pill-approved{background:rgba(63,185,80,0.1);color:var(--success);border:1px solid rgba(63,185,80,0.25);}
.pill-denied{background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid rgba(248,81,73,0.25);}
.sc-body{padding:14px 20px;}
.sc-section-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text3);margin-bottom:6px;}
.sc-shift-badge{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:6px 12px;font-size:12px;font-weight:600;margin-bottom:4px;}
.sc-want-badge{background:rgba(0,212,170,0.05);border-color:rgba(0,212,170,0.2);}
.sc-note{font-size:12px;color:var(--text2);font-style:italic;padding:8px 12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--border2);margin-top:10px;}
.sc-footer{padding:12px 20px 14px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--border);margin-top:4px;}
.sc-footer-info{flex:1;font-size:12px;color:var(--text2);}
.trade-grid{display:grid;grid-template-columns:1fr 36px 1fr;gap:10px;align-items:center;background:var(--surface2);border-radius:12px;padding:14px 16px;}
.trade-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text3);margin-bottom:5px;}
.trade-arrow{text-align:center;font-size:20px;color:var(--text3);}
.want-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.25);border-radius:20px;padding:4px 10px;font-size:11px;font-weight:600;color:var(--accent);}
.want-tag-x{background:none;border:none;cursor:pointer;color:var(--accent);font-size:12px;padding:0;line-height:1;}
.swap-dot{height:4px;flex:1;border-radius:2px;background:var(--border2);transition:background 0.2s;}
.swap-dot.done{background:var(--accent);}
.swap-dot.active{background:rgba(0,212,170,0.45);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:20px;width:100%;animation:slideUp 0.2s ease;}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hd{padding:20px 24px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal-title{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;}
.modal-close{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);width:30px;height:30px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body>
<header>
  <div class="logo">‚ò¢ NUCMED</div>
  <nav>
    <button class="nav-btn active" onclick="goTo('dashboard',this)">Dashboard</button>
    <button class="nav-btn" onclick="goTo('schedule',this)">Schedule</button>
    <button class="nav-btn" onclick="goTo('pto',this)">PTO Calendar</button>
    <button class="nav-btn" onclick="goTo('staff',this)">Staff Roster</button>
    <button class="nav-btn" onclick="goTo('swaps',this)" id="swaps-nav-btn">üîÑ Shift Swaps <span id="swaps-open-badge" style="display:none;background:var(--accent);color:#000;border-radius:10px;padding:1px 7px;font-size:10px;font-weight:700;margin-left:2px"></span></button>
  </nav>
  <div class="live-badge"><div class="live-dot"></div><span id="live-lbl">Connecting...</span></div>
</header>
<main>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <div><div class="page-title">Overview</div><div class="page-sub" id="dash-sub">Loading...</div></div>
  </div>
  <div class="g4" style="margin-bottom:24px" id="stats"></div>
  <div class="g2" style="margin-bottom:20px">
    <div class="card">
      <div class="card-header"><div class="card-title" id="today-ttl">Today's Assignments</div><span class="ib ib-g" id="today-cnt"></span></div>
      <div style="overflow-x:auto"><table class="dt" id="today-tbl"></table></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">Department Distribution</div></div>
      <div class="card-body" id="dept-chart"></div>
    </div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-header"><div class="card-title">This Week at a Glance</div></div>
      <div style="overflow-x:auto"><table class="dt" id="week-tbl"></table></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">Upcoming PTO</div><span class="ib ib-a">Next 60 days</span></div>
      <div class="card-body" id="pto-up"></div>
    </div>
  </div>
</div>

<!-- SCHEDULE -->
<div class="page" id="page-schedule">
  <div class="page-header">
    <div><div class="page-title">Schedule</div><div class="page-sub" id="sched-sub">Select a published week</div></div>
    <span id="v-week-badge" style="display:none" class="ib"></span>
  </div>

  <!-- WEEK PICKER -->
  <div style="margin-bottom:24px">
    <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:6px">Select Week</label>
    <div style="position:relative;display:inline-block" id="v-cal-wrap">
      <div id="v-cal-trigger" onclick="toggleVCal()" style="background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:10px 16px;color:var(--text);font-size:13px;cursor:pointer;display:flex;align-items:center;gap:10px;min-width:260px;transition:border-color 0.15s;user-select:none;">
        <span>üìÖ</span>
        <span id="v-cal-trigger-text" style="flex:1">Pick a published week‚Ä¶</span>
        <span id="v-cal-arrow" style="color:var(--text3);font-size:11px;transition:transform 0.15s">‚ñº</span>
      </div>
      <div id="v-cal-dropdown" style="display:none;position:absolute;top:calc(100% + 8px);left:0;background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:20px;z-index:400;width:310px;box-shadow:0 20px 60px rgba(0,0,0,0.6)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <button onclick="vCalNav(-1)" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);width:32px;height:32px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center">‚Äπ</button>
          <span id="v-cal-month" style="font-size:13px;font-weight:600"></span>
          <button onclick="vCalNav(1)" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);width:32px;height:32px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center">‚Ä∫</button>
        </div>
        <div id="v-cal-grid"></div>
        <div style="display:flex;gap:14px;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2)"><div style="width:6px;height:6px;border-radius:50%;background:var(--accent)"></div>Published</div>
          <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2)"><div style="width:28px;height:10px;border-radius:3px;background:var(--accent);opacity:0.7"></div>Selected</div>
        </div>
      </div>
    </div>
  </div>

  <div id="sched-body"></div>
</div>

<!-- PTO -->
<div class="page" id="page-pto">
  <div class="page-header">
    <div><div class="page-title">PTO Calendar 2026</div><div class="page-sub">Staff vacation & time-off</div></div>
    <div class="controls">
      <select class="fsel" id="f-pto-staff" onchange="renderPTO()"><option value="">All Staff</option></select>
      <input class="search-box" placeholder="Filter by name‚Ä¶" id="f-pto-srch" oninput="renderPTO()" />
    </div>
  </div>
  <div class="mg" id="pto-grid"></div>
</div>

<!-- STAFF -->
<div class="page" id="page-staff">
  <div class="page-header">
    <div><div class="page-title">Staff Roster</div><div class="page-sub" id="staff-sub">Loading...</div></div>
    <div class="controls">
      <select class="fsel" id="f-qual" onchange="renderStaff()">
        <option value="">All Qualifications</option>
        <option>PET</option><option>General</option><option>Theranostics</option>
      </select>
      <input class="search-box" placeholder="Search staff‚Ä¶" id="f-staff" oninput="renderStaff()" />
    </div>
  </div>
  <div class="sg" id="staff-grid"></div>
</div>

</main>
<!-- SHIFT SWAPS PAGE -->
<div class="page" id="page-swaps">
  <div class="page-header">
    <div>
      <div class="page-title">üîÑ Shift Swap Board</div>
      <div class="page-sub">Post a swap request or offer to cover a colleague's shift. All swaps require admin approval.</div>
    </div>
    <button class="btn btn-p" onclick="openSwapModal()">+ Request a Swap</button>
  </div>

  <div class="filter-bar" style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap">
    <button class="swap-filter active" onclick="filterSwaps('all',this)">All <span class="swap-fcount" id="fc-all">0</span></button>
    <button class="swap-filter" onclick="filterSwaps('open',this)">üü¢ Open <span class="swap-fcount" id="fc-open">0</span></button>
    <button class="swap-filter" onclick="filterSwaps('pending',this)">üü° Pending <span class="swap-fcount" id="fc-pending">0</span></button>
    <button class="swap-filter" onclick="filterSwaps('approved',this)">‚úÖ Approved <span class="swap-fcount" id="fc-approved">0</span></button>
  </div>

  <div id="swaps-body"><div style="text-align:center;padding:60px;color:var(--text2)">Loading swap requests‚Ä¶</div></div>
</div>

<!-- SWAP REQUEST MODAL -->
<div class="modal-overlay" id="swap-modal" onclick="if(event.target===this)closeSwapModal()">
  <div class="modal" style="max-width:500px">
    <div class="modal-hd">
      <div class="modal-title" style="font-size:15px">Request a Shift Swap</div>
      <button class="modal-close" onclick="closeSwapModal()">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0 24px">
      <!-- Step dots -->
      <div style="display:flex;gap:5px;margin-bottom:20px" id="swap-step-dots">
        <div class="swap-dot done"></div><div class="swap-dot active"></div>
        <div class="swap-dot"></div><div class="swap-dot"></div><div class="swap-dot"></div>
      </div>
      <!-- Step 1 -->
      <div id="swap-step-1">
        <div class="form-group" style="margin-bottom:14px">
          <div class="form-label">Who are you?</div>
          <select class="fsel" id="sw-who" onchange="onSwapWhoChange()">
            <option value="">Select your name‚Ä¶</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:14px">
          <div class="form-label">Which published week?</div>
          <select class="fsel" id="sw-week" onchange="onSwapWeekChange()">
            <option value="">Select a week‚Ä¶</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Which of your shifts do you want to swap out of?</div>
          <select class="fsel" id="sw-give" onchange="checkSwapStep1()">
            <option value="">Select name and week first‚Ä¶</option>
          </select>
        </div>
      </div>
      <!-- Step 2 -->
      <div id="swap-step-2" style="display:none">
        <div style="background:var(--surface2);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:12px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);letter-spacing:0.07em;margin-bottom:6px">Shift you're giving up</div>
          <div id="sw-give-summary" style="font-weight:600;color:var(--text)"></div>
        </div>
        <div class="form-group" style="margin-bottom:6px">
          <div class="form-label" style="display:flex;justify-content:space-between;align-items:center">
            <span>Shifts you'd accept in return <span style="color:var(--text3);font-weight:400;text-transform:none;letter-spacing:0">(up to 3)</span></span>
            <span id="sw-want-count" style="font-size:11px;color:var(--text3)">0 / 3</span>
          </div>
          <div id="sw-want-tags" style="display:flex;flex-wrap:wrap;gap:6px;min-height:28px;margin:8px 0"></div>
          <select class="fsel" id="sw-want-sel" onchange="addSwapWant(this)">
            <option value="">Add a shift‚Ä¶</option>
          </select>
          <div style="font-size:11px;color:var(--text3);margin-top:5px">More options = better chance of finding a match</div>
        </div>
        <div class="form-group" style="margin-top:14px">
          <div class="form-label">Short note (optional)</div>
          <input class="fsel" type="text" id="sw-note" placeholder="e.g. Doctor's appointment, family event‚Ä¶" maxlength="120">
        </div>
      </div>
    </div>
    <div class="modal-ft" style="padding:16px 24px;border-top:1px solid var(--border);margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-s" id="sw-modal-back" style="display:none" onclick="swapModalBack()">‚Üê Back</button>
      <button class="btn btn-s" onclick="closeSwapModal()">Cancel</button>
      <button class="btn btn-p" id="sw-modal-next" onclick="swapModalNext()" disabled>Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- SWAP OFFER MODAL -->
<div class="modal-overlay" id="offer-modal" onclick="if(event.target===this)closeOfferModal()">
  <div class="modal" style="max-width:460px">
    <div class="modal-hd">
      <div class="modal-title" style="font-size:15px">Offer to Swap</div>
      <button class="modal-close" onclick="closeOfferModal()">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0 24px 4px">
      <div id="offer-request-summary" style="background:var(--surface2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12px"></div>
      <div class="form-group" style="margin-bottom:14px">
        <div class="form-label">Who are you?</div>
        <select class="fsel" id="off-who" onchange="onOfferWhoChange()">
          <option value="">Select your name‚Ä¶</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-label">Which of your shifts are you offering?</div>
        <select class="fsel" id="off-shift" onchange="checkOfferReady()">
          <option value="">Select your name first‚Ä¶</option>
        </select>
      </div>
      <div id="offer-qual-warn" style="display:none;margin-top:10px;padding:8px 12px;background:rgba(248,81,73,0.08);border:1px solid rgba(248,81,73,0.2);border-radius:8px;font-size:12px;color:var(--danger)"></div>
    </div>
    <div class="modal-ft" style="padding:16px 24px;border-top:1px solid var(--border);margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-s" onclick="closeOfferModal()">Cancel</button>
      <button class="btn btn-p" id="off-submit" onclick="submitOffer()" disabled>üì® Submit Offer</button>
    </div>
  </div>
</div>

<script>
const SUPA_URL = 'https://pkpbeiewrfrmevrokesc.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrcGJlaWV3cmZybWV2cm9rZXNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjM4MTYsImV4cCI6MjA4NzQzOTgxNn0.ZTS48kvRvWr_jqJigleljCQXWc0peTJQl6GIY_wrp68';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

let STAFF=[], SCHEDULE=[], PTO=[];

const MONTHS = {February:{n:2,d:28},March:{n:3,d:31},April:{n:4,d:30},May:{n:5,d:31},June:{n:6,d:30},July:{n:7,d:31},August:{n:8,d:31},September:{n:9,d:30},October:{n:10,d:31},November:{n:11,d:30},December:{n:12,d:31}};
const TC=['#7c6ff7','#10b981','#f59e0b','#ec4899','#3b82f6','#8b5cf6','#ef4444','#06b6d4','#84cc16','#f97316','#14b8a6','#a855f7'];
function tc(n){let h=0;for(const c of n)h=(h*31+c.charCodeAt(0))&0xffffffff;return TC[Math.abs(h)%TC.length];}
function inits(name){const s=STAFF.find(x=>x.name===name);return s?s.initials:(name.match(/\(([^)]+)\)/)||[,'??'])[1];}
function chip(name){return`<span class="chip"><span class="av" style="background:${tc(name)}">${inits(name)}</span>${name}</span>`;}
function dp(dept){return`<span class="dept-pill dp-${dept.replace(/\s/g,'')}">${dept}</span>`;}
function fmtD(iso){return new Date(iso+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});}
function hl(t,q){if(!q)return t;return t.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'),'<mark>$1</mark>');}
function wkDates(){return[...new Set(SCHEDULE.map(s=>s.shift_date))].sort().slice(0,10);}

// ‚îÄ‚îÄ VIEWER WEEK PICKER ‚îÄ‚îÄ
let vCalYear=new Date().getFullYear(), vCalMonth=new Date().getMonth(), vSelWeek=null;

function getPublishedMondaysV(){
  const s=new Set();
  SCHEDULE.forEach(r=>{
    const d=new Date(r.shift_date+'T12:00:00');
    const diff=(d.getDay()+6)%7;
    const m=new Date(d);m.setDate(d.getDate()-diff);
    s.add(m.toISOString().split('T')[0]);
  });
  return s;
}

function toggleVCal(){
  const dd=document.getElementById('v-cal-dropdown');
  const open=dd.style.display==='block';
  dd.style.display=open?'none':'block';
  document.getElementById('v-cal-arrow').style.transform=open?'':'rotate(180deg)';
  document.getElementById('v-cal-trigger').style.borderColor=open?'var(--border2)':'var(--accent)';
  if(!open) renderVCal();
}

function vCalNav(dir){
  vCalMonth+=dir;
  if(vCalMonth>11){vCalMonth=0;vCalYear++;}
  if(vCalMonth<0){vCalMonth=11;vCalYear--;}
  renderVCal();
}

function renderVCal(){
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAY=['Su','Mo','Tu','We','Th','Fr','Sa'];
  document.getElementById('v-cal-month').textContent=`${MNAMES[vCalMonth]} ${vCalYear}`;
  const published=getPublishedMondaysV();
  const today=new Date().toISOString().split('T')[0];
  const firstDow=new Date(vCalYear,vCalMonth,1).getDay();
  const daysInMonth=new Date(vCalYear,vCalMonth+1,0).getDate();

  let html=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px">`;
  DAY.forEach(d=>html+=`<div style="text-align:center;font-size:10px;font-weight:700;color:var(--text3);padding:4px 0;text-transform:uppercase">${d}</div>`);
  html+=`</div><div style="display:flex;flex-direction:column;gap:2px">`;

  let days=[];
  for(let i=0;i<firstDow;i++) days.push(null);
  for(let d=1;d<=daysInMonth;d++) days.push(d);
  while(days.length%7) days.push(null);

  for(let w=0;w<days.length/7;w++){
    const week=days.slice(w*7,w*7+7);
    const monDay=week[1];
    if(!monDay){
      html+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:0">`;
      week.forEach(()=>html+=`<div style="height:32px"></div>`);
      html+=`</div>`;continue;
    }
    const monISO=`${vCalYear}-${String(vCalMonth+1).padStart(2,'0')}-${String(monDay).padStart(2,'0')}`;
    const isPub=published.has(monISO);
    const isSel=vSelWeek===monISO;
    const rowStyle=isPub
      ?isSel
        ?`cursor:pointer;display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-radius:6px;overflow:hidden;background:var(--accent)`
        :`cursor:pointer;display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-radius:6px;overflow:hidden;background:rgba(0,212,170,0.07);border:1px solid rgba(0,212,170,0.15)`
      :`display:grid;grid-template-columns:repeat(7,1fr);gap:0`;
    const click=isPub?`onclick="selectVWeek('${monISO}')"`:'' ;
    html+=`<div style="${rowStyle}" ${click}>`;
    week.forEach((d,di)=>{
      if(!d){html+=`<div style="height:32px"></div>`;return;}
      const iso=`${vCalYear}-${String(vCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isToday=iso===today&&!isSel;
      const textColor=isSel?'#000':isPub?'var(--text)':'var(--text3)';
      const todayRing=isToday?'outline:2px solid var(--accent);outline-offset:-2px;border-radius:4px;':'';
      const dot=isPub&&!isSel?`<span style="position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent)"></span>`:'';
      html+=`<div style="position:relative;height:32px;display:flex;align-items:center;justify-content:center;font-size:12px;color:${textColor};${todayRing}">${d}${dot}</div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  document.getElementById('v-cal-grid').innerHTML=html;
}

function selectVWeek(monISO){
  vSelWeek=monISO;
  const mon=new Date(monISO+'T12:00:00');
  const fri=new Date(mon);fri.setDate(fri.getDate()+4);
  document.getElementById('v-cal-trigger-text').textContent=
    `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${fri.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  document.getElementById('v-cal-dropdown').style.display='none';
  document.getElementById('v-cal-arrow').style.transform='';
  document.getElementById('v-cal-trigger').style.borderColor='var(--border2)';
  // Update badge
  const today=new Date().toISOString().split('T')[0];
  const friISO=fri.toISOString().split('T')[0];
  const badge=document.getElementById('v-week-badge');
  if(badge){
    badge.style.display='inline-flex';
    if(today>=monISO&&today<=friISO){badge.className='ib ib-g';badge.textContent='‚óè Current Week';}
    else if(today>friISO){badge.className='ib ib-a';badge.textContent='Past Week';}
    else{badge.className='ib ib-b';badge.textContent='Future Week';}
  }
  renderVCal();
  renderSchedule();
}

// Close on outside click
document.addEventListener('click',e=>{
  const wrap=document.getElementById('v-cal-wrap');
  if(wrap&&!wrap.contains(e.target)){
    document.getElementById('v-cal-dropdown').style.display='none';
    document.getElementById('v-cal-arrow').style.transform='';
    document.getElementById('v-cal-trigger').style.borderColor='var(--border2)';
  }
});
function closest(ds){const t=new Date().toISOString().split('T')[0];const u=ds.filter(d=>d>=t);return u.length?u[0]:ds[ds.length-1];}
function dow(y,m){return new Date(y,m-1,1).getDay();}

function goTo(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
  if(id==='swaps') loadSwaps();
  if(id==='schedule'&&!vSelWeek){
    // Auto-select the most recent published week
    const published=[...getPublishedMondaysV()].sort().reverse();
    if(published.length){
      vCalYear=new Date(published[0]+'T12:00:00').getFullYear();
      vCalMonth=new Date(published[0]+'T12:00:00').getMonth();
      selectVWeek(published[0]);
    }
  }
}

async function loadAll(){
  document.getElementById('live-lbl').textContent='Loading...';
  try {
    const [s1,s2,s3] = await Promise.all([
      sb.from('staff').select('*').order('name'),
      sb.from('schedule').select('*').order('shift_date'),
      sb.from('pto').select('*').order('pto_date'),
    ]);
    STAFF=s1.data||[]; SCHEDULE=s2.data||[]; PTO=s3.data||[];
    document.getElementById('live-lbl').textContent='Live ¬∑ '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    renderAll();
  } catch(e) {
    document.getElementById('live-lbl').textContent='Connection error';
    console.error(e);
  }
}

function renderAll(){
  // PTO filter
  const ps=document.getElementById('f-pto-staff');
  ps.innerHTML='<option value="">All Staff</option>'+STAFF.map(s=>`<option>${s.name}</option>`).join('');
  renderDashboard(); renderSchedule(); renderPTO(); renderStaff();
}

function renderDashboard(){
  const dates=wkDates(); if(!dates.length) return;
  const today=closest(dates);
  const te=SCHEDULE.filter(s=>s.shift_date===today);
  document.getElementById('dash-sub').textContent=`Week of ${fmtD(dates[0])}`;
  const dc={PET:0,General:0,Theranostics:0,Support:0};
  te.forEach(s=>{if(dc[s.department]!==undefined)dc[s.department]++;});
  const sc=[{k:'PET',c:'sc-pet',col:'#9d93ff',l:'PET'},{k:'General',c:'sc-gen',col:'#34d399',l:'General'},{k:'Theranostics',c:'sc-thera',col:'#fbbf24',l:'Theranostics'},{k:'Support',c:'sc-sup',col:'#f472b6',l:'Support'}];
  document.getElementById('stats').innerHTML=sc.map(x=>`<div class="stat-card ${x.c}"><div class="stat-label">${x.l}</div><div class="stat-val" style="color:${x.col}">${dc[x.k]}</div><div class="stat-sub">Shifts today</div></div>`).join('');
  document.getElementById('today-ttl').textContent=`Assignments ‚Äî ${fmtD(today)}`;
  document.getElementById('today-cnt').textContent=`${te.length} shifts`;
  document.getElementById('today-tbl').innerHTML=`<thead><tr><th>Dept</th><th>Room</th><th>Shift</th><th>Tech</th></tr></thead><tbody>${te.map(s=>`<tr><td>${dp(s.department)}</td><td><span class="rb">${s.room}</span></td><td><span class="sb">${s.shift_time}</span></td><td>${chip(s.assigned_tech)}</td></tr>`).join('')}</tbody>`;
  // chart
  const ac={};SCHEDULE.forEach(s=>{ac[s.department]=(ac[s.department]||0)+1;});
  const mv=Math.max(...Object.values(ac),1);
  const dc2={PET:'#7c6ff7',General:'#10b981',Theranostics:'#f59e0b',Support:'#ec4899'};
  document.getElementById('dept-chart').innerHTML=Object.entries(ac).map(([d,n])=>`<div class="cr"><div class="cl">${d}</div><div class="ct"><div class="cf" style="width:${(n/mv*100).toFixed(0)}%;background:${dc2[d]||'#888'}"><span>${n}</span></div></div><div class="cn">${n}</div></div>`).join('');
  // week
  const wd=dates.slice(0,5);
  const slots=[...new Set(SCHEDULE.filter(s=>wd.includes(s.shift_date)).map(s=>s.room+'|'+s.shift_time))].sort();
  const dh=wd.map(d=>new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'numeric',day:'numeric'}));
  document.getElementById('week-tbl').innerHTML=`<thead><tr><th>Room/Shift</th>${dh.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${slots.map(sl=>{const[rm,sh]=sl.split('|');return`<tr><td><span class="rb">${rm}</span> <span class="sb" style="font-size:10px">${sh}</span></td>${wd.map(d=>{const e=SCHEDULE.find(s=>s.shift_date===d&&s.room===rm&&s.shift_time===sh);return`<td>${e?chip(e.assigned_tech):'<span style="color:var(--text3)">‚Äî</span>'}</td>`;}).join('')}</tr>`;}).join('')}</tbody>`;
  // upcoming pto
  const t=new Date().toISOString().split('T')[0];
  const cut=new Date();cut.setDate(cut.getDate()+60);
  const up=PTO.filter(p=>p.pto_date>=t&&new Date(p.pto_date)<=cut).sort((a,b)=>a.pto_date.localeCompare(b.pto_date));
  const grp={};up.forEach(p=>{if(!grp[p.staff_name])grp[p.staff_name]=[];grp[p.staff_name].push(p.pto_date);});
  document.getElementById('pto-up').innerHTML=Object.entries(grp).slice(0,10).map(([n,ds])=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(38,48,64,0.6)">${chip(n)}<span style="font-size:12px;color:var(--text2)">${new Date(ds[0]+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}${ds.length>1?' ‚Äì '+new Date(ds[ds.length-1]+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):''}</span></div>`).join('')||'<div style="color:var(--text2);font-size:13px">No PTO in the next 60 days</div>';
}

function renderSchedule(){
  const body=document.getElementById('sched-body');
  if(!vSelWeek){
    body.innerHTML=`<div style="text-align:center;padding:60px 20px;color:var(--text2)"><div style="font-size:40px;opacity:0.3;margin-bottom:12px">üìÖ</div><div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">Select a week above</div><div style="font-size:13px">Choose a published week from the calendar to view the schedule</div></div>`;
    return;
  }
  // Get Mon‚ÄìFri dates for selected week
  const weekDates=[];
  const mon=new Date(vSelWeek+'T12:00:00');
  for(let i=0;i<5;i++){const d=new Date(mon);d.setDate(d.getDate()+i);weekDates.push(d.toISOString().split('T')[0]);}

  let html='';
  weekDates.forEach(date=>{
    let e=SCHEDULE.filter(s=>s.shift_date===date);
    if(!e.length) return;
    // Group by department order
    const order=['PET','General','Theranostics','Support'];
    e.sort((a,b)=>order.indexOf(a.department)-order.indexOf(b.department));
    const dayLabel=new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    html+=`<div class="sd">${dayLabel}<span style="color:var(--text3)">${e.length} shifts</span></div>`;
    html+=`<div class="card" style="margin-bottom:0"><div style="overflow-x:auto"><table class="dt"><thead><tr><th>Dept</th><th>Room</th><th>Shift</th><th>Tech</th></tr></thead><tbody>`;
    e.forEach(s=>{html+=`<tr><td>${dp(s.department)}</td><td><span class="rb">${s.room}</span></td><td><span class="sb">${s.shift_time||'‚Äî'}</span></td><td>${chip(s.assigned_tech)}</td></tr>`;});
    html+=`</tbody></table></div></div>`;
  });
  if(!html) html=`<div style="text-align:center;padding:48px;color:var(--text2)">No shifts found for this week</div>`;
  body.innerHTML=html;
  document.getElementById('sched-sub').textContent=`Week of ${new Date(vSelWeek+'T12:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`;
}

function renderPTO(){
  const sF=document.getElementById('f-pto-staff').value;
  const srch=document.getElementById('f-pto-srch').value.toLowerCase().trim();
  let html='';
  Object.entries(MONTHS).forEach(([month,info])=>{
    const start=dow(2026,info.n);
    // build day->initials map
    const dayMap={};
    PTO.filter(p=>{
      const d=new Date(p.pto_date+'T12:00:00');
      if(d.getFullYear()!==2026||d.getMonth()+1!==info.n) return false;
      if(sF&&p.staff_name!==sF) return false;
      if(srch&&!p.staff_name.toLowerCase().includes(srch)&&!p.staff_initials.toLowerCase().includes(srch)) return false;
      return true;
    }).forEach(p=>{
      const day=new Date(p.pto_date+'T12:00:00').getDate();
      if(!dayMap[day]) dayMap[day]=[];
      dayMap[day].push(p.staff_initials);
    });
    html+=`<div class="mc"><div class="mch">${month.toUpperCase()} 2026<span style="font-size:10px;color:var(--text2)">${[...new Set(Object.values(dayMap).flat())].length} staff</span></div><div class="cg">`;
    html+=['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=>`<div class="cdh">${d}</div>`).join('');
    for(let i=0;i<start;i++) html+=`<div class="cd empty"></div>`;
    for(let d=1;d<=info.d;d++){
      const dw=(start+d-1)%7,we=dw===0||dw===6;
      const hits=dayMap[d]||[];
      html+=`<div class="cd ${we?'we':''} ${hits.length?'hp':''}"><span class="dn">${d}</span>${hits.length?`<div class="pt">${hits.map(i=>`<span class="ptag">${i}</span>`).join('')}</div>`:''}</div>`;
    }
    const tot=start+info.d;for(let i=tot%7;i>0&&i<7;i++) html+=`<div class="cd empty"></div>`;
    html+=`</div></div>`;
  });
  document.getElementById('pto-grid').innerHTML=html;
}

function renderStaff(){
  const qF=document.getElementById('f-qual').value;
  const sF=document.getElementById('f-staff').value.toLowerCase().trim();
  let list=STAFF;
  if(qF) list=list.filter(s=>s.qualifications&&s.qualifications.includes(qF));
  if(sF) list=list.filter(s=>s.name.toLowerCase().includes(sF));
  document.getElementById('staff-sub').textContent=`${list.length} staff member${list.length!==1?'s':''}`;
  document.getElementById('staff-grid').innerHTML=list.map(s=>{
    const nHL=sF?hl(s.name,document.getElementById('f-staff').value):s.name;
    return`<div class="sc2"><div class="avl" style="background:${tc(s.name)}">${s.initials}</div><div style="flex:1;min-width:0"><div class="sn">${nHL}</div><div class="sm">üìÖ ${s.available_days}</div><div class="sq">${(s.qualifications||[]).map(q=>`<span class="dept-pill dp-${q}">${q}</span>`).join('')}</div>${s.pto_dates?`<div class="sp"><div class="spl">PTO 2026</div><div>${s.pto_dates}</div></div>`:''}</div></div>`;
  }).join('');
}

loadAll();
// Auto-refresh every 2 minutes
setInterval(loadAll, 2*60*1000);


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHIFT SWAP BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let SWAPS=[], swapFilter='all', swapModalStep=1, swapWanted=[], activeRequestId=null;

async function loadSwaps(){
  const {data,error}=await sb.from('shift_swap_requests').select('*').order('created_at',{ascending:false});
  if(error){console.error('Swaps load error:',error);return;}
  SWAPS=data||[];
  renderSwapCounts();
  renderSwapBoard();
  // Update nav badge with open count
  const openCount=SWAPS.filter(s=>s.status==='open').length;
  const badge=document.getElementById('swaps-open-badge');
  if(badge){badge.textContent=openCount;badge.style.display=openCount?'inline':'none';}
}

function renderSwapCounts(){
  document.getElementById('fc-all').textContent=SWAPS.length;
  document.getElementById('fc-open').textContent=SWAPS.filter(s=>s.status==='open').length;
  document.getElementById('fc-pending').textContent=SWAPS.filter(s=>s.status==='pending').length;
  document.getElementById('fc-approved').textContent=SWAPS.filter(s=>s.status==='approved').length;
}

function filterSwaps(f,btn){
  swapFilter=f;
  document.querySelectorAll('.swap-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderSwapBoard();
}

function timeAgo(iso){
  const d=new Date(iso), now=new Date();
  const mins=Math.floor((now-d)/60000);
  if(mins<2) return 'just now';
  if(mins<60) return `${mins}m ago`;
  const hrs=Math.floor(mins/60);
  if(hrs<24) return `${hrs}h ago`;
  return `${Math.floor(hrs/24)}d ago`;
}

function deptColor(dept){
  return dept==='PET'?'var(--pet)':dept==='General'?'var(--general)':dept==='Theranostics'?'var(--thera)':'var(--accent)';
}

function renderSwapBoard(){
  const body=document.getElementById('swaps-body');
  if(!body) return;
  const list=swapFilter==='all'?SWAPS:SWAPS.filter(s=>s.status===swapFilter);
  if(!list.length){
    body.innerHTML=`<div style="text-align:center;padding:60px 20px;color:var(--text2)"><div style="font-size:40px;margin-bottom:12px;opacity:0.4">üîÑ</div><div style="font-size:16px;font-weight:600;color:var(--text);margin-bottom:6px">No swap requests</div><div style="font-size:13px">${swapFilter==='all'?'No one has posted a swap request yet':'Nothing in this category'}</div></div>`;
    return;
  }
  body.innerHTML=list.map(r=>renderSwapCard(r)).join('');
}

function renderSwapCard(r){
  const initials=r.requester_name.match(/\(([^)]+)\)/)?.[1]||r.requester_name.slice(0,2).toUpperCase();
  const pillClass={open:'pill-open',pending:'pill-pending',approved:'pill-approved',denied:'pill-denied'}[r.status]||'pill-open';
  const pillLabel={open:'Open',pending:'Pending Approval',approved:'‚úì Approved',denied:'Denied'}[r.status]||r.status;
  const dColor=deptColor(r.give_department);
  const mon=new Date(r.give_shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});

  // Wanted shifts tags
  const wantedHTML=(r.wanted_shifts||[]).map(w=>`<div class="sc-shift-badge sc-want-badge"><span style="width:6px;height:6px;border-radius:50%;background:${deptColor(w.department)};flex-shrink:0;display:inline-block"></span>${w.room} ¬∑ ${w.shift_time} ¬∑ ${new Date(w.shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>`).join('');

  let bodyHTML='';
  if(r.status==='open'||!r.volunteer_name){
    bodyHTML=`
      <div class="sc-section-label">Shift to give up</div>
      <div style="margin-bottom:12px"><div class="sc-shift-badge"><span style="width:6px;height:6px;border-radius:50%;background:${dColor};display:inline-block;flex-shrink:0"></span>${r.give_room} ¬∑ ${r.give_shift_time} ¬∑ ${mon}</div></div>
      <div class="sc-section-label">Would accept in return</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">${wantedHTML}</div>
      ${r.note?`<div class="sc-note">üí¨ &nbsp;${r.note}</div>`:''}`;
  } else {
    const vMon=new Date(r.volunteer_shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const vColor=deptColor(r.volunteer_department);
    const tradeStyle=r.status==='approved'?'background:rgba(63,185,80,0.04);border:1px solid rgba(63,185,80,0.12);':'';
    bodyHTML=`
      <div class="trade-grid" style="${tradeStyle}">
        <div>
          <div class="trade-label">${r.requester_name} gives up</div>
          <div class="sc-shift-badge" style="font-size:11px"><span style="width:6px;height:6px;border-radius:50%;background:${dColor};display:inline-block;flex-shrink:0"></span>${r.give_room} ¬∑ ${r.give_shift_time}<br><span style="color:var(--text2);font-size:10px;font-weight:400">${mon}</span></div>
        </div>
        <div class="trade-arrow" style="${r.status==='approved'?'color:var(--success)':''}">‚áÑ</div>
        <div>
          <div class="trade-label">${r.volunteer_name} gives up</div>
          <div class="sc-shift-badge" style="font-size:11px"><span style="width:6px;height:6px;border-radius:50%;background:${vColor};display:inline-block;flex-shrink:0"></span>${r.volunteer_room} ¬∑ ${r.volunteer_shift_time}<br><span style="color:var(--text2);font-size:10px;font-weight:400">${vMon}</span></div>
        </div>
      </div>
      ${r.note?`<div class="sc-note" style="margin-top:10px">üí¨ &nbsp;${r.note}</div>`:''}`;
  }

  const footerHTML=r.status==='open'
    ?`<div class="sc-footer-info">No one has offered yet</div><button class="btn btn-p" style="padding:6px 14px;font-size:12px;border-radius:8px" onclick="openOfferModal('${r.id}')">üîÑ I Can Swap</button>`
    :r.status==='pending'
    ?`<div class="sc-footer-info">Both sides agreed &nbsp;¬∑&nbsp; <span style="color:#f59e0b">Waiting for admin approval</span></div>`
    :r.status==='approved'
    ?`<div class="sc-footer-info" style="color:var(--success)">‚úì Schedule updated automatically</div>`
    :`<div class="sc-footer-info" style="color:var(--danger)">‚úï Request denied by admin${r.admin_note?` ‚Äî ${r.admin_note}`:''}</div>`;

  return `<div class="swap-card s-${r.status}" data-id="${r.id}">
    <div class="sc-top">
      <div class="sc-avatar">${initials}</div>
      <div class="sc-who"><div class="sc-name">${r.requester_name}</div><div class="sc-time">${timeAgo(r.created_at)}</div></div>
      <span class="sc-pill ${pillClass}">${pillLabel}</span>
    </div>
    <div class="sc-body">${bodyHTML}</div>
    <div class="sc-footer">${footerHTML}</div>
  </div>`;
}

// ‚îÄ‚îÄ REQUEST MODAL ‚îÄ‚îÄ
function openSwapModal(){
  swapModalStep=1; swapWanted=[];
  // Populate staff dropdown
  const sel=document.getElementById('sw-who');
  sel.innerHTML='<option value="">Select your name‚Ä¶</option>'+STAFF.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
  // Populate weeks dropdown ‚Äî only published weeks
  const mondays=[...new Set(SCHEDULE.map(s=>{
    const d=new Date(s.shift_date+'T12:00:00');
    const diff=(d.getDay()+6)%7;
    const mon=new Date(d);mon.setDate(d.getDate()-diff);
    return mon.toISOString().split('T')[0];
  }))].sort().reverse();
  const wSel=document.getElementById('sw-week');
  wSel.innerHTML='<option value="">Select a week‚Ä¶</option>'+mondays.map(m=>{
    const fri=new Date(m+'T12:00:00');fri.setDate(fri.getDate()+4);
    return `<option value="${m}">${new Date(m+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${fri.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</option>`;
  }).join('');
  document.getElementById('swap-modal').classList.add('open');
  renderSwapModalStep();
}

function closeSwapModal(){
  document.getElementById('swap-modal').classList.remove('open');
  swapWanted=[]; swapModalStep=1;
}

function renderSwapModalStep(){
  document.getElementById('swap-step-1').style.display=swapModalStep===1?'block':'none';
  document.getElementById('swap-step-2').style.display=swapModalStep===2?'block':'none';
  document.getElementById('sw-modal-back').style.display=swapModalStep>1?'inline-flex':'none';
  document.getElementById('sw-modal-next').textContent=swapModalStep===2?'üì® Post Request':'Next ‚Üí';
  const dots=document.querySelectorAll('.swap-dot');
  dots.forEach((d,i)=>{d.className='swap-dot'+(i+1<swapModalStep?' done':i+1===swapModalStep?' active':'');});
}

function onSwapWhoChange(){ checkSwapStep1(); }
function onSwapWeekChange(){
  const who=document.getElementById('sw-who').value;
  const week=document.getElementById('sw-week').value;
  const giveSel=document.getElementById('sw-give');
  if(who&&week){
    const weekDates=getWeekDays(week);
    const myShifts=SCHEDULE.filter(s=>s.assigned_tech===who&&weekDates.includes(s.shift_date));
    giveSel.innerHTML='<option value="">Select a shift‚Ä¶</option>'+myShifts.map(s=>{
      const day=new Date(s.shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      return `<option value="${s.id}|${s.room}|${s.shift_time}|${s.department}|${s.shift_date}">${s.room} ¬∑ ${s.shift_time} ¬∑ ${day}</option>`;
    }).join('');
  }
  checkSwapStep1();
}

function checkSwapStep1(){
  const ok=document.getElementById('sw-who').value&&document.getElementById('sw-week').value&&document.getElementById('sw-give').value;
  document.getElementById('sw-modal-next').disabled=!ok;
}

function swapModalNext(){
  if(swapModalStep===1){
    // Build the "wanted shifts" dropdown ‚Äî shifts that week the requester is qualified for but NOT assigned to
    const who=document.getElementById('sw-who').value;
    const week=document.getElementById('sw-week').value;
    const giveVal=document.getElementById('sw-give').value;
    const [giveId,giveRoom,giveShift,giveDept,giveDate]=giveVal.split('|');
    document.getElementById('sw-give-summary').textContent=`${giveRoom} ¬∑ ${giveShift} ¬∑ ${new Date(giveDate+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}`;
    const weekDates=getWeekDays(week);
    const staff=STAFF.find(s=>s.name===who);
    const quals=staff?.qualifications||[];
    // All shifts that week in depts they're qualified for, excluding their own
    const eligible=SCHEDULE.filter(s=>
      weekDates.includes(s.shift_date)&&
      s.assigned_tech!==who&&
      s.assigned_tech&&
      (quals.includes(s.department)||s.department==='Support')&&
      s.shift_date+s.room+s.shift_time!==giveDate+giveRoom+giveShift
    );
    const wSel=document.getElementById('sw-want-sel');
    wSel.innerHTML='<option value="">Add a shift‚Ä¶</option>'+eligible.map(s=>{
      const day=new Date(s.shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      return `<option value="${s.shift_date}|${s.room}|${s.shift_time}|${s.department}">${s.room} ¬∑ ${s.shift_time} ¬∑ ${day}</option>`;
    }).join('');
    swapWanted=[]; renderSwapWantTags();
    swapModalStep=2; renderSwapModalStep();
    document.getElementById('sw-modal-next').disabled=true;
  } else {
    postSwapRequest();
  }
}

function swapModalBack(){
  swapModalStep--; renderSwapModalStep();
  document.getElementById('sw-modal-next').disabled=!document.getElementById('sw-give').value;
}

function addSwapWant(sel){
  if(!sel.value||swapWanted.length>=3){sel.value='';return;}
  if(swapWanted.find(w=>w.val===sel.value)){sel.value='';return;}
  swapWanted.push({val:sel.value});
  // disable this option
  Array.from(sel.options).forEach(o=>{if(o.value===sel.value)o.disabled=true;});
  sel.value='';
  if(swapWanted.length>=3) sel.disabled=true;
  renderSwapWantTags();
  document.getElementById('sw-modal-next').disabled=swapWanted.length===0;
}

function removeSwapWant(val){
  swapWanted=swapWanted.filter(w=>w.val!==val);
  const sel=document.getElementById('sw-want-sel');
  sel.disabled=false;
  Array.from(sel.options).forEach(o=>{if(o.value===val)o.disabled=false;});
  renderSwapWantTags();
  document.getElementById('sw-modal-next').disabled=swapWanted.length===0;
}

function renderSwapWantTags(){
  document.getElementById('sw-want-count').textContent=`${swapWanted.length} / 3`;
  document.getElementById('sw-want-tags').innerHTML=swapWanted.map(w=>{
    const parts=w.val.split('|');
    const label=`${parts[1]} ¬∑ ${parts[2]} ¬∑ ${new Date(parts[0]+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}`;
    return `<div class="want-tag">${label}<button class="want-tag-x" onclick="removeSwapWant('${w.val.replace(/'/g,"\'")}')">‚úï</button></div>`;
  }).join('');
}

async function postSwapRequest(){
  const giveVal=document.getElementById('sw-give').value.split('|');
  const wanted=swapWanted.map(w=>{const p=w.val.split('|');return{shift_date:p[0],room:p[1],shift_time:p[2],department:p[3]};});
  const {error}=await sb.from('shift_swap_requests').insert({
    requester_name:document.getElementById('sw-who').value,
    give_shift_date:giveVal[4], give_room:giveVal[1], give_shift_time:giveVal[2], give_department:giveVal[3],
    wanted_shifts:wanted,
    note:document.getElementById('sw-note').value||null,
    status:'open'
  });
  if(error){toast('Failed to post request: '+error.message,'err');return;}
  closeSwapModal();
  toast('‚úì Swap request posted to the board!','ok');
  await loadSwaps();
}

// ‚îÄ‚îÄ OFFER MODAL ‚îÄ‚îÄ
function openOfferModal(requestId){
  activeRequestId=requestId;
  const req=SWAPS.find(s=>s.id===requestId);
  if(!req) return;
  const day=new Date(req.give_shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
  document.getElementById('offer-request-summary').innerHTML=`
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);letter-spacing:0.07em;margin-bottom:6px">${req.requester_name} wants to swap out of</div>
    <div style="font-weight:600;margin-bottom:8px">${req.give_room} ¬∑ ${req.give_shift_time} ¬∑ ${day}</div>
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text3);letter-spacing:0.07em;margin-bottom:5px">Would accept in return</div>
    <div style="display:flex;flex-wrap:wrap;gap:5px">${(req.wanted_shifts||[]).map(w=>`<span style="background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.2);border-radius:6px;padding:3px 8px;font-size:11px;font-weight:600">${w.room} ¬∑ ${w.shift_time}</span>`).join('')}</div>`;
  // Populate who-are-you ‚Äî only techs qualified for requester's dept
  const offSel=document.getElementById('off-who');
  const qualifiedTechs=STAFF.filter(s=>s.name!==req.requester_name&&s.qualifications?.includes(req.give_department));
  offSel.innerHTML='<option value="">Select your name‚Ä¶</option>'+qualifiedTechs.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
  document.getElementById('off-shift').innerHTML='<option value="">Select your name first‚Ä¶</option>';
  document.getElementById('off-submit').disabled=true;
  document.getElementById('offer-qual-warn').style.display='none';
  document.getElementById('offer-modal').classList.add('open');
}

function closeOfferModal(){ document.getElementById('offer-modal').classList.remove('open'); activeRequestId=null; }

function onOfferWhoChange(){
  const req=SWAPS.find(s=>s.id===activeRequestId);
  if(!req) return;
  const who=document.getElementById('off-who').value;
  if(!who){document.getElementById('off-shift').innerHTML='<option>Select your name first‚Ä¶</option>';return;}
  // Get their shifts during that week that the requester is qualified for
  const requesterStaff=STAFF.find(s=>s.name===req.requester_name);
  const requesterQuals=requesterStaff?.qualifications||[];
  const mon=new Date(req.give_shift_date+'T12:00:00');
  const diff=(mon.getDay()+6)%7; mon.setDate(mon.getDate()-diff);
  const weekDates=getWeekDays(mon.toISOString().split('T')[0]);
  const myShifts=SCHEDULE.filter(s=>s.assigned_tech===who&&weekDates.includes(s.shift_date)&&
    (requesterQuals.includes(s.department)||s.department==='Support'));
  const shiftSel=document.getElementById('off-shift');
  if(!myShifts.length){
    shiftSel.innerHTML='<option>No qualifying shifts this week</option>';
    document.getElementById('offer-qual-warn').style.display='block';
    document.getElementById('offer-qual-warn').textContent=`You don't have any shifts ${req.requester_name} is qualified to take this week.`;
    document.getElementById('off-submit').disabled=true;
    return;
  }
  document.getElementById('offer-qual-warn').style.display='none';
  shiftSel.innerHTML='<option value="">Select a shift‚Ä¶</option>'+myShifts.map(s=>{
    const day=new Date(s.shift_date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    return `<option value="${s.shift_date}|${s.room}|${s.shift_time}|${s.department}">${s.room} ¬∑ ${s.shift_time} ¬∑ ${day}</option>`;
  }).join('');
  checkOfferReady();
}

function checkOfferReady(){
  document.getElementById('off-submit').disabled=!document.getElementById('off-shift').value||!document.getElementById('off-who').value;
}

async function submitOffer(){
  const req=SWAPS.find(s=>s.id===activeRequestId);
  if(!req) return;
  const who=document.getElementById('off-who').value;
  const shiftVal=document.getElementById('off-shift').value.split('|');
  const {error}=await sb.from('shift_swap_requests').update({
    volunteer_name:who,
    volunteer_shift_date:shiftVal[0], volunteer_room:shiftVal[1],
    volunteer_shift_time:shiftVal[2], volunteer_department:shiftVal[3],
    status:'pending'
  }).eq('id',activeRequestId);
  if(error){toast('Failed to submit offer: '+error.message,'err');return;}
  closeOfferModal();
  toast('‚úì Offer submitted ‚Äî waiting for admin approval','ok');
  await loadSwaps();
}

// Helper
function getWeekDays(monday){
  const days=[];
  const start=new Date(monday+'T12:00:00');
  for(let i=0;i<5;i++){const d=new Date(start);d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
  return days;
}

// swaps load handled in goTo below

</script>

  <div style="text-align:center;padding:18px;font-size:11px;color:var(--text3);border-top:1px solid var(--border);margin-top:32px">
    ¬© 2026 NucMed Scheduler ¬∑ Thomas ModicaAmore ¬∑ All Rights Reserved
  </div>
</body>
</html>
